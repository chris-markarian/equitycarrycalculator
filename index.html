<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate Underwriting Calculator</title>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        :root {
            --bg-primary: #0a0f1a;
            --bg-secondary: #111827;
            --bg-card: #1a2234;
            --bg-input: #0d1421;
            --accent-teal: #14b8a6;
            --accent-teal-dim: #0d9488;
            --accent-amber: #f59e0b;
            --accent-red: #ef4444;
            --accent-green: #22c55e;
            --accent-blue: #3b82f6;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #2d3a4f;
            --input-border: #3d4f6a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.5;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 2rem;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-teal), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .info-bar {
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .info-row-full {
            width: 100%;
        }

        .info-row-full .info-section {
            width: 100%;
        }

        /* Sticky Dashboard Bar */
        .sticky-dashboard {
            position: sticky;
            top: 0;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .dashboard-metric {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 100px;
        }

        .dashboard-label {
            font-size: 0.7rem;
            color: #94a3b8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .dashboard-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #14b8a6;
        }

        .dashboard-value.negative {
            color: #f87171;
        }

        .dashboard-value.positive {
            color: #4ade80;
        }

        @media (max-width: 900px) {
            .sticky-dashboard {
                justify-content: center;
                padding: 0.75rem 1rem;
            }
            
            .dashboard-metric {
                min-width: 80px;
            }
            
            .dashboard-value {
                font-size: 1rem;
            }
        }

        @media (max-width: 600px) {
            .sticky-dashboard {
                position: relative;
                top: auto;
            }
        }

        @media (max-width: 900px) {
            .info-bar {
                gap: 1rem;
            }
        }

        .info-section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--input-border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: 'DM Sans', sans-serif;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .info-input:focus {
            outline: none;
            border-color: var(--accent-teal);
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.15);
        }

        .info-input::placeholder {
            color: var(--text-muted);
        }

        .info-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }

        @media (max-width: 700px) {
            .info-row {
                grid-template-columns: 1fr;
            }
        }

        /* Market Analysis Styles */
        .market-analysis-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .market-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .market-header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .generate-prompt-btn {
            background: linear-gradient(135deg, var(--accent-teal), var(--accent-blue));
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .generate-prompt-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(20, 184, 166, 0.4);
        }

        .prompt-section {
            margin-top: 0.5rem;
        }

        .prompt-instructions {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .prompt-output-container {
            margin-top: 1rem;
        }

        .prompt-output {
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1.25rem;
            font-family: 'Space Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.6;
            color: var(--text-secondary);
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .prompt-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .copy-btn {
            background: var(--accent-teal);
            border: none;
            color: white;
            padding: 0.6rem 1.25rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .copy-btn:hover {
            background: var(--accent-teal-dim);
        }

        .copy-btn.copied {
            background: var(--accent-green);
        }

        .prompt-tip {
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid var(--accent-blue);
            border-radius: 8px;
            font-size: 0.85rem;
            color: var(--accent-blue);
        }

        .main-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
        }

        @media (max-width: 1400px) {
            .main-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 900px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .icon-teal { background: rgba(20, 184, 166, 0.15); color: var(--accent-teal); }
        .icon-amber { background: rgba(245, 158, 11, 0.15); color: var(--accent-amber); }
        .icon-blue { background: rgba(59, 130, 246, 0.15); color: var(--accent-blue); }
        .icon-green { background: rgba(34, 197, 94, 0.15); color: var(--accent-green); }
        .icon-red { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 0.4rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input, select {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--input-border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: 'Space Mono', monospace;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-teal);
            box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.15);
        }

        input.input-highlight {
            border-color: var(--accent-teal);
            background: rgba(20, 184, 166, 0.05);
        }

        input.input-target {
            border-color: #f59e0b !important;
            background: rgba(245, 158, 11, 0.1) !important;
        }

        input.input-target::placeholder {
            color: #9ca3af;
            font-style: italic;
        }

        /* Needs Review Styling */
        input.needs-review {
            border-color: var(--accent-amber) !important;
            background: rgba(245, 158, 11, 0.08) !important;
            animation: subtle-pulse 2s ease-in-out infinite;
        }

        input.needs-review:focus {
            border-color: var(--accent-teal) !important;
            background: var(--bg-input) !important;
            animation: none;
        }

        @keyframes subtle-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0); }
            50% { box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.15); }
        }

        /* Card completion indicator */
        .card-status {
            margin-left: auto;
            font-size: 0.75rem;
            font-weight: 500;
            padding: 0.25rem 0.6rem;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .card-status.complete {
            background: rgba(34, 197, 94, 0.15);
            color: var(--accent-green);
        }

        .card-status.needs-review {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-amber);
        }

        .card-status-icon {
            font-size: 0.85rem;
        }

        select {
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25rem;
            padding-right: 2.5rem;
        }

        .input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .result-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }

        .result-item {
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 10px;
            border: 1px solid var(--border-color);
        }

        .result-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.25rem;
        }

        .result-value {
            font-family: 'Space Mono', monospace;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .result-value.positive { color: var(--accent-green); }
        .result-value.negative { color: var(--accent-red); }
        .result-value.highlight { color: var(--accent-teal); }
        .result-value.amber { color: var(--accent-amber); }

        .result-item.full-width {
            grid-column: span 2;
        }

        .section-divider {
            height: 1px;
            background: var(--border-color);
            margin: 1.25rem 0;
        }

        .mini-label {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .summary-card {
            grid-column: span 1;
        }

        .summary-card .result-grid {
            grid-template-columns: 1fr;
        }

        .loi-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0.5rem;
        }

        .loi-table td {
            padding: 0.6rem 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        .loi-table td:first-child {
            color: var(--text-secondary);
        }

        .loi-table td:last-child {
            text-align: right;
            font-family: 'Space Mono', monospace;
            font-weight: 600;
            color: var(--text-primary);
        }

        .loi-table tr:last-child td {
            border-bottom: none;
        }

        .spread-indicator {
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .spread-indicator.positive {
            background: rgba(34, 197, 94, 0.15);
            color: var(--accent-green);
            border: 1px solid var(--accent-green);
        }

        .spread-indicator.negative {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
            border: 1px solid var(--accent-red);
        }

        .spread-indicator.neutral {
            background: rgba(245, 158, 11, 0.15);
            color: var(--accent-amber);
            border: 1px solid var(--accent-amber);
        }

        .spread-icon {
            font-size: 1rem;
        }

        .cash-breakdown {
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.1), rgba(59, 130, 246, 0.1));
            border: 1px solid var(--accent-teal);
            padding: 1.25rem;
            border-radius: 12px;
            margin-top: 1rem;
        }

        .cash-breakdown-title {
            font-size: 0.8rem;
            color: var(--accent-teal);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .expense-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.9rem;
        }

        .expense-row:not(:last-child) {
            border-bottom: 1px dashed var(--border-color);
        }

        .expense-label {
            color: var(--text-secondary);
        }

        .expense-value {
            font-family: 'Space Mono', monospace;
            color: var(--text-primary);
        }

        .total-row {
            margin-top: 0.5rem;
            padding-top: 0.75rem;
            border-top: 2px solid var(--accent-teal);
            font-weight: 700;
        }

        .total-row .expense-value {
            color: var(--accent-teal);
            font-size: 1.1rem;
        }

        .helper-text {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .equity-warning {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid var(--accent-amber);
            border-radius: 8px;
            padding: 0.6rem 0.9rem;
            margin: 0.75rem 0;
        }

        .equity-warning.error {
            background: rgba(239, 68, 68, 0.15);
            border-color: var(--accent-red);
        }

        .equity-warning .warning-icon {
            font-size: 1rem;
        }

        .equity-warning .warning-text {
            font-size: 0.85rem;
            color: var(--accent-amber);
        }

        .equity-warning.error .warning-text {
            color: var(--accent-red);
        }

        .equity-good {
            color: var(--accent-green) !important;
        }

        .equity-low {
            color: var(--accent-amber) !important;
        }

        .equity-bad {
            color: var(--accent-red) !important;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-success { background: rgba(34, 197, 94, 0.15); color: var(--accent-green); }
        .badge-warning { background: rgba(245, 158, 11, 0.15); color: var(--accent-amber); }
        .badge-danger { background: rgba(239, 68, 68, 0.15); color: var(--accent-red); }

        .percentage-inputs {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .percentage-inputs .form-group {
            margin-bottom: 0.5rem;
        }

        .card.wide {
            grid-column: span 2;
        }

        @media (max-width: 900px) {
            .card.wide {
                grid-column: span 1;
            }
        }

        footer {
            text-align: center;
            padding: 2rem;
            margin-top: 3rem;
            border-top: 1px solid var(--border-color);
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .print-btn {
            background: linear-gradient(135deg, var(--accent-teal), var(--accent-blue));
            color: white;
            border: none;
            padding: 1rem 1.5rem;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 20px rgba(20, 184, 166, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            text-decoration: none;
        }

        .print-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(20, 184, 166, 0.5);
        }

        .loi-btn {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
            padding: 1rem 1.5rem;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 20px rgba(245, 158, 11, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            text-decoration: none;
        }

        .loi-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(245, 158, 11, 0.5);
        }

        .library-btn {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            border: none;
            padding: 1rem 1.5rem;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
            transition: transform 0.2s, box-shadow 0.2s;
            text-decoration: none;
        }

        .library-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(34, 197, 94, 0.5);
        }

        /* Deal Library Panel */
        .deal-library {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .library-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .library-header h3 {
            margin: 0;
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        .library-actions {
            display: flex;
            gap: 0.5rem;
        }

        .library-close-btn {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .library-close-btn:hover {
            background: var(--bg-tertiary);
        }

        .library-list {
            max-height: 500px;
            min-height: 200px;
            overflow-y: auto;
        }

        .library-empty {
            color: var(--text-secondary);
            text-align: center;
            padding: 2rem;
            font-style: italic;
        }

        /* Library Table Styles */
        .library-table {
            width: 100%;
            border-collapse: collapse;
        }

        .library-table-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 150px;
            gap: 1rem;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-radius: 8px 8px 0 0;
            border-bottom: 1px solid var(--border-color);
        }

        .library-table-header span {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .library-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 150px;
            gap: 1rem;
            align-items: center;
            padding: 0.875rem 1rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            transition: background 0.2s;
        }

        .library-item:last-child {
            border-radius: 0 0 8px 8px;
            border-bottom: none;
        }

        .library-item:hover {
            background: rgba(20, 184, 166, 0.1);
        }

        .library-item-address {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .library-item-address:hover {
            color: var(--accent-teal);
        }

        .library-item-date {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .library-item-seller {
            font-size: 0.85rem;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .library-item-status {
            cursor: pointer;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.3rem 0.6rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            transition: transform 0.15s;
        }

        .status-badge:hover {
            transform: scale(1.05);
        }

        .status-working {
            background: rgba(148, 163, 184, 0.2);
            color: #94a3b8;
        }

        .status-loi-sent {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .status-loi-countered {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }

        .status-loi-signed {
            background: rgba(74, 222, 128, 0.2);
            color: #4ade80;
        }

        .status-won {
            background: rgba(34, 197, 94, 0.25);
            color: #22c55e;
        }

        .status-rejected {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .status-obe {
            background: rgba(139, 92, 246, 0.2);
            color: #8b5cf6;
        }

        .library-item-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .library-item-share {
            background: transparent;
            color: var(--accent-blue);
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .library-item-share:hover {
            opacity: 1;
        }

        .library-item-rename {
            background: transparent;
            color: var(--accent-amber);
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .library-item-rename:hover {
            opacity: 1;
        }

        .library-item-delete {
            background: transparent;
            color: #f87171;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            opacity: 0.6;
            transition: opacity 0.2s;
        }

        .library-item-delete:hover {
            opacity: 1;
        }

        /* Responsive: Stack on mobile */
        @media (max-width: 768px) {
            .library-table-header {
                display: none;
            }
            
            .library-item {
                grid-template-columns: 1fr;
                gap: 0.5rem;
                padding: 1rem;
            }
            
            .library-item-address {
                white-space: normal;
            }
            
            .library-item-date::before {
                content: 'Date: ';
                color: var(--text-muted);
            }
            
            .library-item-seller::before {
                content: 'Seller: ';
                color: var(--text-muted);
            }
            
            .library-item-status::before {
                content: 'Status: ';
                color: var(--text-muted);
                font-weight: normal;
            }
            
            .library-item-actions {
                justify-content: flex-start;
                padding-top: 0.5rem;
                border-top: 1px solid var(--border-color);
                margin-top: 0.5rem;
            }
        }

        .library-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .library-search {
            flex: 1;
            min-width: 200px;
        }

        .library-search input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.875rem;
        }

        .library-search input::placeholder {
            color: var(--text-secondary);
        }

        .library-sort {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .library-sort label {
            color: var(--text-secondary);
            font-size: 0.875rem;
            white-space: nowrap;
        }

        .library-sort select {
            padding: 0.75rem 2rem 0.75rem 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
        }

        .library-sort select option {
            background: #1e293b;
            color: #f1f5f9;
        }

        .library-stats {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .export-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin: 2rem 0;
            flex-wrap: wrap;
        }

        /* Goal Finder Styles */
        .goal-finder {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 2rem;
        }

        .goal-finder-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .goal-finder-header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .goal-finder-header h2 {
            margin: 0;
            font-size: 1.25rem;
        }

        .goal-finder-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .goal-input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .goal-input-group label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .goal-input-group input[type="number"] {
            background: var(--bg-input);
            border: 1px solid var(--input-border);
            border-radius: 8px;
            padding: 0.625rem 0.875rem;
            color: var(--text-primary);
            font-size: 0.95rem;
            width: 100%;
        }

        .goal-input-group input:focus {
            outline: none;
            border-color: var(--accent-teal);
        }

        .goal-variables {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .goal-variables-title {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.75rem;
        }

        .goal-variable-row {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .goal-variable-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .goal-variable-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-teal);
            cursor: pointer;
        }

        .goal-variable-item label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            cursor: pointer;
            white-space: nowrap;
        }

        .goal-variable-item label:hover {
            color: var(--text-primary);
        }

        .goal-variable-options {
            display: flex;
            gap: 2rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
        }

        .goal-option {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .goal-option label {
            font-size: 0.8rem;
            color: var(--text-muted);
            white-space: nowrap;
        }

        .goal-option-input {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            background: var(--bg-input);
            border: 1px solid var(--input-border);
            border-radius: 6px;
            padding: 0.4rem 0.6rem;
        }

        .goal-option-input span {
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        .goal-option-input input {
            width: 80px;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 0.85rem;
            padding: 0;
        }

        .goal-option-input input:focus {
            outline: none;
        }

        .goal-actions {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .goal-find-btn {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
            border: none;
            padding: 0.875rem 1.5rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .goal-find-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(245, 158, 11, 0.4);
        }

        .goal-find-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .goal-results {
            margin-top: 1.5rem;
            padding: 1.25rem;
            border-radius: 12px;
            display: none;
        }

        .goal-results.show {
            display: block;
        }

        .goal-results.success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid var(--accent-green);
        }

        .goal-results.failure {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--accent-red);
        }

        .goal-results.partial {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid var(--accent-amber);
        }

        .goal-results-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        .goal-results.success .goal-results-header {
            color: var(--accent-green);
        }

        .goal-results.failure .goal-results-header {
            color: var(--accent-red);
        }

        .goal-results.partial .goal-results-header {
            color: var(--accent-amber);
        }

        .goal-results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .goal-result-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .goal-result-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .goal-result-value {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .goal-result-value.changed {
            color: var(--accent-amber);
        }

        .goal-result-note {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 0.15rem;
        }

        .goal-metric-target {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-left: 0.25rem;
        }

        .goal-metrics-achieved {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .goal-metric-badge {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.8rem;
            padding: 0.35rem 0.65rem;
            border-radius: 20px;
            background: var(--bg-tertiary);
        }

        .goal-metric-badge.met {
            background: rgba(34, 197, 94, 0.15);
            color: var(--accent-green);
        }

        .goal-metric-badge.unmet {
            background: rgba(239, 68, 68, 0.15);
            color: var(--accent-red);
        }

        .goal-apply-btn {
            background: linear-gradient(135deg, var(--accent-green), #16a34a);
            color: white;
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: transform 0.2s;
        }

        .goal-apply-btn:hover {
            transform: translateY(-1px);
        }

        /* Auth Modal Styles */
        .auth-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .auth-modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 2rem;
            width: 100%;
            max-width: 400px;
            margin: 1rem;
        }

        .auth-modal h2 {
            text-align: center;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .auth-modal .subtitle {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }

        .auth-form .form-group {
            margin-bottom: 1rem;
        }

        .auth-form label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .auth-form input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--input-border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            letter-spacing: 0.01em;
        }

        .auth-form input::placeholder {
            color: var(--text-muted);
            font-weight: 400;
        }

        .auth-form input:focus {
            outline: none;
            border-color: var(--accent-teal);
        }

        .auth-btn {
            width: 100%;
            padding: 0.875rem;
            background: linear-gradient(135deg, var(--accent-teal), var(--accent-blue));
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .auth-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(20, 184, 166, 0.4);
        }

        .auth-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .auth-toggle {
            text-align: center;
            margin-top: 1rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .auth-toggle a {
            color: var(--accent-teal);
            cursor: pointer;
            text-decoration: none;
        }

        .auth-toggle a:hover {
            text-decoration: underline;
        }

        .auth-error {
            background: rgba(239, 68, 68, 0.15);
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-bottom: 1rem;
            display: none;
        }

        .auth-error.show {
            display: block;
        }

        /* User Profile Indicator */
        .user-indicator {
            position: fixed;
            top: 1rem;
            right: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 50px;
            padding: 0.5rem 1rem;
            z-index: 100;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-teal), var(--accent-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.85rem;
            color: white;
        }

        .user-email {
            color: var(--text-secondary);
            font-size: 0.85rem;
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .logout-btn {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.35rem 0.75rem;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(239, 68, 68, 0.15);
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        /* Address Collision Warning */
        .collision-warning {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid var(--accent-amber);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-top: 0.5rem;
            display: none;
        }

        .collision-warning.show {
            display: block;
        }

        .collision-warning-title {
            color: var(--accent-amber);
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .collision-warning-detail {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        /* Sync Status Indicator */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-left: auto;
        }

        .sync-status.syncing {
            color: var(--accent-amber);
        }

        .sync-status.synced {
            color: var(--accent-green);
        }

        .sync-status.error {
            color: var(--accent-red);
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .sync-status.syncing .sync-dot {
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        @media (max-width: 600px) {
            .user-indicator {
                top: auto;
                bottom: 1rem;
                right: 1rem;
                left: 1rem;
                justify-content: center;
            }
            
            .user-email {
                display: none;
            }
        }

        /* Share Modal Styles */
        .share-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1001;
        }

        .share-modal-overlay.show {
            display: flex;
        }

        .share-modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            width: 100%;
            max-width: 500px;
            margin: 1rem;
        }

        .share-modal h3 {
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .share-modal .subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1.25rem;
        }

        .share-link-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .share-link-input {
            flex: 1;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--input-border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: monospace;
        }

        .share-copy-btn {
            background: linear-gradient(135deg, var(--accent-teal), var(--accent-blue));
            border: none;
            border-radius: 8px;
            color: white;
            padding: 0.75rem 1rem;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .share-copy-btn:hover {
            transform: translateY(-1px);
        }

        .share-copy-btn.copied {
            background: linear-gradient(135deg, var(--accent-green), #16a34a);
        }

        .share-note {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid var(--accent-blue);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .share-note strong {
            color: var(--accent-blue);
        }

        .share-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        .share-revoke-btn {
            background: transparent;
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .share-revoke-btn:hover {
            background: rgba(239, 68, 68, 0.15);
        }

        .share-close-btn {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem 1.5rem;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .share-close-btn:hover {
            background: var(--bg-secondary);
        }

        /* Save Choice Modal */
        .save-choice-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1002;
        }

        .save-choice-modal-overlay.show {
            display: flex;
        }

        .save-choice-modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            width: 100%;
            max-width: 400px;
            margin: 1rem;
            text-align: center;
        }

        .save-choice-modal h3 {
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
        }

        .save-choice-modal .subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }

        .save-choice-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .save-choice-btn {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1.25rem 1rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: white;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .save-choice-btn:hover {
            transform: translateY(-2px);
        }

        .save-choice-btn.overwrite {
            background: linear-gradient(135deg, var(--accent-teal), #0d9488);
            box-shadow: 0 4px 15px rgba(20, 184, 166, 0.3);
        }

        .save-choice-btn.overwrite:hover {
            box-shadow: 0 6px 20px rgba(20, 184, 166, 0.4);
        }

        .save-choice-btn.copy {
            background: linear-gradient(135deg, var(--accent-blue), #4f46e5);
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }

        .save-choice-btn.copy:hover {
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        .save-choice-btn span:first-child {
            font-size: 1.5rem;
        }

        .save-choice-btn .btn-hint {
            font-size: 0.75rem;
            font-weight: 400;
            opacity: 0.85;
        }

        .save-choice-cancel {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.75rem 2rem;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .save-choice-cancel:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        /* Copy Name Input */
        .copy-name-input-container {
            margin-bottom: 0.75rem;
        }

        .copy-name-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: var(--bg-input);
            border: 1px solid var(--input-border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        .copy-name-input:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .copy-name-input::placeholder {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        #copyNamePreview {
            font-family: monospace;
            background: var(--bg-tertiary);
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            font-size: 0.85rem;
            word-break: break-all;
        }

        .copy-name-hint {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
        }

        .copy-name-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
            align-items: center;
        }

        /* Email Offer Modal */
        .email-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1002;
        }

        .email-modal-overlay.show {
            display: flex;
        }

        .email-modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            width: 100%;
            max-width: 420px;
            margin: 1rem;
        }

        .email-modal h3 {
            margin: 0 0 0.5rem 0;
            color: var(--text-primary);
            text-align: center;
        }

        .email-modal .subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1.25rem;
            text-align: center;
        }

        .email-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .email-field label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.4rem;
        }

        .email-field input {
            width: 100%;
            padding: 0.7rem 0.9rem;
            background: var(--bg-input);
            border: 1px solid var(--input-border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .email-field input:focus {
            outline: none;
            border-color: var(--accent-teal);
        }

        .email-preview {
            background: rgba(20, 184, 166, 0.1);
            border: 1px solid rgba(20, 184, 166, 0.2);
            border-radius: 8px;
            padding: 0.75rem 1rem;
            margin-bottom: 1rem;
        }

        .email-preview-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .email-preview-items {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            font-size: 0.85rem;
            color: var(--accent-teal);
        }

        .email-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .email-status.sending {
            background: rgba(59, 130, 246, 0.1);
            color: var(--accent-blue);
        }

        .email-status.success {
            background: rgba(34, 197, 94, 0.1);
            color: var(--accent-green);
        }

        .email-status.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--accent-red);
        }

        .email-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .email-send-btn {
            background: linear-gradient(135deg, var(--accent-teal), var(--accent-blue));
            border: none;
            border-radius: 8px;
            color: white;
            padding: 0.75rem 1.5rem;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: transform 0.2s, opacity 0.2s;
        }

        .email-send-btn:hover {
            transform: translateY(-1px);
        }

        .email-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .library-item-email {
            background: transparent;
            color: var(--accent-blue);
            border: 1px solid var(--accent-blue);
            padding: 0.4rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.35rem;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .library-item-email:hover {
            background: var(--accent-blue);
            color: white;
        }

        /* Rename Deal Modal */
        .rename-input-wrapper {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .rename-prefix {
            color: var(--text-muted);
            font-size: 1rem;
        }

        .rename-input {
            flex: 1;
        }

        /* Shared Deal Banner */
        .shared-deal-banner {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(20, 184, 166, 0.15));
            border: 1px solid var(--accent-blue);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            display: none;
        }

        .shared-deal-banner.show {
            display: block;
        }

        .shared-deal-banner h4 {
            margin: 0 0 0.5rem 0;
            color: var(--accent-blue);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .shared-deal-banner p {
            margin: 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .shared-deal-banner .save-shared-btn {
            background: linear-gradient(135deg, var(--accent-teal), var(--accent-blue));
            border: none;
            border-radius: 8px;
            color: white;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            margin-top: 0.75rem;
            transition: transform 0.2s;
        }

        .shared-deal-banner .save-shared-btn:hover {
            transform: translateY(-1px);
        }

        /* PDF Summary Styles */
        #pdf-summary {
            display: none;
        }

        @media print {
            body {
                background: white;
                margin: 0;
                padding: 0;
            }
            
            body > * {
                display: none !important;
            }
            
            #pdf-summary.printing {
                display: block !important;
                position: relative;
                width: 100%;
                background: white;
                color: #1a1a1a;
                padding: 20px 40px;
                font-family: 'DM Sans', Arial, sans-serif;
                margin: 0;
            }

            #loi-document.printing {
                display: block !important;
                position: relative;
                width: 100%;
                background: white;
                margin: 0;
            }

            .print-btn, .loi-btn {
                display: none !important;
            }

            .container, .main-grid, .card, header, footer, .info-bar, .market-analysis-section, .export-buttons, .sticky-dashboard {
                display: none !important;
            }

            .pdf-two-col {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
            }

            .pdf-section {
                page-break-inside: avoid;
                margin-bottom: 15px;
            }

            .pdf-highlight-box {
                page-break-inside: avoid;
            }

            .loi-signature-section {
                page-break-inside: avoid;
            }
        }

        #pdf-summary {
            background: white;
            color: #1a1a1a;
            padding: 40px;
            font-family: 'DM Sans', Arial, sans-serif;
        }

        .pdf-header {
            text-align: center;
            border-bottom: 3px solid #14b8a6;
            padding-bottom: 20px;
            margin-bottom: 30px;
        }

        .pdf-header h1 {
            font-size: 28px;
            color: #1a1a1a;
            margin-bottom: 5px;
            background: none;
            -webkit-text-fill-color: #1a1a1a;
        }

        .pdf-header .pdf-subtitle {
            color: #666;
            font-size: 14px;
        }

        .pdf-header .pdf-date {
            color: #888;
            font-size: 12px;
            margin-top: 10px;
        }

        .pdf-header .pdf-address {
            font-size: 18px;
            color: #333;
            font-weight: 600;
            margin-top: 8px;
        }

        .pdf-header .pdf-property-link {
            font-size: 11px;
            margin-top: 5px;
        }

        .pdf-header .pdf-property-link a {
            color: #14b8a6;
            text-decoration: none;
        }

        .pdf-preparer-box {
            background: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pdf-preparer-title {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .pdf-preparer-info {
            text-align: right;
        }

        .pdf-preparer-info span {
            display: block;
        }

        #pdf-preparer-name {
            font-weight: 600;
            color: #1a1a1a;
            font-size: 14px;
        }

        #pdf-preparer-contact {
            color: #666;
            font-size: 12px;
            margin-top: 3px;
        }

        .pdf-section {
            margin-bottom: 25px;
            page-break-inside: avoid;
        }

        .pdf-section-title {
            font-size: 16px;
            font-weight: 700;
            color: #14b8a6;
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 8px;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .pdf-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .pdf-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dotted #e0e0e0;
        }

        .pdf-row:last-child {
            border-bottom: none;
        }

        .pdf-label {
            color: #555;
            font-size: 13px;
        }

        .pdf-value {
            font-weight: 600;
            color: #1a1a1a;
            font-family: 'Space Mono', monospace;
            font-size: 13px;
        }

        .pdf-value.positive { color: #16a34a; }
        .pdf-value.negative { color: #dc2626; }
        .pdf-value.highlight { color: #0d9488; }

        .pdf-highlight-box {
            background: #f0fdfa;
            border: 2px solid #14b8a6;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            text-align: center;
        }

        .pdf-highlight-item h3 {
            font-size: 11px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .pdf-highlight-item .value {
            font-size: 20px;
            font-weight: 700;
            color: #0d9488;
            font-family: 'Space Mono', monospace;
        }

        .pdf-two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .pdf-footer {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
            text-align: center;
            color: #888;
            font-size: 11px;
        }

        /* LOI Document Styles */
        #loi-document {
            display: none;
            background: white;
            color: #1a1a1a;
            padding: 40px 50px;
            font-family: Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            max-width: 8.5in;
            margin: 0 auto;
        }

        .loi-date-header {
            margin-bottom: 20px;
            font-size: 11pt;
        }

        .loi-address-line {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .loi-property-link {
            font-size: 10pt;
            margin-bottom: 15px;
        }

        .loi-property-link a {
            color: #0066cc;
            text-decoration: none;
        }

        .loi-tracking {
            font-weight: normal;
        }

        .loi-re {
            margin-bottom: 20px;
        }

        .loi-greeting {
            margin-bottom: 20px;
        }

        .loi-body {
            text-align: justify;
        }

        .loi-body h3 {
            font-size: 11pt;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .loi-body p {
            margin-bottom: 12px;
        }

        .loi-body ul {
            margin-left: 20px;
            margin-bottom: 12px;
        }

        .loi-body li {
            margin-bottom: 6px;
        }

        .loi-steps-box {
            background: #f9f9f9;
            border: 1px solid #ddd;
            padding: 20px;
            margin: 20px 0;
        }

        .loi-steps-box h3 {
            margin-top: 15px;
            margin-bottom: 8px;
            font-size: 11pt;
        }

        .loi-steps-box h3:first-child {
            margin-top: 0;
        }

        .loi-steps-box ul {
            margin-left: 20px;
            margin-bottom: 0;
        }

        .loi-benefits li {
            list-style: none;
            margin-left: -20px;
        }

        .loi-docs-list li {
            margin-bottom: 10px;
        }

        .loi-signature-section {
            margin-top: 30px;
        }

        .loi-sig-left p {
            margin: 3px 0;
        }

        .loi-acceptance {
            margin-top: 40px;
        }

        .loi-signature-row {
            display: flex;
            align-items: flex-start;
            gap: 40px;
            margin-bottom: 20px;
        }

        .loi-sig-date {
            min-width: 120px;
        }

        .loi-sig-content {
            flex: 1;
        }

        .loi-sig-by {
            margin: 0 0 5px 0;
        }

        .loi-sig-label {
            margin: 0 0 3px 0;
            padding-left: 30px;
        }

        .loi-sig-detail {
            margin: 0 0 3px 0;
            padding-left: 30px;
            color: #333;
        }

        .loi-blank-line {
            display: inline-block;
            min-width: 120px;
        }

        .loi-accept-title {
            margin-top: 40px;
            margin-bottom: 20px;
        }

        .loi-footer-doc {
            margin-top: 40px;
            font-size: 9pt;
            color: #666;
        }

        .steven-signature {
            font-family: 'Brush Script MT', 'Segoe Script', 'Bradley Hand', cursive;
            font-size: 24pt;
            color: #1a1a1a;
            border-bottom: 1px solid #000;
            padding-bottom: 2px;
        }

        @media print {
            #loi-document.printing {
                display: block !important;
                padding: 0.5in 0.6in;
                font-size: 10pt;
                line-height: 1.4;
            }

            .loi-body p {
                margin-bottom: 10px;
            }

            .loi-body h3 {
                margin-top: 15px;
                margin-bottom: 8px;
            }

            .loi-steps-box {
                padding: 15px;
                margin: 15px 0;
            }

            .loi-signature-section {
                page-break-inside: avoid;
            }

            .loi-acceptance {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Modal -->
    <div class="auth-modal-overlay" id="authModal">
        <div class="auth-modal">
            <h2 id="authTitle">Welcome Back</h2>
            <p class="subtitle" id="authSubtitle">Sign in to sync your deals across devices</p>
            
            <div class="auth-error" id="authError"></div>
            
            <form class="auth-form" id="authForm" onsubmit="handleAuth(event)">
                <div class="form-group" id="nameGroup" style="display: none;">
                    <label for="authName">Full Name</label>
                    <input type="text" id="authName" placeholder="John Doe">
                </div>
                <div class="form-group">
                    <label for="authEmail">Email</label>
                    <input type="email" id="authEmail" placeholder="you@example.com" required>
                </div>
                <div class="form-group">
                    <label for="authPassword">Password</label>
                    <input type="password" id="authPassword" placeholder="" required minlength="6">
                </div>
                <button type="submit" class="auth-btn" id="authSubmitBtn">Sign In</button>
            </form>
            
            <div class="auth-toggle">
                <span id="authToggleText">Don't have an account?</span>
                <a onclick="toggleAuthMode()" id="authToggleLink">Sign Up</a>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="share-modal-overlay" id="shareModal">
        <div class="share-modal">
            <h3> Share Deal</h3>
            <p class="subtitle">Anyone with this link can view and edit this deal</p>
            
            <div class="share-link-container">
                <input type="text" class="share-link-input" id="shareLinkInput" readonly>
                <button class="share-copy-btn" id="shareCopyBtn" onclick="copyShareLink()">Copy</button>
            </div>
            
            <div class="share-note">
                <strong>Note:</strong> Changes made by collaborators will update your original deal in real-time.
            </div>
            
            <div class="share-actions">
                <button class="share-revoke-btn" id="shareRevokeBtn" onclick="revokeShare()">Revoke Access</button>
                <button class="share-close-btn" onclick="closeShareModal()">Done</button>
            </div>
        </div>
    </div>

    <!-- Save Choice Modal -->
    <div class="save-choice-modal-overlay" id="saveChoiceModal">
        <div class="save-choice-modal">
            <h3> Save Deal</h3>
            <p class="subtitle">This deal already exists in your library. How would you like to save?</p>
            
            <div class="save-choice-buttons">
                <button class="save-choice-btn overwrite" onclick="resolveSaveChoice('update')">
                    <span></span>
                    <span>Overwrite</span>
                    <span class="btn-hint">Update the existing deal</span>
                </button>
                <button class="save-choice-btn copy" onclick="showCopyNameInput()">
                    <span></span>
                    <span>Create Copy</span>
                    <span class="btn-hint">Save as a new version</span>
                </button>
            </div>
            
            <button class="save-choice-cancel" onclick="resolveSaveChoice('cancel')">Cancel</button>
        </div>
    </div>

    <!-- Copy Name Modal -->
    <div class="save-choice-modal-overlay" id="copyNameModal">
        <div class="save-choice-modal">
            <h3> Name Your Copy</h3>
            <p class="subtitle" id="copyNamePreview">4567 Any Street, Provo, UT 84601 - </p>
            
            <div class="copy-name-input-container">
                <input type="text" id="copyNameInput" class="copy-name-input" placeholder="e.g. $60k to seller, Max cash flow, Counter offer">
            </div>
            
            <p class="copy-name-hint">Leave blank for automatic numbering (1), (2), etc.</p>
            
            <div class="copy-name-buttons">
                <button class="save-choice-cancel" onclick="closeCopyNameModal()">Back</button>
                <button class="save-choice-btn copy" onclick="confirmCopyName()" style="flex: none; padding: 0.75rem 1.5rem;">
                    <span></span>
                    <span>Save Copy</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Email Offer Modal -->
    <div class="email-modal-overlay" id="emailOfferModal">
        <div class="email-modal">
            <h3> Send Offer</h3>
            <p class="subtitle">Send LOI and Deal Summary to recipient</p>
            
            <div class="email-form">
                <div class="email-field">
                    <label>Recipient Email *</label>
                    <input type="email" id="emailRecipientAddress" placeholder="seller@example.com">
                </div>
                <div class="email-field">
                    <label>Recipient Name</label>
                    <input type="text" id="emailRecipientName" placeholder="Property Owner">
                </div>
            </div>
            
            <div class="email-preview">
                <div class="email-preview-label">Will include:</div>
                <div class="email-preview-items">
                    <span> Letter of Intent (PDF)</span>
                    <span> Deal Summary (PDF)</span>
                </div>
            </div>
            
            <div class="email-status" id="emailStatus" style="display: none;">
                <span class="email-status-icon"></span>
                <span class="email-status-text">Sending...</span>
            </div>
            
            <div class="email-buttons">
                <button class="save-choice-cancel" onclick="closeEmailModal()">Cancel</button>
                <button class="email-send-btn" id="emailSendBtn" onclick="sendOfferEmail()">
                    <span></span> Send Email
                </button>
            </div>
        </div>
    </div>

    <!-- Rename Deal Modal -->
    <div class="save-choice-modal-overlay" id="renameDealModal">
        <div class="save-choice-modal">
            <h3> Rename Deal</h3>
            <p class="subtitle" id="renameAddressPreview">4567 Any Street, Provo, UT 84601</p>
            
            <div class="copy-name-input-container">
                <div class="rename-input-wrapper">
                    <span class="rename-prefix" id="renamePrefix">-</span>
                    <input type="text" id="renameDealInput" class="copy-name-input rename-input" placeholder="e.g. $60k to seller, Max cash flow">
                </div>
            </div>
            
            <p class="copy-name-hint">Leave blank to show address only</p>
            
            <div class="copy-name-buttons">
                <button class="save-choice-cancel" onclick="closeRenameModal()">Cancel</button>
                <button class="goal-apply-btn" onclick="confirmRename()">
                    <span></span> Save
                </button>
            </div>
        </div>
    </div>

    <!-- User Indicator -->
    <div class="user-indicator" id="userIndicator" style="display: none;">
        <div class="user-avatar" id="userAvatar">?</div>
        <span class="user-email" id="userEmail"></span>
        <div class="sync-status synced" id="syncStatus">
            <span class="sync-dot"></span>
            <span class="sync-text">Synced</span>
        </div>
        <button class="logout-btn" onclick="handleLogout()">Logout</button>
    </div>

    <!-- Address Collision Warning (inserted near address fields via JS) -->
    <template id="collisionWarningTemplate">
        <div class="collision-warning" id="collisionWarning">
            <div class="collision-warning-title">
                <span></span>
                <span>Address Already Being Worked</span>
            </div>
            <div class="collision-warning-detail" id="collisionDetail">
                This property is being worked by another team member.
            </div>
        </div>
    </template>

    <div class="container">
        <!-- Shared Deal Banner -->
        <div class="shared-deal-banner" id="sharedDealBanner">
            <h4> Shared Deal</h4>
            <p>You're viewing a shared deal. Any changes you make will be synced to the owner's library.</p>
            <button class="save-shared-btn" onclick="saveSharedDealChanges()"> Save Changes</button>
        </div>

        <header>
            <h1>Real Estate Underwriting Calculator</h1>
            <p class="subtitle">Comprehensive deal analysis with seller financing & equity carry</p>
        </header>

        <!-- Property & Preparer Info -->
        <div class="info-bar">
            <div class="info-row-full">
                <div class="info-section">
                    <div class="info-section-title"> Property Address</div>
                    <div class="info-row">
                        <input type="text" id="streetAddress" placeholder="Street address (e.g., 1234 Any Street)" class="info-input" style="flex: 2;" onblur="checkAddressCollision()">
                        <input type="text" id="city" placeholder="City" class="info-input" style="flex: 1;" onblur="checkAddressCollision()">
                        <input type="text" id="state" placeholder="ST" class="info-input" style="flex: 0.3; text-transform: uppercase;" maxlength="2" onblur="checkAddressCollision()">
                        <input type="text" id="zip" placeholder="Zip" class="info-input" style="flex: 0.5;" maxlength="10">
                    </div>
                    <div class="collision-warning" id="collisionWarning">
                        <div class="collision-warning-title">
                            <span></span>
                            <span>Address Already Being Worked</span>
                        </div>
                        <div class="collision-warning-detail" id="collisionDetail">
                            This property is being worked by another team member.
                        </div>
                    </div>
                </div>
            </div>
            <div class="info-row-full">
                <div class="info-section">
                    <div class="info-section-title"> Property Link</div>
                    <input type="url" id="propertyLink" placeholder="Property listing URL (Zillow, Redfin, etc.)" class="info-input">
                </div>
            </div>
            <div class="info-row-full">
                <div class="info-section">
                    <div class="info-section-title"> Prepared By</div>
                    <div class="info-row">
                        <input type="text" id="preparerName" placeholder="Your name" class="info-input">
                        <input type="email" id="preparerEmail" placeholder="Email address" class="info-input">
                        <input type="tel" id="preparerPhone" placeholder="Phone number" class="info-input">
                    </div>
                </div>
            </div>
            <div class="info-row-full">
                <div class="info-section">
                    <div class="info-section-title"> Seller Info</div>
                    <div class="info-row">
                        <input type="text" id="sellerName" placeholder="Seller's name" class="info-input">
                        <input type="email" id="sellerEmail" placeholder="Seller's email" class="info-input">
                        <input type="tel" id="sellerPhone" placeholder="Seller's phone" class="info-input">
                    </div>
                </div>
            </div>
            <div class="info-row-full">
                <div class="info-section">
                    <div class="info-section-title"> Notes <span style="font-weight: normal; font-size: 0.8em; color: #64748b;">(internal use only - not included in LOI or summaries)</span></div>
                    <textarea id="dealNotes" placeholder="Add notes about this deal - phone call details, agent feedback, property conditions, etc." class="info-input" style="width: 100%; min-height: 80px; resize: vertical; font-family: inherit; box-sizing: border-box;"></textarea>
                </div>
            </div>
        </div>

        <!-- Sticky Dashboard Bar -->
        <div class="sticky-dashboard">
            <div class="dashboard-metric">
                <span class="dashboard-label">Cap Rate</span>
                <span class="dashboard-value" id="dashCapRate">0%</span>
            </div>
            <div class="dashboard-metric">
                <span class="dashboard-label">Blended Rate</span>
                <span class="dashboard-value" id="dashBlendedRate">0%</span>
            </div>
            <div class="dashboard-metric">
                <span class="dashboard-label">Spread</span>
                <span class="dashboard-value" id="dashSpread">0%</span>
            </div>
            <div class="dashboard-metric">
                <span class="dashboard-label">NOI</span>
                <span class="dashboard-value" id="dashNOI">$0</span>
            </div>
            <div class="dashboard-metric">
                <span class="dashboard-label">Monthly CF</span>
                <span class="dashboard-value" id="dashMonthlyCF">$0</span>
            </div>
            <div class="dashboard-metric">
                <span class="dashboard-label">Cash to Seller</span>
                <span class="dashboard-value" id="dashCashToSeller">$0</span>
            </div>
        </div>

        <div class="main-grid">
            <!-- LOAN CONFIGURATION -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-teal"></div>
                    <h2 class="card-title">Loan Configuration</h2>
                    <div class="card-status complete" id="loanConfigStatus">
                        <span class="card-status-icon"></span>
                        <span>Complete</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Category / Property Type</label>
                    <select id="category" class="input-highlight" onchange="calculate()">
                        <option value="DSCR Residential">DSCR Residential</option>
                        <option value="Mixed Use">Mixed Use</option>
                        <option value="12+Residential">12+ Residential</option>
                        <option value="Commercial">Commercial</option>
                        <option value="RV Park">RV Park</option>
                    </select>
                </div>

                <div class="input-row">
                    <div class="form-group">
                        <label>First Loan % / LTV</label>
                        <input type="number" id="firstLoanLTV" value="26" step="1" min="0" max="75" class="input-highlight" onchange="calculate()">
                        <span class="helper-text">% of purchase price (max 75%)</span>
                    </div>
                    <div class="form-group">
                        <label>Seller Carry %</label>
                        <input type="number" id="sellerCarryPct" value="80" step="1" min="0" max="100" class="input-highlight" onchange="calculate()">
                        <span class="helper-text">% of purchase price</span>
                    </div>
                </div>

                <div class="equity-warning" id="firstPositionWarning" style="display: none;">
                    <span class="warning-icon"></span>
                    <span class="warning-text" id="firstPositionWarningText">First position warning</span>
                </div>

                <div class="input-row">
                    <div class="form-group">
                        <label>Interest Only? (First Loan)</label>
                        <select id="interestOnly" class="input-highlight" onchange="calculate()">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Interest @ Balloon?</label>
                        <select id="interestAtBalloon" class="input-highlight" onchange="calculate()">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                </div>

                <div class="input-row">
                    <div class="form-group">
                        <label>Months to Stabilize</label>
                        <input type="number" id="monthsToStabilize" value="0" step="1" min="0" class="input-highlight" onchange="calculate()">
                    </div>
                    <div class="form-group">
                        <label>% Revenue During Stabilization</label>
                        <input type="number" id="revenueDuringStab" value="100" step="1" min="0" max="100" class="input-highlight" onchange="calculate()">
                    </div>
                </div>

                <div class="form-group">
                    <label>Years to Balloon</label>
                    <input type="number" id="yearsToBalloon" value="8" step="1" min="1" class="input-highlight" onchange="calculate()">
                </div>
            </div>

            <!-- PURCHASE & PRICING -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-amber"></div>
                    <h2 class="card-title">Purchase & Pricing</h2>
                    <div class="card-status needs-review" id="purchasePricingStatus">
                        <span class="card-status-icon">!</span>
                        <span>3 to review</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>Purchase Price ($)</label>
                    <input type="number" id="purchasePrice" value="" step="1000" class="input-highlight" onchange="calculate()" placeholder="0">
                </div>

                <div class="form-group">
                    <label>Asking Price ($)</label>
                    <input type="number" id="askingPrice" value="" step="1000" class="input-highlight" onchange="calculate()" placeholder="0">
                </div>

                <div class="form-group">
                    <label>Existing Debt ($)</label>
                    <input type="number" id="existingDebt" value="0" step="1000" class="input-highlight" onchange="calculate()">
                    <span class="helper-text">Current mortgage/loan balance on property</span>
                </div>

                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-label">Seller Equity</div>
                        <div class="result-value" id="sellerEquity">$0</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Equity %</div>
                        <div class="result-value" id="equityPercent">0%</div>
                    </div>
                </div>

                <div class="equity-warning" id="equityWarning" style="display: none;">
                    <span class="warning-icon"></span>
                    <span class="warning-text" id="equityWarningText">Low equity warning</span>
                </div>

                <div class="result-grid">
                    <div class="result-item full-width">
                        <div class="result-label">Over/Under Asking</div>
                        <div class="result-value" id="overUnderAsking">0.00%</div>
                    </div>
                </div>

                <div class="section-divider"></div>

                <div class="form-group">
                    <label>Annual Rental Revenue ($)</label>
                    <input type="number" id="rentalRevenue" value="" step="100" class="input-highlight" onchange="calculate()" placeholder="0">
                    <span class="helper-text">Monthly: <span id="monthlyRevenue">$202,993</span></span>
                </div>

                <div class="form-group">
                    <label>Appreciation per Year (%)</label>
                    <input type="number" id="appreciationRate" value="2" step="0.1" min="0" class="input-highlight" onchange="calculate()">
                </div>
            </div>

            <!-- CASH TO BUYER -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-green"></div>
                    <h2 class="card-title">Cash to Buyer Analysis</h2>
                    <div class="card-status needs-review" id="cashToBuyerStatus">
                        <span class="card-status-icon">!</span>
                        <span>3 to review</span>
                    </div>
                </div>

                <div class="input-row">
                    <div class="form-group">
                        <label>Agent Fee ($)</label>
                        <input type="number" id="agentFee" value="0" step="100" class="input-highlight" onchange="calculate()">
                    </div>
                    <div class="form-group">
                        <label>Rehab Cost ($)</label>
                        <input type="number" id="rehabCost" value="0" step="100" class="input-highlight" onchange="calculate()">
                    </div>
                </div>

                <div class="input-row">
                    <div class="form-group">
                        <label>Assignment Fee (%)</label>
                        <input type="number" id="assignmentFeePct" value="5" step="0.5" min="0" class="input-highlight" onchange="calculate()">
                    </div>
                    <div class="form-group">
                        <label>Commercial Appraisal ($)</label>
                        <input type="number" id="appraisalCost" value="0" step="100" class="input-highlight" onchange="calculate()">
                    </div>
                </div>

                <div class="form-group">
                    <label>Closing & Bridge Loan Cost (%)</label>
                    <input type="number" id="closingCostPct" value="5" step="0.5" min="0" class="input-highlight" onchange="calculate()">
                </div>

                <div class="cash-breakdown">
                    <div class="cash-breakdown-title">Cash Breakdown</div>
                    <div class="expense-row">
                        <span class="expense-label">Residual (Equity Gain)</span>
                        <span class="expense-value" id="residualValue">$0</span>
                    </div>
                    <div class="expense-row">
                        <span class="expense-label">Agent Fee</span>
                        <span class="expense-value" id="agentFeeDisplay">$0</span>
                    </div>
                    <div class="expense-row">
                        <span class="expense-label">Rehab</span>
                        <span class="expense-value" id="rehabDisplay">$0</span>
                    </div>
                    <div class="expense-row">
                        <span class="expense-label">Assignment Fee</span>
                        <span class="expense-value" id="assignmentFeeDisplay">$0</span>
                    </div>
                    <div class="expense-row">
                        <span class="expense-label">Reserves for Stabilization</span>
                        <span class="expense-value" id="stabReserves">$0</span>
                    </div>
                    <div class="expense-row">
                        <span class="expense-label">Commercial Appraisal</span>
                        <span class="expense-value" id="appraisalDisplay">$0</span>
                    </div>
                    <div class="expense-row">
                        <span class="expense-label">Closing & Bridge Loan</span>
                        <span class="expense-value" id="closingCostDisplay">$0</span>
                    </div>
                    <div class="expense-row total-row">
                        <span class="expense-label">Cash to Buyer</span>
                        <span class="expense-value" id="cashToBuyer">$0</span>
                    </div>
                </div>
            </div>

            <!-- FINANCING OVERVIEW -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-blue"></div>
                    <h2 class="card-title">Financing Overview</h2>
                </div>

                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-label">First Position Loan</div>
                        <div class="result-value highlight" id="firstPositionLoan">$0</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Interest Rate</div>
                        <div class="result-value" id="firstPositionRate">0%</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Amortization</div>
                        <div class="result-value" id="firstPositionAmort">0 yrs</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Monthly Payment</div>
                        <div class="result-value" id="firstPositionPayment">$0</div>
                    </div>
                </div>

                <div class="section-divider"></div>

                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-label">Seller Carry</div>
                        <div class="result-value highlight" id="sellerCarryAmount">$0</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Seller Carry Rate</div>
                        <input type="number" id="sellerCarryRate" value="0" step="0.1" min="0" max="20" style="width:100%;padding:0.5rem;font-size:1rem;" onchange="calculate()">
                    </div>
                    <div class="result-item">
                        <div class="result-label">Amortization</div>
                        <input type="number" id="sellerCarryAmort" value="30" step="1" min="1" max="40" style="width:100%;padding:0.5rem;font-size:1rem;" onchange="calculate()">
                    </div>
                    <div class="result-item">
                        <div class="result-label">Monthly Payment</div>
                        <div class="result-value" id="sellerCarryPayment">$0</div>
                    </div>
                </div>

                <div class="section-divider"></div>

                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-label">Down Payment</div>
                        <div class="result-value amber" id="downPayment">$0</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Total Financing %</div>
                        <div class="result-value" id="totalFinancingPct">0%</div>
                    </div>
                </div>
            </div>

            <!-- OPERATING EXPENSES -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-red"></div>
                    <h2 class="card-title">Operating Expenses</h2>
                    <div class="card-status needs-review" id="operatingExpensesStatus">
                        <span class="card-status-icon">!</span>
                        <span>2 to review</span>
                    </div>
                </div>

                <div class="percentage-inputs">
                    <div class="form-group">
                        <label>Property Tax ($/yr)</label>
                        <input type="number" id="propertyTax" value="" step="100" onchange="calculate()" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>Insurance ($/yr)</label>
                        <input type="number" id="insurance" value="" step="100" onchange="calculate()" placeholder="0">
                    </div>
                    <div class="form-group">
                        <label>HOA ($/yr)</label>
                        <input type="number" id="hoa" value="0" step="100" onchange="calculate()">
                    </div>
                    <div class="form-group">
                        <label>Other Expenses ($/yr)</label>
                        <input type="number" id="otherExpenses" value="0" step="100" onchange="calculate()">
                    </div>
                </div>

                <div class="section-divider"></div>

                <div class="percentage-inputs">
                    <div class="form-group">
                        <label>CapEx & Maint (% Revenue)</label>
                        <input type="number" id="capexPct" value="5" step="1" min="0" max="50" onchange="calculate()">
                    </div>
                    <div class="form-group">
                        <label>Management (% Revenue)</label>
                        <input type="number" id="managementPct" value="10" step="1" min="0" max="50" onchange="calculate()">
                    </div>
                    <div class="form-group">
                        <label>Vacancy (% Revenue)</label>
                        <input type="number" id="vacancyPct" value="5" step="1" min="0" max="50" onchange="calculate()">
                    </div>
                </div>

                <div class="result-grid" style="margin-top:1rem;">
                    <div class="result-item full-width">
                        <div class="result-label">Total Operating Expenses (Annual)</div>
                        <div class="result-value negative" id="totalOpExpenses">$0</div>
                    </div>
                </div>
            </div>

            <!-- CASH FLOW ANALYSIS -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-green"></div>
                    <h2 class="card-title">Cash Flow Analysis</h2>
                </div>

                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-label">Annual Revenue</div>
                        <div class="result-value" id="annualRevenue">$0</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Operating Expenses</div>
                        <div class="result-value negative" id="opExpensesDisplay">$0</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">First Position P&I</div>
                        <div class="result-value negative" id="firstPIPayout">$0</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Seller Carry Payment</div>
                        <div class="result-value negative" id="sellerCarryPayout">$0</div>
                    </div>
                </div>

                <div class="section-divider"></div>

                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-label">Annual Cash Flow</div>
                        <div class="result-value positive" id="annualCashFlow">$0</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Monthly Cash Flow</div>
                        <div class="result-value positive" id="monthlyCashFlow">$0</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Cash-on-Cash Return</div>
                        <div class="result-value highlight" id="cocReturn">0%</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">CF to Purchase Price</div>
                        <div class="result-value" id="cfToPurchase">0%</div>
                    </div>
                </div>
            </div>

            <!-- NOI & CAP RATE -->
            <div class="card summary-card">
                <div class="card-header">
                    <div class="card-icon icon-amber"></div>
                    <h2 class="card-title">NOI & Cap Rate</h2>
                </div>

                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-label">Net Operating Income (NOI)</div>
                        <div class="result-value positive" id="noiValue">$0</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Cap Rate</div>
                        <div class="result-value highlight" id="capRate">0%</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Blended Interest Rate</div>
                        <div class="result-value" id="blendedRate">0%</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Spread (Cap - Blended)</div>
                        <div class="result-value" id="capBlendedSpread">0%</div>
                    </div>
                </div>

                <div class="spread-indicator" id="spreadIndicator">
                    <span class="spread-icon"></span>
                    <span class="spread-text">Positive spread  capital stacking works</span>
                </div>
            </div>

            <!-- BALLOON & EQUITY -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-blue"></div>
                    <h2 class="card-title">Balloon & Equity Analysis</h2>
                </div>

                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-label">Value @ Balloon</div>
                        <div class="result-value highlight" id="valueAtBalloon">$0</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Total Balance @ Balloon</div>
                        <div class="result-value negative" id="balanceAtBalloon">$0</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Equity @ Balloon</div>
                        <div class="result-value positive" id="equityAtBalloon">$0</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Equity % @ Balloon</div>
                        <div class="result-value" id="equityPctBalloon">0%</div>
                    </div>
                </div>

                <div class="section-divider"></div>

                <div class="result-grid">
                    <div class="result-item">
                        <div class="result-label">First Position Balance</div>
                        <div class="result-value" id="firstPositionBalance">$0</div>
                    </div>
                    <div class="result-item">
                        <div class="result-label">Seller Carry Balance</div>
                        <div class="result-value" id="sellerCarryBalance">$0</div>
                    </div>
                </div>
            </div>

            <!-- LOI SUMMARY -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon icon-teal"></div>
                    <h2 class="card-title">LOI Summary</h2>
                </div>

                <table class="loi-table">
                    <tr>
                        <td>Purchase Price</td>
                        <td id="loiPurchasePrice">$0</td>
                    </tr>
                    <tr>
                        <td>Cash to Seller at Closing</td>
                        <td id="loiCashToSeller">$0</td>
                    </tr>
                    <tr>
                        <td>Seller Equity Agreement</td>
                        <td id="loiSellerEquity">$0</td>
                    </tr>
                    <tr>
                        <td>Amortization (Years)</td>
                        <td id="loiAmortization">0</td>
                    </tr>
                    <tr>
                        <td># Years to Balloon</td>
                        <td id="loiYearsBalloon">0</td>
                    </tr>
                    <tr>
                        <td>Months to Stabilize</td>
                        <td id="loiMonthsStabilize">0</td>
                    </tr>
                    <tr>
                        <td>Monthly Payments to Seller</td>
                        <td id="loiMonthlyPayment">$0</td>
                    </tr>
                    <tr>
                        <td>Interest Rate to Seller</td>
                        <td id="loiInterestRate">0%</td>
                    </tr>
                </table>
            </div>
        </div>

        <!-- Goal Finder -->
        <div class="goal-finder">
            <div class="goal-finder-header">
                <div class="goal-finder-header-left">
                    <div class="card-icon icon-amber"></div>
                    <h2>Goal Finder</h2>
                </div>
                <span style="color: var(--text-muted); font-size: 0.85rem;">Reverse-engineer deal terms from your desired outcomes</span>
            </div>

            <div class="goal-finder-grid">
                <div class="goal-input-group">
                    <label>Minimum Cap Rate (%)</label>
                    <input type="number" id="goalCapRate" value="7" step="0.5" min="0" max="20">
                </div>
                <div class="goal-input-group">
                    <label>Minimum Monthly Cash Flow ($)</label>
                    <input type="number" id="goalCashFlow" value="300" step="50" min="0">
                </div>
                <div class="goal-input-group">
                    <label>Target Cash to Seller ($)</label>
                    <input type="number" id="goalCashToSeller" value="100000" step="5000" min="0">
                </div>
            </div>

            <div class="goal-variables">
                <div class="goal-variables-title">Variables to Adjust</div>
                <div class="goal-variable-row">
                    <div class="goal-variable-item">
                        <input type="checkbox" id="goalAdjustLTV" checked>
                        <label for="goalAdjustLTV">First Position LTV %</label>
                    </div>
                    <div class="goal-variable-item">
                        <input type="checkbox" id="goalAdjustSellerCarry" checked>
                        <label for="goalAdjustSellerCarry">Seller Carry %</label>
                    </div>
                    <div class="goal-variable-item">
                        <input type="checkbox" id="goalAdjustSellerAmort">
                        <label for="goalAdjustSellerAmort">Seller Amortization</label>
                    </div>
                    <div class="goal-variable-item">
                        <input type="checkbox" id="goalAdjustPrice">
                        <label for="goalAdjustPrice">Purchase Price</label>
                    </div>
                </div>
                <div class="goal-variable-options">
                    <div class="goal-option" id="goalPriceRange" style="display: none;">
                        <label>Min Price</label>
                        <div class="goal-option-input">
                            <span>$</span>
                            <input type="number" id="goalMinPrice" value="0" step="10000">
                        </div>
                    </div>
                    <div class="goal-option" id="goalAmortRange" style="display: none;">
                        <label>Max Amortization</label>
                        <div class="goal-option-input">
                            <input type="number" id="goalMaxAmort" value="99" step="1" min="30" max="99">
                            <span>yrs</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="goal-actions">
                <button class="goal-find-btn" onclick="findGoalTerms()">
                    <span></span> Find Optimal Terms
                </button>
            </div>

            <div class="goal-results" id="goalResults">
                <div class="goal-results-header" id="goalResultsHeader">
                    <span></span>
                    <span>Solution Found</span>
                </div>
                <div class="goal-results-grid" id="goalResultsGrid">
                    <!-- Filled by JS -->
                </div>
                <div class="goal-metrics-achieved" id="goalMetricsAchieved">
                    <!-- Filled by JS -->
                </div>
                <div style="margin-top: 1rem;">
                    <button class="goal-apply-btn" onclick="applyGoalTerms()">
                        <span></span> Apply These Terms
                    </button>
                </div>
            </div>
        </div>

        <!-- AI Prompt Generator Section -->
        <div class="market-analysis-section" style="margin-top: 2rem;">
            <div class="market-header">
                <div class="market-header-left">
                    <div class="card-icon icon-blue"></div>
                    <h2 class="card-title">AI Deal Analysis</h2>
                </div>
                <button class="generate-prompt-btn" onclick="generatePrompt()">
                    <span> Generate AI Prompt</span>
                </button>
            </div>

            <div class="prompt-section" id="promptSection">
                <p class="prompt-instructions">Click "Generate AI Prompt" to create a prompt with all your deal data that you can paste into ChatGPT, Claude, or any AI assistant for a detailed deal and market analysis.</p>
            </div>
        </div>

        <!-- Export Buttons -->
        <div class="export-buttons">
            <button class="library-btn" onclick="saveToLibrary()">
                <span></span> Save Deal to Library
            </button>
            <button class="print-btn" onclick="generatePDF()">
                <span></span> PDF Summary
            </button>
            <button class="loi-btn" onclick="generateLOI()">
                <span></span> Generate LOI
            </button>
        </div>

        <!-- Deal Library Panel -->
        <div class="deal-library" id="dealLibrary">
            <div class="library-header">
                <h3> Deal Library</h3>
            </div>
            
            <div class="library-controls">
                <div class="library-search">
                    <input type="text" id="librarySearch" placeholder="Search by address, city, state, or seller..." onkeyup="renderLibrary()">
                </div>
                <div class="library-sort">
                    <label>Sort by:</label>
                    <select id="librarySort" onchange="renderLibrary()">
                        <option value="modified-desc">Last Modified</option>
                        <option value="modified-asc">First Modified</option>
                        <option value="created-desc">Last Created</option>
                        <option value="created-asc">First Created</option>
                        <option value="address">Address (A-Z)</option>
                        <option value="city">City (A-Z)</option>
                        <option value="state">State (A-Z)</option>
                        <option value="seller">Seller (A-Z)</option>
                        <option value="status">Status</option>
                    </select>
                </div>
            </div>
            
            <div class="library-stats" id="libraryStats"></div>
            
            <div class="library-list" id="libraryList">
                <p class="library-empty">No deals saved yet. Click "Save Current Deal" to add one.</p>
            </div>
        </div>

        <footer>
            Real Estate Underwriting Calculator  2026 markarian.ai. All rights reserved. For informational purposes only.
        </footer>
    </div>

    <script>
        // =============================================
        // SUPABASE CONFIGURATION
        // =============================================
        const SUPABASE_URL = 'https://rvlvmlcojwthlwykwmgq.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJ2bHZtbGNvand0aGx3eWt3bWdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgwNTU5NDYsImV4cCI6MjA4MzYzMTk0Nn0.LrzvTu43xl07yhyZqibXgfATxEhvoMuhdZ7GK_QYJcg';
        
        // Initialize Supabase client (with error handling)
        let supabaseClient = null;
        try {
            if (window.supabase) {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            } else {
                console.warn('Supabase library not loaded. Cloud sync will be disabled.');
            }
        } catch (e) {
            console.error('Failed to initialize Supabase:', e);
        }
        
        // Current user state
        let currentUser = null;
        let isSignUpMode = false;

        // =============================================
        // AUTHENTICATION FUNCTIONS
        // =============================================
        
        async function initAuth() {
            // If Supabase isn't available, skip auth and show app directly
            if (!supabaseClient) {
                console.warn('Running in offline mode - no cloud sync');
                hideAuthModal();
                return;
            }
            
            try {
                // Check for existing session
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (session) {
                    currentUser = session.user;
                    showApp();
                    await loadDealsFromCloud();
                } else {
                    showAuthModal();
                }

                // Listen for auth changes
                supabaseClient.auth.onAuthStateChange(async (event, session) => {
                    if (event === 'SIGNED_IN' && session) {
                        currentUser = session.user;
                        showApp();
                        await loadDealsFromCloud();
                    } else if (event === 'SIGNED_OUT') {
                        currentUser = null;
                        showAuthModal();
                    }
                });
            } catch (e) {
                console.error('Auth initialization error:', e);
                hideAuthModal(); // Show app anyway if auth fails
            }
        }

        function showAuthModal() {
            document.getElementById('authModal').style.display = 'flex';
            document.getElementById('userIndicator').style.display = 'none';
        }

        function hideAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            
            // Apply any pending property params from extension (for offline/skip cases)
            applyPendingParams();
        }

        function showApp() {
            hideAuthModal();
            
            // Show user indicator
            const indicator = document.getElementById('userIndicator');
            indicator.style.display = 'flex';
            
            // Set user info
            const email = currentUser.email;
            document.getElementById('userEmail').textContent = email;
            document.getElementById('userAvatar').textContent = email.charAt(0).toUpperCase();
            
            // Apply any pending property params from extension
            applyPendingParams();
        }

        function toggleAuthMode() {
            isSignUpMode = !isSignUpMode;
            
            document.getElementById('authTitle').textContent = isSignUpMode ? 'Create Account' : 'Welcome Back';
            document.getElementById('authSubtitle').textContent = isSignUpMode 
                ? 'Sign up to save and sync your deals' 
                : 'Sign in to sync your deals across devices';
            document.getElementById('authSubmitBtn').textContent = isSignUpMode ? 'Sign Up' : 'Sign In';
            document.getElementById('authToggleText').textContent = isSignUpMode 
                ? 'Already have an account?' 
                : "Don't have an account?";
            document.getElementById('authToggleLink').textContent = isSignUpMode ? 'Sign In' : 'Sign Up';
            document.getElementById('nameGroup').style.display = isSignUpMode ? 'block' : 'none';
            
            // Clear any errors
            hideAuthError();
        }

        function showAuthError(message) {
            const errorEl = document.getElementById('authError');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }

        function hideAuthError() {
            document.getElementById('authError').classList.remove('show');
        }

        async function handleAuth(event) {
            event.preventDefault();
            
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const submitBtn = document.getElementById('authSubmitBtn');
            
            submitBtn.disabled = true;
            submitBtn.textContent = isSignUpMode ? 'Creating account...' : 'Signing in...';
            hideAuthError();

            try {
                if (isSignUpMode) {
                    const name = document.getElementById('authName').value;
                    const { data, error } = await supabaseClient.auth.signUp({
                        email,
                        password,
                        options: {
                            data: { full_name: name }
                        }
                    });
                    
                    if (error) throw error;
                    
                    if (data.user && !data.session) {
                        // Email confirmation required
                        showAuthError('Check your email for a confirmation link!');
                        submitBtn.textContent = 'Check your email';
                        return;
                    }
                } else {
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email,
                        password
                    });
                    
                    if (error) throw error;
                }
            } catch (error) {
                showAuthError(error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = isSignUpMode ? 'Sign Up' : 'Sign In';
            }
        }

        async function handleLogout() {
            await supabaseClient.auth.signOut();
            // Clear local library
            localStorage.removeItem('dealLibrary');
            renderLibrary();
        }

        // =============================================
        // CLOUD SYNC FUNCTIONS
        // =============================================

        function setSyncStatus(status, text) {
            const syncEl = document.getElementById('syncStatus');
            syncEl.className = 'sync-status ' + status;
            syncEl.querySelector('.sync-text').textContent = text;
        }

        async function loadDealsFromCloud() {
            if (!currentUser) return;
            
            setSyncStatus('syncing', 'Syncing...');
            
            try {
                const { data, error } = await supabaseClient
                    .from('deals')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                // Convert cloud deals to local format and save to localStorage
                const localDeals = data.map(cloudDealToLocal);
                localStorage.setItem('dealLibrary', JSON.stringify(localDeals));
                
                renderLibrary();
                setSyncStatus('synced', 'Synced');
            } catch (error) {
                console.error('Error loading deals:', error);
                setSyncStatus('error', 'Sync failed');
            }
        }

        async function saveToCloud(deal) {
            if (!currentUser) return null;
            
            setSyncStatus('syncing', 'Saving...');
            
            try {
                const cloudDeal = localDealToCloud(deal);
                cloudDeal.user_id = currentUser.id;
                
                const { data, error } = await supabaseClient
                    .from('deals')
                    .insert([cloudDeal])
                    .select()
                    .single();
                
                if (error) throw error;
                
                setSyncStatus('synced', 'Saved');
                return data;
            } catch (error) {
                console.error('Error saving deal:', error);
                setSyncStatus('error', 'Save failed');
                return null;
            }
        }

        async function updateInCloud(deal) {
            if (!currentUser || !deal.cloud_id) return;
            
            setSyncStatus('syncing', 'Saving...');
            
            try {
                const cloudDeal = localDealToCloud(deal);
                
                const { error } = await supabaseClient
                    .from('deals')
                    .update(cloudDeal)
                    .eq('id', deal.cloud_id);
                
                if (error) throw error;
                
                setSyncStatus('synced', 'Saved');
            } catch (error) {
                console.error('Error updating deal:', error);
                setSyncStatus('error', 'Save failed');
            }
        }

        async function deleteFromCloud(cloudId) {
            if (!currentUser || !cloudId) return;
            
            try {
                const { error } = await supabaseClient
                    .from('deals')
                    .delete()
                    .eq('id', cloudId);
                
                if (error) throw error;
            } catch (error) {
                console.error('Error deleting deal:', error);
            }
        }

        // Convert local deal format to cloud format
        function localDealToCloud(deal) {
    // Helper to safely get numeric value, preserving 0
    const safeNum = (val, defaultVal) => {
        const parsed = parseFloat(val);
        return isNaN(parsed) ? defaultVal : parsed;
    };
    
    return {
        // Property info - check both possible paths
        street_address: deal.propertyInfo?.streetAddress || '',
        city: deal.propertyInfo?.city || '',
        state: deal.propertyInfo?.state || '',
        zip: deal.propertyInfo?.zip || '',
        property_link: deal.propertyInfo?.link || '',
        
        // Preparer
        preparer_name: deal.preparer?.name || '',
        preparer_email: deal.preparer?.email || '',
        preparer_phone: deal.preparer?.phone || '',
        
        // Seller
        seller_name: deal.seller?.name || '',
        seller_email: deal.seller?.email || '',
        seller_phone: deal.seller?.phone || '',
        
        // FIXED: Category - check both dealTerms.category AND loanConfig.category
        category: deal.dealTerms?.category || deal.loanConfig?.category || 'DSCR Residential',
        
        // FIXED: Loan config - check both financing.* AND loanConfig.* paths
        // Use safeNum to preserve 0 values
        first_loan_ltv: safeNum(deal.financing?.firstLoanLTV ?? deal.loanConfig?.firstLoanLTV, 26),
        seller_carry_pct: safeNum(deal.financing?.sellerCarryPct ?? deal.loanConfig?.sellerCarryPct, 80),
        interest_only: deal.financing?.interestOnly || deal.loanConfig?.interestOnly || 'No',
        interest_at_balloon: deal.financing?.interestAtBalloon || deal.loanConfig?.interestAtBalloon || 'No',
        months_to_stabilize: parseInt(deal.stabilization?.monthsToStabilize ?? deal.loanConfig?.monthsToStabilize ?? 0),
        revenue_during_stab: safeNum(deal.stabilization?.revenueDuringStab ?? deal.loanConfig?.revenueDuringStab, 100),
        years_to_balloon: parseInt(deal.financing?.yearsToBalloon ?? deal.loanConfig?.yearsToBalloon ?? 8),
        
        // FIXED: Deal terms - check both dealTerms.* AND existing paths
        purchase_price: safeNum(deal.dealTerms?.purchasePrice, 0),
        asking_price: safeNum(deal.dealTerms?.askingPrice, 0),
        rental_revenue: safeNum(deal.dealTerms?.rentalRevenue, 0),
        appreciation_rate: safeNum(deal.dealTerms?.appreciationRate, 2),
        
        // Cash to buyer
        agent_fee: safeNum(deal.cashToBuyer?.agentFee, 0),
        rehab_cost: safeNum(deal.cashToBuyer?.rehabCost, 0),
        assignment_fee_pct: safeNum(deal.cashToBuyer?.assignmentFeePct, 5),
        appraisal_cost: safeNum(deal.cashToBuyer?.appraisalCost, 0),
        closing_cost_pct: safeNum(deal.cashToBuyer?.closingCostPct, 5),
        
        // Seller financing - check both financing.* AND sellerFinancing.* paths
        seller_carry_rate: safeNum(deal.financing?.sellerCarryRate ?? deal.sellerFinancing?.rate, 0),
        seller_carry_amort: parseInt(deal.financing?.sellerCarryAmort ?? deal.sellerFinancing?.amortization ?? 30),
        
        // FIXED: Expenses - preserve 0 values, check both otherExpenses and other
        property_tax: safeNum(deal.expenses?.propertyTax, 0),
        insurance: safeNum(deal.expenses?.insurance, 0),
        hoa: safeNum(deal.expenses?.hoa, 0),
        other_expenses: safeNum(deal.expenses?.otherExpenses ?? deal.expenses?.other, 0),
        capex_pct: safeNum(deal.expenses?.capexPct, 5),
        management_pct: safeNum(deal.expenses?.managementPct, 8),
        vacancy_pct: safeNum(deal.expenses?.vacancyPct, 5),
        
        // Full data backup
        full_data: deal,
        updated_at: new Date().toISOString()
    };
}

        // Convert cloud deal format to local format
        function cloudDealToLocal(cloudDeal) {
    // If we have full_data stored, use that as the base
    const base = cloudDeal.full_data || {};
    
    // Helper to safely get numeric value, preserving 0
    const safeNum = (cloudVal, baseVal, defaultVal) => {
        if (cloudVal !== null && cloudVal !== undefined && !isNaN(parseFloat(cloudVal))) {
            return cloudVal;
        }
        if (baseVal !== null && baseVal !== undefined && !isNaN(parseFloat(baseVal))) {
            return baseVal;
        }
        return defaultVal;
    };
    
    return {
        id: cloudDeal.id.substring(0, 13) + Date.now(), // Create local ID
        cloud_id: cloudDeal.id,
        version: '1.0',
        savedAt: cloudDeal.created_at,
        updatedAt: cloudDeal.updated_at || base.updatedAt,
        copyNumber: base.copyNumber || null,
        copyName: base.copyName || null,
        originalAddress: base.originalAddress || null,
        status: base.status || 'working',
        
        // Property Info
        propertyInfo: {
            streetAddress: cloudDeal.street_address || base.propertyInfo?.streetAddress || '',
            city: cloudDeal.city || base.propertyInfo?.city || '',
            state: cloudDeal.state || base.propertyInfo?.state || '',
            zip: cloudDeal.zip || base.propertyInfo?.zip || '',
            address: `${cloudDeal.street_address || ''}, ${cloudDeal.city || ''}, ${cloudDeal.state || ''} ${cloudDeal.zip || ''}`.trim().replace(/^,\s*/, ''),
            link: cloudDeal.property_link || base.propertyInfo?.link || '',
        },
        
        // Preparer
        preparer: {
            name: cloudDeal.preparer_name || base.preparer?.name || '',
            email: cloudDeal.preparer_email || base.preparer?.email || '',
            phone: cloudDeal.preparer_phone || base.preparer?.phone || '',
        },
        
        // Seller
        seller: {
            name: cloudDeal.seller_name || base.seller?.name || '',
            email: cloudDeal.seller_email || base.seller?.email || '',
            phone: cloudDeal.seller_phone || base.seller?.phone || '',
        },
        
        // FIXED: dealTerms structure - this is what populateFormFromDeal() expects
        dealTerms: {
            category: cloudDeal.category || base.dealTerms?.category || base.loanConfig?.category || 'DSCR Residential',
            purchasePrice: safeNum(cloudDeal.purchase_price, base.dealTerms?.purchasePrice, 0),
            askingPrice: safeNum(cloudDeal.asking_price, base.dealTerms?.askingPrice, 0),
            existingDebt: safeNum(null, base.dealTerms?.existingDebt, 0),
            rentalRevenue: safeNum(cloudDeal.rental_revenue, base.dealTerms?.rentalRevenue, 0),
            appreciationRate: safeNum(cloudDeal.appreciation_rate, base.dealTerms?.appreciationRate, 2),
        },
        
        // FIXED: financing structure - this is what populateFormFromDeal() expects
        financing: {
            firstLoanLTV: safeNum(cloudDeal.first_loan_ltv, base.financing?.firstLoanLTV ?? base.loanConfig?.firstLoanLTV, 26),
            interestOnly: cloudDeal.interest_only || base.financing?.interestOnly || base.loanConfig?.interestOnly || 'No',
            sellerCarryPct: safeNum(cloudDeal.seller_carry_pct, base.financing?.sellerCarryPct ?? base.loanConfig?.sellerCarryPct, 80),
            sellerCarryRate: safeNum(cloudDeal.seller_carry_rate, base.financing?.sellerCarryRate ?? base.sellerFinancing?.rate, 0),
            sellerCarryAmort: safeNum(cloudDeal.seller_carry_amort, base.financing?.sellerCarryAmort ?? base.sellerFinancing?.amortization, 30),
            interestAtBalloon: cloudDeal.interest_at_balloon || base.financing?.interestAtBalloon || base.loanConfig?.interestAtBalloon || 'No',
            yearsToBalloon: safeNum(cloudDeal.years_to_balloon, base.financing?.yearsToBalloon ?? base.loanConfig?.yearsToBalloon, 8),
        },
        
        // FIXED: stabilization structure - this is what populateFormFromDeal() expects
        stabilization: {
            monthsToStabilize: safeNum(cloudDeal.months_to_stabilize, base.stabilization?.monthsToStabilize ?? base.loanConfig?.monthsToStabilize, 0),
            revenueDuringStab: safeNum(cloudDeal.revenue_during_stab, base.stabilization?.revenueDuringStab ?? base.loanConfig?.revenueDuringStab, 100),
        },
        
        // FIXED: expenses structure - use otherExpenses (not other) to match populateFormFromDeal()
        // CRITICAL: Preserve 0 values for capexPct, managementPct, vacancyPct
        expenses: {
            propertyTax: safeNum(cloudDeal.property_tax, base.expenses?.propertyTax, 0),
            insurance: safeNum(cloudDeal.insurance, base.expenses?.insurance, 0),
            hoa: safeNum(cloudDeal.hoa, base.expenses?.hoa, 0),
            otherExpenses: safeNum(cloudDeal.other_expenses, base.expenses?.otherExpenses ?? base.expenses?.other, 0),
            capexPct: safeNum(cloudDeal.capex_pct, base.expenses?.capexPct, 5),
            managementPct: safeNum(cloudDeal.management_pct, base.expenses?.managementPct, 8),
            vacancyPct: safeNum(cloudDeal.vacancy_pct, base.expenses?.vacancyPct, 5),
        },
        
        // Cash to buyer
        cashToBuyer: {
            agentFee: safeNum(cloudDeal.agent_fee, base.cashToBuyer?.agentFee, 0),
            rehabCost: safeNum(cloudDeal.rehab_cost, base.cashToBuyer?.rehabCost, 0),
            assignmentFeePct: safeNum(cloudDeal.assignment_fee_pct, base.cashToBuyer?.assignmentFeePct, 5),
            appraisalCost: safeNum(cloudDeal.appraisal_cost, base.cashToBuyer?.appraisalCost, 0),
            closingCostPct: safeNum(cloudDeal.closing_cost_pct, base.cashToBuyer?.closingCostPct, 5),
        },
        
        // Notes
        notes: base.notes || '',
        
        // Legacy support - keep loanConfig and sellerFinancing for backwards compatibility
        loanConfig: {
            category: cloudDeal.category || base.dealTerms?.category || base.loanConfig?.category || 'DSCR Residential',
            firstLoanLTV: safeNum(cloudDeal.first_loan_ltv, base.financing?.firstLoanLTV ?? base.loanConfig?.firstLoanLTV, 26),
            sellerCarryPct: safeNum(cloudDeal.seller_carry_pct, base.financing?.sellerCarryPct ?? base.loanConfig?.sellerCarryPct, 80),
            interestOnly: cloudDeal.interest_only || base.financing?.interestOnly || base.loanConfig?.interestOnly || 'No',
            interestAtBalloon: cloudDeal.interest_at_balloon || base.financing?.interestAtBalloon || base.loanConfig?.interestAtBalloon || 'No',
            monthsToStabilize: safeNum(cloudDeal.months_to_stabilize, base.stabilization?.monthsToStabilize ?? base.loanConfig?.monthsToStabilize, 0),
            revenueDuringStab: safeNum(cloudDeal.revenue_during_stab, base.stabilization?.revenueDuringStab ?? base.loanConfig?.revenueDuringStab, 100),
            yearsToBalloon: safeNum(cloudDeal.years_to_balloon, base.financing?.yearsToBalloon ?? base.loanConfig?.yearsToBalloon, 8),
        },
        sellerFinancing: {
            rate: safeNum(cloudDeal.seller_carry_rate, base.financing?.sellerCarryRate ?? base.sellerFinancing?.rate, 0),
            amortization: safeNum(cloudDeal.seller_carry_amort, base.financing?.sellerCarryAmort ?? base.sellerFinancing?.amortization, 30),
        },
    };
}
        // =============================================
        // ADDRESS COLLISION DETECTION
        // =============================================

        let collisionCheckTimeout = null;

        async function checkAddressCollision() {
            // Debounce the check
            if (collisionCheckTimeout) {
                clearTimeout(collisionCheckTimeout);
            }
            
            collisionCheckTimeout = setTimeout(async () => {
                await performCollisionCheck();
            }, 500);
        }

        async function performCollisionCheck() {
            if (!currentUser) return;
            
            const streetAddress = document.getElementById('streetAddress').value.trim();
            const city = document.getElementById('city').value.trim();
            const state = document.getElementById('state').value.trim();
            
            // Need at least street and city to check
            if (!streetAddress || !city) {
                hideCollisionWarning();
                return;
            }
            
            try {
                const { data, error } = await supabaseClient.rpc('check_address_collision', {
                    p_street_address: streetAddress,
                    p_city: city,
                    p_state: state || '',
                    p_exclude_user_id: currentUser.id
                });
                
                if (error) {
                    console.error('Collision check error:', error);
                    return;
                }
                
                if (data && data.length > 0) {
                    showCollisionWarning(data);
                } else {
                    hideCollisionWarning();
                }
            } catch (error) {
                console.error('Error checking collision:', error);
            }
        }

        function showCollisionWarning(matches) {
            const warningEl = document.getElementById('collisionWarning');
            const detailEl = document.getElementById('collisionDetail');
            
            if (matches.length === 1) {
                const match = matches[0];
                const date = new Date(match.created_at).toLocaleDateString();
                detailEl.textContent = `Being worked by ${match.user_email} (saved ${date})`;
            } else {
                detailEl.textContent = `Being worked by ${matches.length} team members`;
            }
            
            warningEl.classList.add('show');
        }

        function hideCollisionWarning() {
            document.getElementById('collisionWarning').classList.remove('show');
        }

        // =============================================
        // UTILITY FUNCTIONS
        // =============================================
        
        // Utility functions
        function formatCurrency(num) {
            if (isNaN(num) || !isFinite(num)) return '$0';
            const absNum = Math.abs(num);
            if (absNum >= 1000000) {
                return (num < 0 ? '-' : '') + '$' + (absNum / 1000000).toFixed(2) + 'M';
            }
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(num);
        }
        
        function parseCurrency(str) {
            if (!str) return 0;
            return parseFloat(str.replace(/[$,]/g, '')) || 0;
        }

        function formatPercent(num, decimals = 2) {
            if (isNaN(num) || !isFinite(num)) return '0%';
            return (num * 100).toFixed(decimals) + '%';
        }

        // PMT function (Excel equivalent)
        function PMT(rate, nper, pv, fv = 0, type = 0) {
            if (rate === 0) return -(pv + fv) / nper;
            const pvif = Math.pow(1 + rate, nper);
            let pmt = rate / (pvif - 1) * -(pv * pvif + fv);
            if (type === 1) pmt /= (1 + rate);
            return pmt;
        }

        // Calculate remaining balance after n payments
        function remainingBalance(principal, rate, totalPayments, paymentsMade) {
            if (rate === 0) return principal - (principal / totalPayments) * paymentsMade;
            const monthlyRate = rate / 12;
            const balance = principal * Math.pow(1 + monthlyRate, paymentsMade) - 
                            PMT(monthlyRate, totalPayments, -principal) * 
                            (Math.pow(1 + monthlyRate, paymentsMade) - 1) / monthlyRate;
            return Math.max(0, balance);
        }

        // Get interest rate based on category
        function getInterestRate(category) {
            switch(category) {
                case 'DSCR Residential': return 0.08;
                case '12+Residential': return 0.09;
                case 'Commercial': return 0.10;
                case 'RV Park': return 0.11;
                case 'Mixed Use': return 0.10;
                default: return 0.10;
            }
        }

        // Get amortization based on category
        function getAmortization(category) {
            switch(category) {
                case 'DSCR Residential': return 30;
                case '12+Residential': return 30;
                case 'Commercial': return 25;
                case 'RV Park': return 25;
                case 'Mixed Use': return 25;
                default: return 25;
            }
        }

        function calculate() {
            runCalculations();
        }

        function runCalculations() {
            // Get all inputs
            const category = document.getElementById('category').value;
            const firstLoanLTV = parseFloat(document.getElementById('firstLoanLTV').value) / 100 || 0;
            const sellerCarryPct = parseFloat(document.getElementById('sellerCarryPct').value) / 100 || 0;
            const interestOnly = document.getElementById('interestOnly').value;
            const interestAtBalloon = document.getElementById('interestAtBalloon').value;
            const monthsToStabilize = parseInt(document.getElementById('monthsToStabilize').value) || 0;
            const revenueDuringStab = parseFloat(document.getElementById('revenueDuringStab').value) / 100 || 1;
            const yearsToBalloon = parseInt(document.getElementById('yearsToBalloon').value) || 8;

            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
            const askingPrice = parseFloat(document.getElementById('askingPrice').value) || 0;
            const existingDebt = parseFloat(document.getElementById('existingDebt').value) || 0;
            const rentalRevenueAnnual = parseFloat(document.getElementById('rentalRevenue').value) || 0;
            const rentalRevenueMonthly = rentalRevenueAnnual / 12;
            const appreciationRate = parseFloat(document.getElementById('appreciationRate').value) / 100 || 0;

            const agentFee = parseFloat(document.getElementById('agentFee').value) || 0;
            const rehabCost = parseFloat(document.getElementById('rehabCost').value) || 0;
            const assignmentFeePct = parseFloat(document.getElementById('assignmentFeePct').value) / 100 || 0;
            const appraisalCost = parseFloat(document.getElementById('appraisalCost').value) || 0;
            const closingCostPct = parseFloat(document.getElementById('closingCostPct').value) / 100 || 0;

            const sellerCarryRate = parseFloat(document.getElementById('sellerCarryRate').value) / 100 || 0;
            const sellerCarryAmort = parseInt(document.getElementById('sellerCarryAmort').value) || 30;

            const propertyTax = parseFloat(document.getElementById('propertyTax').value) || 0;
            const insurance = parseFloat(document.getElementById('insurance').value) || 0;
            const hoa = parseFloat(document.getElementById('hoa').value) || 0;
            const otherExpenses = parseFloat(document.getElementById('otherExpenses').value) || 0;
            const capexPct = parseFloat(document.getElementById('capexPct').value) / 100 || 0;
            const managementPct = parseFloat(document.getElementById('managementPct').value) / 100 || 0;
            const vacancyPct = parseFloat(document.getElementById('vacancyPct').value) / 100 || 0;

            // Get rates from category
            const firstPositionRate = getInterestRate(category);
            const firstPositionAmort = getAmortization(category);

            // Calculate financing
            const firstPositionLoan = purchasePrice * firstLoanLTV;
            const sellerCarryAmount = purchasePrice * sellerCarryPct;
            const totalFinancingPct = firstLoanLTV + sellerCarryPct;
            const downPayment = purchasePrice * (1 - totalFinancingPct);

            // Calculate payments
            let firstPositionPaymentMonthly;
            if (interestOnly === 'Yes') {
                firstPositionPaymentMonthly = (firstPositionLoan * firstPositionRate) / 12;
            } else {
                firstPositionPaymentMonthly = -PMT(firstPositionRate / 12, firstPositionAmort * 12, firstPositionLoan);
            }

            let sellerCarryPaymentMonthly;
            if (interestAtBalloon === 'Yes' || sellerCarryRate === 0) {
                sellerCarryPaymentMonthly = -PMT(0, sellerCarryAmort * 12, sellerCarryAmount);
            } else {
                sellerCarryPaymentMonthly = -PMT(sellerCarryRate / 12, sellerCarryAmort * 12, sellerCarryAmount);
            }

            // Operating expenses
            const percentageExpenses = rentalRevenueAnnual * (capexPct + managementPct + vacancyPct);
            const fixedExpenses = propertyTax + insurance + hoa + otherExpenses;
            const totalOpExpenses = percentageExpenses + fixedExpenses;
            const totalOpExpensesMonthly = totalOpExpenses / 12;

            // Cash flow calculations
            const firstPIAnnual = firstPositionPaymentMonthly * 12;
            const sellerCarryAnnual = sellerCarryPaymentMonthly * 12;
            const annualCashFlow = rentalRevenueAnnual - totalOpExpenses - firstPIAnnual - sellerCarryAnnual;
            const monthlyCashFlow = annualCashFlow / 12;

            // Cash to buyer calculations
            const residual = (purchasePrice * totalFinancingPct) - purchasePrice;
            const assignmentFee = purchasePrice * assignmentFeePct;
            const closingCost = purchasePrice * closingCostPct;
            
            // Reserves for stabilization
            let stabReserves = 0;
            if (monthsToStabilize > 0) {
                stabReserves = -monthsToStabilize * ((rentalRevenueMonthly * revenueDuringStab) - totalOpExpensesMonthly + sellerCarryPaymentMonthly);
            }

            const cashToBuyer = residual - agentFee - rehabCost - assignmentFee - stabReserves - appraisalCost - closingCost;

            // NOI (before debt service, but after operating expenses)
            const noi = rentalRevenueAnnual - totalOpExpenses;
            const capRate = purchasePrice > 0 ? noi / purchasePrice : 0;

            // Blended interest rate calculation
            const totalFinancingAmount = firstPositionLoan + sellerCarryAmount;
            let blendedRate = 0;
            if (totalFinancingAmount > 0) {
                blendedRate = ((firstPositionLoan * firstPositionRate) + (sellerCarryAmount * sellerCarryRate)) / totalFinancingAmount;
            }
            const capBlendedSpread = capRate - blendedRate;

            // Cash on Cash return
            const cashInvested = Math.abs(cashToBuyer) > 0 ? Math.abs(cashToBuyer) : downPayment;
            const cocReturn = cashInvested > 0 ? annualCashFlow / cashInvested : 0;
            const cfToPurchase = purchasePrice > 0 ? annualCashFlow / purchasePrice : 0;

            // Balloon calculations
            const valueAtBalloon = (askingPrice + rehabCost) * Math.pow(1 + appreciationRate, yearsToBalloon);
            
            // Calculate remaining balances
            const monthsToBalloon = yearsToBalloon * 12;
            let firstPositionBalance;
            if (interestOnly === 'Yes') {
                firstPositionBalance = firstPositionLoan;
            } else {
                firstPositionBalance = remainingBalance(firstPositionLoan, firstPositionRate, firstPositionAmort * 12, monthsToBalloon);
            }

            const sellerPaymentMonths = monthsToBalloon - monthsToStabilize;
            let sellerCarryBalance;
            if (interestAtBalloon === 'Yes') {
                // Principal only payments, so calculate remaining
                const principalPayment = sellerCarryAmount / (sellerCarryAmort * 12);
                sellerCarryBalance = sellerCarryAmount - (principalPayment * sellerPaymentMonths);
                // Add accumulated interest if interest at balloon
                if (sellerCarryRate > 0) {
                    // This is a simplification - actual would compound
                    sellerCarryBalance += sellerCarryAmount * sellerCarryRate * (sellerPaymentMonths / 12);
                }
            } else {
                sellerCarryBalance = remainingBalance(sellerCarryAmount, sellerCarryRate, sellerCarryAmort * 12, sellerPaymentMonths);
            }

            const totalBalance = firstPositionBalance + sellerCarryBalance;
            const equityAtBalloon = valueAtBalloon - totalBalance;
            const equityPctBalloon = valueAtBalloon > 0 ? equityAtBalloon / valueAtBalloon : 0;

            // Over/Under asking
            const overUnderAsking = askingPrice > 0 ? (purchasePrice - askingPrice) / askingPrice : 0;

            // Seller Equity calculations
            const sellerEquity = askingPrice - existingDebt;
            const equityPercentOfAsking = askingPrice > 0 ? sellerEquity / askingPrice : 0;
            const maxSellerCarry = Math.max(0, sellerEquity);
            const sellerCarryExceedsEquity = sellerCarryAmount > maxSellerCarry;

            // Update UI
            document.getElementById('monthlyRevenue').textContent = formatCurrency(rentalRevenueMonthly);
            document.getElementById('overUnderAsking').textContent = formatPercent(overUnderAsking);
            document.getElementById('overUnderAsking').className = 'result-value ' + (overUnderAsking < 0 ? 'positive' : overUnderAsking > 0 ? 'negative' : '');

            // Seller Equity UI
            document.getElementById('sellerEquity').textContent = formatCurrency(sellerEquity);
            document.getElementById('equityPercent').textContent = formatPercent(equityPercentOfAsking, 0);
            
            // Color code equity percent
            const equityPercentEl = document.getElementById('equityPercent');
            if (equityPercentOfAsking >= 0.4) {
                equityPercentEl.className = 'result-value equity-good';
            } else if (equityPercentOfAsking >= 0.25) {
                equityPercentEl.className = 'result-value equity-low';
            } else {
                equityPercentEl.className = 'result-value equity-bad';
            }

            // Equity warning
            const equityWarning = document.getElementById('equityWarning');
            const equityWarningText = document.getElementById('equityWarningText');
            
            if (existingDebt > 0) {
                if (sellerCarryExceedsEquity) {
                    equityWarning.style.display = 'flex';
                    equityWarning.className = 'equity-warning error';
                    equityWarningText.textContent = `Seller carry (${formatCurrency(sellerCarryAmount)}) exceeds available equity (${formatCurrency(maxSellerCarry)})`;
                } else if (equityPercentOfAsking < 0.4) {
                    equityWarning.style.display = 'flex';
                    equityWarning.className = 'equity-warning';
                    equityWarningText.textContent = `Equity ${formatPercent(equityPercentOfAsking, 0)} is below 40% target`;
                } else {
                    equityWarning.style.display = 'none';
                }
            } else {
                equityWarning.style.display = 'none';
            }

            // First position validation
            const firstPositionWarning = document.getElementById('firstPositionWarning');
            const firstPositionWarningText = document.getElementById('firstPositionWarningText');
            const minFirstPositionNeeded = existingDebt;
            const minLTVNeeded = purchasePrice > 0 ? (existingDebt / purchasePrice) : 0;
            const maxLTV = 0.75;
            
            if (existingDebt > 0 && purchasePrice > 0) {
                if (firstLoanLTV > maxLTV) {
                    firstPositionWarning.style.display = 'flex';
                    firstPositionWarning.className = 'equity-warning error';
                    firstPositionWarningText.textContent = `First position LTV (${formatPercent(firstLoanLTV, 0)}) exceeds 75% maximum`;
                } else if (firstPositionLoan < existingDebt) {
                    firstPositionWarning.style.display = 'flex';
                    firstPositionWarning.className = 'equity-warning error';
                    firstPositionWarningText.textContent = `First position (${formatCurrency(firstPositionLoan)}) must cover existing debt (${formatCurrency(existingDebt)}). Min LTV: ${formatPercent(minLTVNeeded, 0)}`;
                } else {
                    firstPositionWarning.style.display = 'none';
                }
            } else if (firstLoanLTV > maxLTV) {
                firstPositionWarning.style.display = 'flex';
                firstPositionWarning.className = 'equity-warning error';
                firstPositionWarningText.textContent = `First position LTV (${formatPercent(firstLoanLTV, 0)}) exceeds 75% maximum`;
            } else {
                firstPositionWarning.style.display = 'none';
            }

            // Financing
            document.getElementById('firstPositionLoan').textContent = formatCurrency(firstPositionLoan);
            document.getElementById('firstPositionRate').textContent = formatPercent(firstPositionRate, 1);
            document.getElementById('firstPositionAmort').textContent = firstPositionAmort + ' yrs';
            document.getElementById('firstPositionPayment').textContent = formatCurrency(firstPositionPaymentMonthly);
            document.getElementById('sellerCarryAmount').textContent = formatCurrency(sellerCarryAmount);
            document.getElementById('sellerCarryPayment').textContent = formatCurrency(sellerCarryPaymentMonthly);
            document.getElementById('downPayment').textContent = formatCurrency(downPayment);
            document.getElementById('totalFinancingPct').textContent = formatPercent(totalFinancingPct, 0);

            // Cash to buyer breakdown
            document.getElementById('residualValue').textContent = formatCurrency(residual);
            document.getElementById('agentFeeDisplay').textContent = formatCurrency(agentFee);
            document.getElementById('rehabDisplay').textContent = formatCurrency(rehabCost);
            document.getElementById('assignmentFeeDisplay').textContent = formatCurrency(assignmentFee);
            document.getElementById('stabReserves').textContent = formatCurrency(stabReserves);
            document.getElementById('appraisalDisplay').textContent = formatCurrency(appraisalCost);
            document.getElementById('closingCostDisplay').textContent = formatCurrency(closingCost);
            document.getElementById('cashToBuyer').textContent = formatCurrency(cashToBuyer);

            // Operating expenses
            document.getElementById('totalOpExpenses').textContent = formatCurrency(totalOpExpenses);

            // Cash flow
            document.getElementById('annualRevenue').textContent = formatCurrency(rentalRevenueAnnual);
            document.getElementById('opExpensesDisplay').textContent = formatCurrency(totalOpExpenses);
            document.getElementById('firstPIPayout').textContent = formatCurrency(firstPIAnnual);
            document.getElementById('sellerCarryPayout').textContent = formatCurrency(sellerCarryAnnual);
            document.getElementById('annualCashFlow').textContent = formatCurrency(annualCashFlow);
            document.getElementById('annualCashFlow').className = 'result-value ' + (annualCashFlow >= 0 ? 'positive' : 'negative');
            document.getElementById('monthlyCashFlow').textContent = formatCurrency(monthlyCashFlow);
            document.getElementById('monthlyCashFlow').className = 'result-value ' + (monthlyCashFlow >= 0 ? 'positive' : 'negative');
            document.getElementById('cocReturn').textContent = formatPercent(cocReturn);
            document.getElementById('cfToPurchase').textContent = formatPercent(cfToPurchase);

            // NOI
            document.getElementById('noiValue').textContent = formatCurrency(noi);
            document.getElementById('capRate').textContent = formatPercent(capRate);
            document.getElementById('blendedRate').textContent = formatPercent(blendedRate);
            document.getElementById('capBlendedSpread').textContent = formatPercent(capBlendedSpread);
            
            // Update spread indicator
            const spreadIndicator = document.getElementById('spreadIndicator');
            if (capBlendedSpread > 0.001) {
                spreadIndicator.className = 'spread-indicator positive';
                spreadIndicator.innerHTML = '<span class="spread-icon"></span><span class="spread-text">Positive spread  capital stacking works</span>';
            } else if (capBlendedSpread < -0.001) {
                spreadIndicator.className = 'spread-indicator negative';
                spreadIndicator.innerHTML = '<span class="spread-icon"></span><span class="spread-text">Negative spread  cap rate below blended rate</span>';
            } else {
                spreadIndicator.className = 'spread-indicator neutral';
                spreadIndicator.innerHTML = '<span class="spread-icon"></span><span class="spread-text">Break-even  cap rate equals blended rate</span>';
            }

            // Balloon
            document.getElementById('valueAtBalloon').textContent = formatCurrency(valueAtBalloon);
            document.getElementById('balanceAtBalloon').textContent = formatCurrency(totalBalance);
            document.getElementById('equityAtBalloon').textContent = formatCurrency(equityAtBalloon);
            document.getElementById('equityPctBalloon').textContent = formatPercent(equityPctBalloon);
            document.getElementById('firstPositionBalance').textContent = formatCurrency(firstPositionBalance);
            document.getElementById('sellerCarryBalance').textContent = formatCurrency(sellerCarryBalance);

            // LOI Summary
            const cashToSellerAtClosing = (1 - sellerCarryPct) * purchasePrice;
            document.getElementById('loiPurchasePrice').textContent = formatCurrency(purchasePrice);
            document.getElementById('loiCashToSeller').textContent = formatCurrency(cashToSellerAtClosing);
            document.getElementById('loiSellerEquity').textContent = formatCurrency(sellerCarryAmount);
            document.getElementById('loiAmortization').textContent = sellerCarryAmort;
            document.getElementById('loiYearsBalloon').textContent = yearsToBalloon;
            document.getElementById('loiMonthsStabilize').textContent = monthsToStabilize;
            document.getElementById('loiMonthlyPayment').textContent = formatCurrency(sellerCarryPaymentMonthly);
            document.getElementById('loiInterestRate').textContent = formatPercent(sellerCarryRate, 1);

            // Sticky Dashboard
            document.getElementById('dashCapRate').textContent = formatPercent(capRate);
            document.getElementById('dashBlendedRate').textContent = formatPercent(blendedRate);
            document.getElementById('dashSpread').textContent = formatPercent(capBlendedSpread);
            document.getElementById('dashSpread').className = 'dashboard-value ' + (capBlendedSpread >= 0 ? 'positive' : 'negative');
            document.getElementById('dashNOI').textContent = formatCurrency(noi);
            document.getElementById('dashMonthlyCF').textContent = formatCurrency(monthlyCashFlow);
            document.getElementById('dashMonthlyCF').className = 'dashboard-value ' + (monthlyCashFlow >= 0 ? 'positive' : 'negative');
            document.getElementById('dashCashToSeller').textContent = formatCurrency(cashToSellerAtClosing);
            
            // Update field validation status
            updateFieldValidation();
        }

        // =============================================
        // FIELD VALIDATION & STATUS INDICATORS
        // =============================================
        
        function updateFieldValidation() {
            // Define fields that need review (just need to be touched/confirmed by user)
            const requiredFields = {
                purchasePricing: [
                    { id: 'purchasePrice' },
                    { id: 'askingPrice' },
                    { id: 'rentalRevenue' },
                    { id: 'existingDebt' }
                ],
                operatingExpenses: [
                    { id: 'propertyTax' },
                    { id: 'insurance' },
                    { id: 'hoa' },
                    { id: 'otherExpenses' }
                ],
                cashToBuyer: [
                    { id: 'agentFee' },
                    { id: 'rehabCost' },
                    { id: 'appraisalCost' }
                ]
            };
            
            // Field needs review if it hasn't been touched yet
            function needsReview(field) {
                const input = document.getElementById(field.id);
                if (!input) return false;
                
                const hasBeenTouched = input.dataset.touched === 'true';
                return !hasBeenTouched;
            }
            
            // Update Purchase & Pricing section
            let purchasePricingCount = 0;
            requiredFields.purchasePricing.forEach(field => {
                const input = document.getElementById(field.id);
                if (input) {
                    if (needsReview(field)) {
                        input.classList.add('needs-review');
                        purchasePricingCount++;
                    } else {
                        input.classList.remove('needs-review');
                    }
                }
            });
            
            const purchaseStatus = document.getElementById('purchasePricingStatus');
            if (purchaseStatus) {
                if (purchasePricingCount === 0) {
                    purchaseStatus.className = 'card-status complete';
                    purchaseStatus.innerHTML = '<span class="card-status-icon"></span><span>Complete</span>';
                } else {
                    purchaseStatus.className = 'card-status needs-review';
                    purchaseStatus.innerHTML = `<span class="card-status-icon">!</span><span>${purchasePricingCount} to review</span>`;
                }
            }
            
            // Update Operating Expenses section
            let operatingExpensesCount = 0;
            requiredFields.operatingExpenses.forEach(field => {
                const input = document.getElementById(field.id);
                if (input) {
                    if (needsReview(field)) {
                        input.classList.add('needs-review');
                        operatingExpensesCount++;
                    } else {
                        input.classList.remove('needs-review');
                    }
                }
            });
            
            const operatingStatus = document.getElementById('operatingExpensesStatus');
            if (operatingStatus) {
                if (operatingExpensesCount === 0) {
                    operatingStatus.className = 'card-status complete';
                    operatingStatus.innerHTML = '<span class="card-status-icon"></span><span>Complete</span>';
                } else {
                    operatingStatus.className = 'card-status needs-review';
                    operatingStatus.innerHTML = `<span class="card-status-icon">!</span><span>${operatingExpensesCount} to review</span>`;
                }
            }
            
            // Update Cash to Buyer section
            let cashToBuyerCount = 0;
            requiredFields.cashToBuyer.forEach(field => {
                const input = document.getElementById(field.id);
                if (input) {
                    if (needsReview(field)) {
                        input.classList.add('needs-review');
                        cashToBuyerCount++;
                    } else {
                        input.classList.remove('needs-review');
                    }
                }
            });
            
            const cashToBuyerStatus = document.getElementById('cashToBuyerStatus');
            if (cashToBuyerStatus) {
                if (cashToBuyerCount === 0) {
                    cashToBuyerStatus.className = 'card-status complete';
                    cashToBuyerStatus.innerHTML = '<span class="card-status-icon"></span><span>Complete</span>';
                } else {
                    cashToBuyerStatus.className = 'card-status needs-review';
                    cashToBuyerStatus.innerHTML = `<span class="card-status-icon">!</span><span>${cashToBuyerCount} to review</span>`;
                }
            }
            
            // Loan Config is always complete (has defaults)
            const loanStatus = document.getElementById('loanConfigStatus');
            if (loanStatus) {
                loanStatus.className = 'card-status complete';
                loanStatus.innerHTML = '<span class="card-status-icon"></span><span>Complete</span>';
            }
        }
        
        // Mark field as touched when user interacts with it
        function markFieldTouched(fieldId) {
            const input = document.getElementById(fieldId);
            if (input) {
                input.dataset.touched = 'true';
            }
        }

        // Initialize on load
        // Store params globally so they survive auth flow
        let pendingPropertyParams = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Capture URL params immediately before anything else
            capturePendingParams();
            
            // Add touch listeners to tracked fields
            const trackedFields = ['purchasePrice', 'askingPrice', 'rentalRevenue', 'existingDebt', 'propertyTax', 'insurance', 'hoa', 'otherExpenses', 'agentFee', 'rehabCost', 'appraisalCost'];
            trackedFields.forEach(fieldId => {
                const input = document.getElementById(fieldId);
                if (input) {
                    input.addEventListener('focus', () => {
                        markFieldTouched(fieldId);
                        updateFieldValidation();
                    });
                    input.addEventListener('change', () => {
                        markFieldTouched(fieldId);
                        updateFieldValidation();
                    });
                }
            });
            
            calculate();
            renderLibrary();
            initAuth(); // Initialize authentication - will call applyPendingParams after auth
            checkForSharedDeal(); // Check if opening a shared deal link
            
            // Toggle price range visibility based on checkbox
            document.getElementById('goalAdjustPrice').addEventListener('change', function() {
                document.getElementById('goalPriceRange').style.display = this.checked ? 'flex' : 'none';
            });
            
            // Toggle amort range visibility based on checkbox
            document.getElementById('goalAdjustSellerAmort').addEventListener('change', function() {
                document.getElementById('goalAmortRange').style.display = this.checked ? 'flex' : 'none';
            });
        });

        // =============================================
        // URL PARAMETER HANDLING (for browser extension)
        // =============================================
        
        function capturePendingParams() {
            const params = new URLSearchParams(window.location.search);
            console.log('[ECC Debug] capturePendingParams called, search:', window.location.search);
            
            // Check if we have property data params (not share params)
            if (params.has('street') || params.has('asking') || params.has('price')) {
                pendingPropertyParams = {
                    street: params.get('street'),
                    city: params.get('city'),
                    state: params.get('state'),
                    zip: params.get('zip'),
                    asking: params.get('asking'),
                    price: params.get('price'),
                    debt: params.get('debt'),
                    url: params.get('url'),
                    sellerName: params.get('sellerName'),
                    sellerPhone: params.get('sellerPhone'),
                    sellerEmail: params.get('sellerEmail'),
                    propertyTax: params.get('propertyTax'),
                    insurance: params.get('insurance'),
                    hoa: params.get('hoa')
                };
                console.log('[ECC Debug] Captured params:', pendingPropertyParams);
                
                // Clean up URL immediately (remove params without refreshing)
                const cleanUrl = window.location.origin + window.location.pathname;
                window.history.replaceState({}, document.title, cleanUrl);
            } else {
                console.log('[ECC Debug] No property params found');
            }
        }
        
        function applyPendingParams() {
            console.log('[ECC Debug] applyPendingParams called, pending:', pendingPropertyParams);
            if (!pendingPropertyParams) return;
            
            const params = pendingPropertyParams;
            pendingPropertyParams = null; // Clear so it doesn't apply again
            
            // Address fields
            if (params.street) {
                document.getElementById('streetAddress').value = params.street;
            }
            if (params.city) {
                document.getElementById('city').value = params.city;
            }
            if (params.state) {
                document.getElementById('state').value = params.state;
            }
            if (params.zip) {
                document.getElementById('zip').value = params.zip;
            }
            
            // Pricing
            if (params.asking) {
                const asking = params.asking.replace(/[^0-9.]/g, '');
                document.getElementById('askingPrice').value = asking;
                document.getElementById('purchasePrice').value = asking; // Default to asking
            }
            if (params.price) {
                const price = params.price.replace(/[^0-9.]/g, '');
                document.getElementById('purchasePrice').value = price;
                if (!params.asking) {
                    document.getElementById('askingPrice').value = price;
                }
            }
            
            // Rental income (annual)
            if (params.rent) {
                const rent = params.rent.replace(/[^0-9.]/g, '');
                document.getElementById('rentalRevenue').value = rent;
            }
            
            // Existing debt
            if (params.debt) {
                const debt = params.debt.replace(/[^0-9.]/g, '');
                document.getElementById('existingDebt').value = debt;
            }
            
            // Property link (the source URL)
            if (params.url) {
                document.getElementById('propertyLink').value = params.url;
            }
            
            // Seller info
            if (params.sellerName) {
                document.getElementById('sellerName').value = params.sellerName;
            }
            if (params.sellerPhone) {
                document.getElementById('sellerPhone').value = params.sellerPhone;
            }
            if (params.sellerEmail) {
                document.getElementById('sellerEmail').value = params.sellerEmail;
            }
            
            // Expense fields (annual values from extension)
            if (params.propertyTax) {
                const tax = params.propertyTax.replace(/[^0-9.]/g, '');
                document.getElementById('propertyTax').value = tax;
            }
            if (params.insurance) {
                const ins = params.insurance.replace(/[^0-9.]/g, '');
                document.getElementById('insurance').value = ins;
            }
            if (params.hoa) {
                const hoa = params.hoa.replace(/[^0-9.]/g, '');
                document.getElementById('hoa').value = hoa;
            }
            
            // Mark imported fields as touched
            if (params.asking || params.price) {
                markFieldTouched('purchasePrice');
                markFieldTouched('askingPrice');
            }
            if (params.debt) {
                markFieldTouched('existingDebt');
            }
            if (params.propertyTax) {
                markFieldTouched('propertyTax');
            }
            if (params.insurance) {
                markFieldTouched('insurance');
            }
            if (params.hoa) {
                markFieldTouched('hoa');
            }
            
            // Recalculate with new values
            calculate();
            
            // Show a subtle notification
            showExtensionNotification();
        }
        
        function checkForPropertyParams() {
            // This is now handled by capturePendingParams + applyPendingParams
            // Keeping function for backwards compatibility
            applyPendingParams();
        }
        
        function showExtensionNotification() {
            const notification = document.createElement('div');
            notification.innerHTML = `
                <div style="
                    position: fixed;
                    top: 1rem;
                    right: 1rem;
                    background: linear-gradient(135deg, var(--accent-teal), var(--accent-blue));
                    color: white;
                    padding: 1rem 1.5rem;
                    border-radius: 12px;
                    font-size: 0.9rem;
                    font-weight: 500;
                    z-index: 9999;
                    animation: slideIn 0.3s ease-out;
                    box-shadow: 0 4px 20px rgba(20, 184, 166, 0.3);
                ">
                     Property data imported from extension
                </div>
            `;
            document.body.appendChild(notification);
            
            // Add animation style
            const style = document.createElement('style');
            style.textContent = `
                @keyframes slideIn {
                    from { opacity: 0; transform: translateX(20px); }
                    to { opacity: 1; transform: translateX(0); }
                }
            `;
            document.head.appendChild(style);
            
            // Remove after 3 seconds
            setTimeout(() => notification.remove(), 3000);
        }

        // =============================================
        // SHARE DEAL FUNCTIONS
        // =============================================
        
        let currentShareToken = null;
        let currentSharedDealCloudId = null;
        
        async function shareDeal(dealId) {
            const deals = getLibrary();
            const deal = deals.find(d => String(d.id) === String(dealId));
            
            if (!deal) {
                alert('Deal not found');
                return;
            }
            
            if (!deal.cloud_id) {
                alert('Please save this deal first (it needs to sync to cloud before sharing)');
                return;
            }
            
            try {
                // Generate share token via Supabase function
                const { data, error } = await supabaseClient.rpc('generate_share_token', {
                    p_deal_id: deal.cloud_id
                });
                
                if (error) throw error;
                
                const shareToken = data;
                currentShareToken = shareToken;
                currentSharedDealCloudId = deal.cloud_id;
                
                // Update local deal with share token
                deal.share_token = shareToken;
                saveLibrary(deals);
                
                // Generate the share URL
                const baseUrl = window.location.origin + window.location.pathname;
                const shareUrl = `${baseUrl}?share=${shareToken}`;
                
                // Show the share modal
                document.getElementById('shareLinkInput').value = shareUrl;
                document.getElementById('shareModal').classList.add('show');
                document.getElementById('shareCopyBtn').textContent = 'Copy';
                document.getElementById('shareCopyBtn').classList.remove('copied');
                
            } catch (error) {
                console.error('Error generating share link:', error);
                alert('Error generating share link: ' + error.message);
            }
        }
        
        function copyShareLink() {
            const input = document.getElementById('shareLinkInput');
            input.select();
            document.execCommand('copy');
            
            const btn = document.getElementById('shareCopyBtn');
            btn.textContent = 'Copied!';
            btn.classList.add('copied');
            
            setTimeout(() => {
                btn.textContent = 'Copy';
                btn.classList.remove('copied');
            }, 2000);
        }
        
        function closeShareModal() {
            document.getElementById('shareModal').classList.remove('show');
        }
        
        async function revokeShare() {
            if (!confirm('Revoke access? Anyone with the link will no longer be able to view or edit this deal.')) {
                return;
            }
            
            try {
                const { data, error } = await supabaseClient.rpc('revoke_share_token', {
                    p_deal_id: currentSharedDealCloudId
                });
                
                if (error) throw error;
                
                // Update local deal
                const deals = getLibrary();
                const deal = deals.find(d => d.cloud_id === currentSharedDealCloudId);
                if (deal) {
                    delete deal.share_token;
                    saveLibrary(deals);
                }
                
                closeShareModal();
                alert('Share link has been revoked.');
                
            } catch (error) {
                console.error('Error revoking share:', error);
                alert('Error revoking share: ' + error.message);
            }
        }
        
        async function checkForSharedDeal() {
            const urlParams = new URLSearchParams(window.location.search);
            const shareToken = urlParams.get('share');
            
            if (!shareToken) return;
            
            try {
                // Fetch the shared deal
                const { data, error } = await supabaseClient.rpc('get_deal_by_share_token', {
                    p_token: shareToken
                });
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    alert('Shared deal not found or link has expired.');
                    // Clear the URL parameter
                    window.history.replaceState({}, document.title, window.location.pathname);
                    return;
                }
                
                const sharedDeal = data[0];
                currentShareToken = shareToken;
                currentSharedDealCloudId = sharedDeal.id;
                
                // Convert cloud deal to local format and populate form
                const localDeal = cloudDealToLocal(sharedDeal);
                populateFormFromDeal(localDeal);
                calculate();
                
                // Show shared deal banner
                document.getElementById('sharedDealBanner').classList.add('show');
                
                // Hide auth modal if showing (allow anonymous access to shared deals)
                hideAuthModal();
                
            } catch (error) {
                console.error('Error loading shared deal:', error);
                alert('Error loading shared deal: ' + error.message);
            }
        }
        
        async function saveSharedDealChanges() {
            if (!currentShareToken) {
                alert('No shared deal loaded');
                return;
            }
            
            const btn = document.querySelector('.save-shared-btn');
            const originalText = btn.textContent;
            btn.textContent = ' Saving...';
            btn.disabled = true;
            
            try {
                const deal = buildDealObject();
                const cloudData = localDealToCloud(deal);
                
                const { data, error } = await supabaseClient.rpc('update_shared_deal', {
                    p_token: currentShareToken,
                    p_data: cloudData
                });
                
                if (error) throw error;
                
                btn.textContent = ' Saved!';
                btn.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '';
                    btn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('Error saving shared deal:', error);
                alert('Error saving changes: ' + error.message);
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // =============================================
        // GOAL FINDER FUNCTIONS
        // =============================================
        
        let goalSolution = null; // Store the solution for applying later

        function findGoalTerms() {
            // Get current fixed values from the form
            const askingPrice = parseFloat(document.getElementById('askingPrice').value) || 0;
            const rentalRevenue = parseFloat(document.getElementById('rentalRevenue').value) || 0;
            const category = document.getElementById('category').value;
            
            // Get operating expenses
            const propertyTax = parseFloat(document.getElementById('propertyTax').value) || 0;
            const insurance = parseFloat(document.getElementById('insurance').value) || 0;
            const hoa = parseFloat(document.getElementById('hoa').value) || 0;
            const otherExpenses = parseFloat(document.getElementById('otherExpenses').value) || 0;
            const capexPct = parseFloat(document.getElementById('capexPct').value) || 5;
            const managementPct = parseFloat(document.getElementById('managementPct').value) || 8;
            const vacancyPct = parseFloat(document.getElementById('vacancyPct').value) || 5;
            
            // Get goals
            const goalCapRate = parseFloat(document.getElementById('goalCapRate').value) / 100 || 0;
            const goalCashFlow = parseFloat(document.getElementById('goalCashFlow').value) || 0;
            const targetCashToSeller = parseFloat(document.getElementById('goalCashToSeller').value) || 0;
            
            // Positive spread is ALWAYS required (no checkbox)
            const requireSpread = true;
            
            // Get which variables can be adjusted
            const adjustPrice = document.getElementById('goalAdjustPrice').checked;
            const adjustSellerCarry = document.getElementById('goalAdjustSellerCarry').checked;
            const adjustLTV = document.getElementById('goalAdjustLTV').checked;
            const adjustSellerAmort = document.getElementById('goalAdjustSellerAmort').checked;
            
            // Seller rate is always 0% in equity carry (not adjustable)
            const sellerRate = 0;
            
            // Price constraints
            const minPrice = adjustPrice ? (parseFloat(document.getElementById('goalMinPrice').value) || askingPrice * 0.5) : askingPrice;
            const maxPrice = askingPrice || 1000000;
            
            // Calculate fixed expenses
            const fixedExpenses = propertyTax + insurance + hoa + otherExpenses;
            
            // Get rates based on category
            const firstPositionRate = getInterestRate(category);
            const firstPositionAmort = getAmortization(category);
            const currentSellerCarryAmort = parseInt(document.getElementById('sellerCarryAmort').value) || 30;
            
            // Validation
            if (rentalRevenue <= 0) {
                showGoalResults('failure', 'Please enter rental revenue first', null, []);
                return;
            }
            
            if (maxPrice <= 0) {
                showGoalResults('failure', 'Please enter an asking price first', null, []);
                return;
            }
            
            // Current values as defaults
            const currentPrice = parseFloat(document.getElementById('purchasePrice').value) || maxPrice;
            const currentSellerCarry = parseFloat(document.getElementById('sellerCarryPct').value) || 70;
            const currentLTV = parseFloat(document.getElementById('firstLoanLTV').value) || 26;
            
            // GRANULAR Variable ranges (1% increments for LTV and Seller Carry)
            const ltvValues = [];
            if (adjustLTV) {
                for (let ltv = 75; ltv >= 15; ltv--) {
                    ltvValues.push(ltv);
                }
            } else {
                ltvValues.push(currentLTV);
            }
            
            const sellerCarryValues = [];
            if (adjustSellerCarry) {
                for (let sc = 100; sc >= 40; sc--) {
                    sellerCarryValues.push(sc);
                }
            } else {
                sellerCarryValues.push(currentSellerCarry);
            }
            
            // Amortization values (min 30 years, realistic increments)
            const maxAmort = parseInt(document.getElementById('goalMaxAmort').value) || 99;
            const allAmortValues = [30, 35, 40, 45, 50, 60, 70, 80, 99];
            const sellerAmortValues = adjustSellerAmort 
                ? allAmortValues.filter(v => v <= maxAmort)
                : [currentSellerCarryAmort];
            
            // Price values (only if adjusting price - last resort)
            const priceValues = [];
            if (adjustPrice) {
                for (let pct = 100; pct >= 50; pct -= 1) {
                    const price = maxPrice * (pct / 100);
                    if (price >= minPrice) {
                        priceValues.push(price);
                    }
                }
            } else {
                priceValues.push(currentPrice);
            }
            
            // =============================================
            // SEARCH STRATEGY: Prioritized variable adjustment
            // 1. First try LTV + Seller Carry % combinations (at current amort & price)
            // 2. Then try adjusting amortization
            // 3. Finally try reducing price (last resort)
            // =============================================
            
            let bestSolution = null;
            let bestPartialSolution = null;
            
            // Helper function to evaluate a combination
            function evaluateCombination(purchasePrice, sellerCarryPct, firstLoanLTV, sellerCarryAmort) {
                // Check if seller carry + LTV meets minimum (115%) and maximum (145%)
                const totalFinancing = sellerCarryPct + firstLoanLTV;
                if (totalFinancing < 115) return null;
                if (totalFinancing > 145) return null;
                
                // Calculate cash to seller
                const cashToSeller = purchasePrice * (1 - sellerCarryPct / 100);
                
                // Must meet minimum cash to seller
                if (cashToSeller < targetCashToSeller * 0.99) return null; // 1% tolerance
                
                // Calculate full metrics
                const metrics = calculateMetrics({
                    purchasePrice,
                    rentalRevenue,
                    sellerCarryPct: sellerCarryPct / 100,
                    sellerRate: sellerRate / 100,
                    sellerCarryAmort,
                    firstLoanLTV: firstLoanLTV / 100,
                    firstPositionRate,
                    firstPositionAmort,
                    fixedExpenses,
                    capexPct: capexPct / 100,
                    managementPct: managementPct / 100,
                    vacancyPct: vacancyPct / 100
                });
                
                // Check all constraints
                const meetsCapRate = metrics.capRate >= goalCapRate;
                const meetsCashFlow = metrics.monthlyCashFlow >= goalCashFlow;
                const meetsCashToSeller = cashToSeller >= targetCashToSeller * 0.99;
                const meetsSpread = metrics.spread > 0;
                
                const meetsAll = meetsCapRate && meetsCashFlow && meetsCashToSeller && meetsSpread;
                
                return {
                    purchasePrice,
                    sellerCarryPct,
                    sellerRate,
                    firstLoanLTV,
                    sellerCarryAmort,
                    cashToSeller,
                    metrics,
                    meetsAll,
                    checks: { meetsCapRate, meetsCashFlow, meetsCashToSeller, meetsSpread },
                    metCount: [meetsCapRate, meetsCashFlow, meetsCashToSeller, meetsSpread].filter(Boolean).length
                };
            }
            
            // PHASE 1: Try LTV + Seller Carry at current price and amortization
            const phase1Amort = currentSellerCarryAmort >= 30 ? currentSellerCarryAmort : 30;
            
            for (const firstLoanLTV of ltvValues) {
                for (const sellerCarryPct of sellerCarryValues) {
                    const result = evaluateCombination(currentPrice, sellerCarryPct, firstLoanLTV, phase1Amort);
                    if (result) {
                        if (result.meetsAll) {
                            if (!bestSolution || result.cashToSeller < bestSolution.cashToSeller) {
                                // Prefer solution closest to target (not over by too much)
                                bestSolution = result;
                            }
                        } else if (!bestPartialSolution || result.metCount > bestPartialSolution.metCount) {
                            bestPartialSolution = result;
                        }
                    }
                }
                if (bestSolution) break; // Found a solution, stop searching
            }
            
            // PHASE 2: If no solution, try adjusting amortization (if enabled)
            if (!bestSolution && adjustSellerAmort) {
                for (const sellerCarryAmort of sellerAmortValues) {
                    if (sellerCarryAmort === phase1Amort) continue; // Already tried
                    
                    for (const firstLoanLTV of ltvValues) {
                        for (const sellerCarryPct of sellerCarryValues) {
                            const result = evaluateCombination(currentPrice, sellerCarryPct, firstLoanLTV, sellerCarryAmort);
                            if (result) {
                                if (result.meetsAll) {
                                    if (!bestSolution || result.cashToSeller < bestSolution.cashToSeller) {
                                        bestSolution = result;
                                    }
                                } else if (!bestPartialSolution || result.metCount > bestPartialSolution.metCount) {
                                    bestPartialSolution = result;
                                }
                            }
                        }
                    }
                    if (bestSolution) break;
                }
            }
            
            // PHASE 3: If still no solution, try reducing price (if enabled) - LAST RESORT
            if (!bestSolution && adjustPrice) {
                for (const purchasePrice of priceValues) {
                    if (purchasePrice === currentPrice) continue; // Already tried
                    
                    for (const sellerCarryAmort of sellerAmortValues) {
                        for (const firstLoanLTV of ltvValues) {
                            for (const sellerCarryPct of sellerCarryValues) {
                                const result = evaluateCombination(purchasePrice, sellerCarryPct, firstLoanLTV, sellerCarryAmort);
                                if (result) {
                                    if (result.meetsAll) {
                                        if (!bestSolution || result.purchasePrice > bestSolution.purchasePrice) {
                                            // Prefer highest price
                                            bestSolution = result;
                                        }
                                    } else if (!bestPartialSolution || result.metCount > bestPartialSolution.metCount) {
                                        bestPartialSolution = result;
                                    }
                                }
                            }
                        }
                    }
                    if (bestSolution) break; // Found solution at this price, don't go lower
                }
            }
            
            // Show results
            if (bestSolution) {
                goalSolution = bestSolution;
                
                showGoalResults('success', 'Solution Found!', bestSolution, [
                    { label: 'Cap Rate', met: true, value: formatPercent(bestSolution.metrics.capRate), goal: formatPercent(goalCapRate) },
                    { label: 'Monthly CF', met: true, value: formatCurrency(bestSolution.metrics.monthlyCashFlow), goal: formatCurrency(goalCashFlow) },
                    { label: 'Cash to Seller', met: true, value: formatCurrency(bestSolution.cashToSeller), goal: formatCurrency(targetCashToSeller) },
                    { label: 'Spread', met: true, value: formatPercent(bestSolution.metrics.spread), goal: 'Positive' }
                ]);
            } else if (bestPartialSolution) {
                goalSolution = bestPartialSolution;
                showGoalResults('partial', 'Best Possible Solution (Some Goals Unmet)', bestPartialSolution, [
                    { label: 'Cap Rate', met: bestPartialSolution.checks.meetsCapRate, value: formatPercent(bestPartialSolution.metrics.capRate), goal: formatPercent(goalCapRate) },
                    { label: 'Monthly CF', met: bestPartialSolution.checks.meetsCashFlow, value: formatCurrency(bestPartialSolution.metrics.monthlyCashFlow), goal: formatCurrency(goalCashFlow) },
                    { label: 'Cash to Seller', met: bestPartialSolution.checks.meetsCashToSeller, value: formatCurrency(bestPartialSolution.cashToSeller), goal: formatCurrency(targetCashToSeller) },
                    { label: 'Spread', met: bestPartialSolution.checks.meetsSpread, value: formatPercent(bestPartialSolution.metrics.spread), goal: 'Positive' }
                ]);
            } else {
                showGoalResults('failure', 'No solution found with current constraints', null, []);
            }
        }

        function calculateMetrics(params) {
            const {
                purchasePrice,
                rentalRevenue,
                sellerCarryPct,
                sellerRate,
                sellerCarryAmort,
                firstLoanLTV,
                firstPositionRate,
                firstPositionAmort,
                fixedExpenses,
                capexPct,
                managementPct,
                vacancyPct
            } = params;
            
            // Calculate variable expenses
            const capexExpense = rentalRevenue * capexPct;
            const managementExpense = rentalRevenue * managementPct;
            const vacancyExpense = rentalRevenue * vacancyPct;
            
            // Total expenses
            const totalExpenses = fixedExpenses + capexExpense + managementExpense + vacancyExpense;
            
            // NOI
            const noi = rentalRevenue - totalExpenses;
            
            // Cap Rate
            const capRate = purchasePrice > 0 ? noi / purchasePrice : 0;
            
            // Loan amounts
            const firstPositionLoan = purchasePrice * firstLoanLTV;
            const sellerCarryAmount = purchasePrice * sellerCarryPct;
            
            // Monthly payments
            let firstPositionPayment = 0;
            if (firstPositionLoan > 0) {
                const monthlyRate = firstPositionRate / 12;
                const numPayments = firstPositionAmort * 12;
                firstPositionPayment = firstPositionLoan * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
            }
            
            let sellerCarryPayment = 0;
            if (sellerCarryAmount > 0) {
                if (sellerRate === 0) {
                    sellerCarryPayment = sellerCarryAmount / (sellerCarryAmort * 12);
                } else {
                    const monthlyRate = sellerRate / 12;
                    const numPayments = sellerCarryAmort * 12;
                    sellerCarryPayment = sellerCarryAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
                }
            }
            
            // Annual debt service
            const annualDebtService = (firstPositionPayment + sellerCarryPayment) * 12;
            
            // Cash flow
            const annualCashFlow = noi - annualDebtService;
            const monthlyCashFlow = annualCashFlow / 12;
            
            // Blended rate
            const totalDebt = firstPositionLoan + sellerCarryAmount;
            const blendedRate = totalDebt > 0 
                ? (firstPositionLoan * firstPositionRate + sellerCarryAmount * sellerRate) / totalDebt 
                : 0;
            
            // Spread
            const spread = capRate - blendedRate;
            
            // Cash to buyer (down payment + costs)
            const downPayment = purchasePrice * (1 - firstLoanLTV - sellerCarryPct);
            const cashToBuyer = Math.max(0, downPayment);
            
            // Cash on Cash
            const cashOnCash = cashToBuyer > 0 ? annualCashFlow / cashToBuyer : 0;
            
            return {
                noi,
                capRate,
                monthlyCashFlow,
                annualCashFlow,
                cashOnCash,
                blendedRate,
                spread,
                cashToBuyer
            };
        }

        function showGoalResults(type, message, solution, metricChecks) {
            const resultsEl = document.getElementById('goalResults');
            const headerEl = document.getElementById('goalResultsHeader');
            const gridEl = document.getElementById('goalResultsGrid');
            const metricsEl = document.getElementById('goalMetricsAchieved');
            
            resultsEl.className = 'goal-results show ' + type;
            
            const icon = type === 'success' ? '' : type === 'partial' ? '' : '';
            headerEl.innerHTML = `<span>${icon}</span><span>${message}</span>`;
            
            if (solution) {
                const currentPrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
                const currentSellerCarry = parseFloat(document.getElementById('sellerCarryPct').value) || 0;
                const currentSellerRate = parseFloat(document.getElementById('sellerCarryRate').value) || 0;
                const currentLTV = parseFloat(document.getElementById('firstLoanLTV').value) || 0;
                const currentSellerAmort = parseInt(document.getElementById('sellerCarryAmort').value) || 30;
                const askingPrice = parseFloat(document.getElementById('askingPrice').value) || 0;
                
                // Calculate percent of asking
                const pctOfAsking = askingPrice > 0 ? (solution.purchasePrice / askingPrice * 100).toFixed(1) : 0;
                
                gridEl.innerHTML = `
                    <div class="goal-result-item">
                        <div class="goal-result-label">Purchase Price</div>
                        <div class="goal-result-value ${solution.purchasePrice !== currentPrice ? 'changed' : ''}">${formatCurrency(solution.purchasePrice)}</div>
                        <div class="goal-result-note">${pctOfAsking}% of asking</div>
                    </div>
                    <div class="goal-result-item">
                        <div class="goal-result-label">Seller Carry</div>
                        <div class="goal-result-value ${solution.sellerCarryPct !== currentSellerCarry ? 'changed' : ''}">${solution.sellerCarryPct.toFixed(0)}%</div>
                    </div>
                    <div class="goal-result-item">
                        <div class="goal-result-label">Seller Rate</div>
                        <div class="goal-result-value ${solution.sellerRate !== currentSellerRate ? 'changed' : ''}">${solution.sellerRate.toFixed(1)}%</div>
                    </div>
                    <div class="goal-result-item">
                        <div class="goal-result-label">Seller Amortization</div>
                        <div class="goal-result-value ${solution.sellerCarryAmort !== currentSellerAmort ? 'changed' : ''}">${solution.sellerCarryAmort} yrs</div>
                    </div>
                    <div class="goal-result-item">
                        <div class="goal-result-label">First Position LTV</div>
                        <div class="goal-result-value ${solution.firstLoanLTV !== currentLTV ? 'changed' : ''}">${solution.firstLoanLTV.toFixed(0)}%</div>
                    </div>
                    <div class="goal-result-item">
                        <div class="goal-result-label">Cash to Seller</div>
                        <div class="goal-result-value">${formatCurrency(solution.cashToSeller)}</div>
                    </div>
                `;
                
                metricsEl.innerHTML = metricChecks.map(m => `
                    <div class="goal-metric-badge ${m.met ? 'met' : 'unmet'}">
                        <span>${m.met ? '' : ''}</span>
                        <span>${m.label}: ${m.value}</span>
                        <span class="goal-metric-target">(${m.label === 'Cash to Seller' ? 'target' : 'min'}: ${m.goal})</span>
                    </div>
                `).join('');
                
                document.querySelector('.goal-apply-btn').style.display = 'flex';
            } else {
                gridEl.innerHTML = '<p style="color: var(--text-secondary);">Try adjusting your goals or enabling more variables to adjust.</p>';
                metricsEl.innerHTML = '';
                document.querySelector('.goal-apply-btn').style.display = 'none';
            }
        }

        function applyGoalTerms() {
            if (!goalSolution) return;
            
            document.getElementById('purchasePrice').value = Math.round(goalSolution.purchasePrice);
            document.getElementById('sellerCarryPct').value = goalSolution.sellerCarryPct.toFixed(1);
            document.getElementById('sellerCarryRate').value = goalSolution.sellerRate.toFixed(1);
            document.getElementById('sellerCarryAmort').value = goalSolution.sellerCarryAmort;
            document.getElementById('firstLoanLTV').value = goalSolution.firstLoanLTV.toFixed(1);
            
            calculate();
            
            // Scroll to results
            document.querySelector('.results-grid').scrollIntoView({ behavior: 'smooth' });
            
            // Flash the results to show they updated
            const resultsSection = document.querySelector('.results-grid');
            resultsSection.style.transition = 'box-shadow 0.3s';
            resultsSection.style.boxShadow = '0 0 20px rgba(20, 184, 166, 0.5)';
            setTimeout(() => {
                resultsSection.style.boxShadow = '';
            }, 1500);
        }

        // Generate AI Prompt
        function generatePrompt() {
            const address = getFullAddress();
            const category = document.getElementById('category').value;
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
            const askingPrice = parseFloat(document.getElementById('askingPrice').value) || 0;
            const rentalRevenue = parseFloat(document.getElementById('rentalRevenue').value) || 0;
            const firstLoanLTV = parseFloat(document.getElementById('firstLoanLTV').value) || 0;
            const sellerCarryPct = parseFloat(document.getElementById('sellerCarryPct').value) || 0;
            const sellerCarryRate = parseFloat(document.getElementById('sellerCarryRate').value) || 0;
            const yearsToBalloon = parseInt(document.getElementById('yearsToBalloon').value) || 0;
            
            // Get calculated values
            const capRate = document.getElementById('capRate').textContent;
            const blendedRate = document.getElementById('blendedRate').textContent;
            const spread = document.getElementById('capBlendedSpread').textContent;
            const cashFlow = document.getElementById('annualCashFlow').textContent;
            const cocReturn = document.getElementById('cocReturn').textContent;
            const cashToBuyer = document.getElementById('cashToBuyer').textContent;

            const prompt = `I'm analyzing a real estate deal using an equity carry / capital stacking strategy. Please help me evaluate this deal and research the local market.

PROPERTY & DEAL DETAILS:
- Address: ${address}
- Property Type: ${category}
- Purchase Price: $${purchasePrice.toLocaleString()}
- Asking Price: $${askingPrice.toLocaleString()}
- Expected Annual Rent: $${rentalRevenue.toLocaleString()} ($${Math.round(rentalRevenue/12).toLocaleString()}/month)

FINANCING STRUCTURE:
- First Position Loan: ${firstLoanLTV}% LTV (from traditional lender)
- Seller Carry: ${sellerCarryPct}% of purchase price at ${sellerCarryRate}% interest
- Years to Balloon: ${yearsToBalloon}

CALCULATED METRICS:
- Cap Rate: ${capRate}
- Blended Interest Rate: ${blendedRate}
- Spread (Cap Rate - Blended Rate): ${spread}
- Annual Cash Flow: ${cashFlow}
- Cash-on-Cash Return: ${cocReturn}
- Cash to Buyer at Close: ${cashToBuyer}

PLEASE ANALYZE:

1. DEAL VIABILITY
- Does this deal make sense from a capital stacking perspective?
- Is the spread between cap rate and blended rate healthy?
- Are the returns acceptable for this strategy?
- What are the risks?

2. MARKET RESEARCH (please search for current data)
- What are typical rents for similar properties in this area?
- Is my expected rent realistic, too high, or too low?
- What's the rental vacancy rate in this market?
- Is this area appreciating, stable, or declining?
- Is it currently a buyer's or seller's market?

3. RECOMMENDATION
- Would you proceed with this deal? Why or why not?
- What terms would you try to negotiate differently?
- Any red flags I should investigate further?

Please be direct and specific with your analysis.`;

            const promptSection = document.getElementById('promptSection');
            promptSection.innerHTML = `
                <div class="prompt-output-container">
                    <div class="prompt-output">${prompt}</div>
                    <div class="prompt-actions">
                        <button class="copy-btn" onclick="copyPrompt()">
                            <span></span> Copy to Clipboard
                        </button>
                    </div>
                    <div class="prompt-tip">
                         Paste this into ChatGPT, Claude, or any AI assistant with web search for the best results.
                    </div>
                </div>
            `;
        }

        function copyPrompt() {
            const promptText = document.querySelector('.prompt-output').textContent;
            navigator.clipboard.writeText(promptText).then(() => {
                const btn = document.querySelector('.copy-btn');
                btn.innerHTML = '<span></span> Copied!';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.innerHTML = '<span></span> Copy to Clipboard';
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        // Get full formatted address from individual fields
        function getFullAddress() {
            const street = document.getElementById('streetAddress').value.trim();
            const city = document.getElementById('city').value.trim();
            const state = document.getElementById('state').value.trim().toUpperCase();
            const zip = document.getElementById('zip').value.trim();
            
            let parts = [];
            if (street) parts.push(street);
            if (city) parts.push(city);
            if (state && zip) {
                parts.push(`${state} ${zip}`);
            } else if (state) {
                parts.push(state);
            } else if (zip) {
                parts.push(zip);
            }
            
            return parts.join(', ') || '[PROPERTY ADDRESS]';
        }

        // Parse old single-field address into components
        function parseOldAddress(address) {
            const result = { street: '', city: '', state: '', zip: '' };
            if (!address) return result;
            
            // Try to parse format: "123 Main St, City, ST 12345" or "123 Main St, City, ST"
            const parts = address.split(',').map(p => p.trim());
            
            if (parts.length >= 1) {
                result.street = parts[0];
            }
            if (parts.length >= 2) {
                result.city = parts[1];
            }
            if (parts.length >= 3) {
                // Last part might be "ST 12345" or "State 12345" or just "ST"
                const lastPart = parts[parts.length - 1];
                const match = lastPart.match(/^([A-Z]{2})\s*(\d{5}(-\d{4})?)?$/i);
                if (match) {
                    result.state = match[1].toUpperCase();
                    result.zip = match[2] || '';
                } else {
                    // Maybe just state or something else
                    const stateMatch = lastPart.match(/^([A-Z]{2})$/i);
                    if (stateMatch) {
                        result.state = stateMatch[1].toUpperCase();
                    }
                }
                // If city was actually in position 2 and state+zip in position 3
                if (parts.length === 3 && result.city) {
                    // Already handled
                } else if (parts.length > 3) {
                    // Might have extra commas, combine middle parts as city
                    result.city = parts.slice(1, -1).join(', ');
                }
            }
            
            return result;
        }

        // Deal Library Functions (Local Storage)
        function getLibrary() {
            const stored = localStorage.getItem('dealLibrary');
            return stored ? JSON.parse(stored) : [];
        }

        function saveLibrary(deals) {
            localStorage.setItem('dealLibrary', JSON.stringify(deals));
        }

        // Track currently loaded deal for update vs create
        let currentLoadedDealId = null;

        async function saveToLibrary() {
            const btn = document.querySelector('.library-btn');
            const originalText = btn.innerHTML;
            
            try {
                // Show saving state
                btn.innerHTML = '<span></span> Saving...';
                btn.disabled = true;
                
                const deal = buildDealObject();
                
                // Validate minimum required fields
                const hasAddress = deal.propertyInfo?.streetAddress || deal.propertyInfo?.city;
                const hasPrice = deal.dealTerms?.purchasePrice > 0;
                
                if (!hasAddress && !hasPrice) {
                    alert('Please enter at least an address or purchase price before saving.');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }
                
                let deals = getLibrary();
                let existingDeal = null;
                let saveAsCopy = false;
                let isNewAddress = false;
                
                // Check if we're working with an existing deal
                if (currentLoadedDealId) {
                    existingDeal = deals.find(d => String(d.id) === String(currentLoadedDealId));
                    if (existingDeal) {
                        // Check if the address has changed significantly
                        const currentAddress = getAddressFromParts(deal.propertyInfo);
                        const originalAddress = existingDeal.originalAddress || getAddressFromParts(existingDeal.propertyInfo);
                        
                        // Compare street addresses (most important identifier)
                        const currentStreet = (deal.propertyInfo?.streetAddress || '').toLowerCase().trim();
                        const originalStreet = (existingDeal.propertyInfo?.streetAddress || '').toLowerCase().trim();
                        
                        // If street address changed, treat as a new deal
                        if (currentStreet && originalStreet && currentStreet !== originalStreet) {
                            isNewAddress = true;
                            existingDeal = null;
                            currentLoadedDealId = null;
                        }
                    }
                }
                
                // Only show overwrite/copy dialog if address hasn't changed
                if (existingDeal) {
                    // Ask user: update or copy?
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    
                    // Get the base address for the copy name preview
                    const baseAddress = existingDeal.originalAddress || getAddressFromParts(existingDeal.propertyInfo);
                    const result = await showSaveChoiceDialog(baseAddress);
                    
                    if (result.choice === 'cancel') {
                        return;
                    }
                    saveAsCopy = (result.choice === 'copy');
                    
                    // Store the copy name if provided
                    if (saveAsCopy && result.copyName) {
                        deal.copyName = result.copyName;
                    }
                    
                    btn.innerHTML = '<span></span> Saving...';
                    btn.disabled = true;
                }
                
                if (existingDeal && !saveAsCopy) {
                    // Update existing deal
                    deal.id = existingDeal.id;
                    deal.savedAt = existingDeal.savedAt; // Preserve original created date
                    deal.updatedAt = new Date().toISOString();
                    deal.cloud_id = existingDeal.cloud_id;
                    deal.share_token = existingDeal.share_token;
                    
                    // Update in cloud
                    if (currentUser && deal.cloud_id) {
                        try {
                            await Promise.race([
                                updateInCloud(deal),
                                new Promise((_, reject) => setTimeout(() => reject(new Error('Cloud sync timeout')), 10000))
                            ]);
                        } catch (cloudError) {
                            console.warn('Cloud update failed, saved locally:', cloudError);
                        }
                    } else if (currentUser && !deal.cloud_id) {
                        try {
                            const cloudResult = await Promise.race([
                                saveToCloud(deal),
                                new Promise((_, reject) => setTimeout(() => reject(new Error('Cloud sync timeout')), 10000))
                            ]);
                            if (cloudResult) {
                                deal.cloud_id = cloudResult.id;
                            }
                        } catch (cloudError) {
                            console.warn('Cloud save failed, saved locally:', cloudError);
                        }
                    }
                    
                    // Replace in local array
                    const index = deals.findIndex(d => String(d.id) === String(deal.id));
                    if (index !== -1) {
                        deals[index] = deal;
                    }
                    
                    saveLibrary(deals);
                    renderLibrary();
                    
                    btn.innerHTML = '<span></span> Updated!';
                } else {
                    // Create new deal (or copy)
                    deal.id = Date.now();
                    
                    if (saveAsCopy) {
                        // Get the ORIGINAL address (not the copy's address)
                        const originalAddress = existingDeal.originalAddress || getAddressFromParts(existingDeal.propertyInfo);
                        deal.originalAddress = originalAddress; // Store original for reference
                        
                        // Use custom name if provided, otherwise use copy number
                        if (!deal.copyName) {
                            const copyNumber = getNextCopyNumber(deals, originalAddress);
                            deal.copyNumber = copyNumber;
                        }
                    }
                    
                    currentLoadedDealId = deal.id; // Track as current deal
                    
                    // Save to cloud (with timeout)
                    if (currentUser) {
                        try {
                            const cloudResult = await Promise.race([
                                saveToCloud(deal),
                                new Promise((_, reject) => setTimeout(() => reject(new Error('Cloud sync timeout')), 10000))
                            ]);
                            if (cloudResult) {
                                deal.cloud_id = cloudResult.id;
                            }
                        } catch (cloudError) {
                            console.warn('Cloud save failed, saved locally:', cloudError);
                        }
                    }
                    
                    deals.unshift(deal); // Add to beginning
                    
                    saveLibrary(deals);
                    renderLibrary();
                    
                    btn.innerHTML = saveAsCopy ? '<span></span> Copy Saved!' : '<span></span> Saved!';
                }
                
                btn.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
                btn.disabled = false;
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.background = '';
                }, 2000);
                
            } catch (error) {
                console.error('Error saving deal:', error);
                alert('Error saving deal: ' + error.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        let saveChoiceResolver = null;
        let currentCopyBaseAddress = null;
        
        function showSaveChoiceDialog(baseAddress) {
            currentCopyBaseAddress = baseAddress;
            return new Promise((resolve) => {
                saveChoiceResolver = resolve;
                document.getElementById('saveChoiceModal').classList.add('show');
            });
        }
        
        function resolveSaveChoice(choice) {
            document.getElementById('saveChoiceModal').classList.remove('show');
            if (saveChoiceResolver) {
                saveChoiceResolver({ choice: choice, copyName: null });
                saveChoiceResolver = null;
            }
        }
        
        function showCopyNameInput() {
            document.getElementById('saveChoiceModal').classList.remove('show');
            document.getElementById('copyNamePreview').textContent = currentCopyBaseAddress + ' - ';
            document.getElementById('copyNameInput').value = '';
            document.getElementById('copyNameModal').classList.add('show');
            document.getElementById('copyNameInput').focus();
        }
        
        function closeCopyNameModal() {
            document.getElementById('copyNameModal').classList.remove('show');
            document.getElementById('saveChoiceModal').classList.add('show');
        }
        
        function confirmCopyName() {
            const copyName = document.getElementById('copyNameInput').value.trim();
            document.getElementById('copyNameModal').classList.remove('show');
            if (saveChoiceResolver) {
                saveChoiceResolver({ choice: 'copy', copyName: copyName || null });
                saveChoiceResolver = null;
            }
        }
        
        // Close modal if clicking outside
        document.addEventListener('click', function(e) {
            if (e.target.id === 'saveChoiceModal') {
                resolveSaveChoice('cancel');
            }
            if (e.target.id === 'copyNameModal') {
                closeCopyNameModal();
            }
        });
        
        // Handle Enter key in copy name input
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                if (document.getElementById('copyNameModal').classList.contains('show')) {
                    closeCopyNameModal();
                } else if (document.getElementById('saveChoiceModal').classList.contains('show')) {
                    resolveSaveChoice('cancel');
                }
            }
            if (e.key === 'Enter' && document.getElementById('copyNameModal').classList.contains('show')) {
                confirmCopyName();
            }
        });
        
        function getNextCopyNumber(deals, baseFullAddress) {
            // Find the highest copy number for deals with matching address
            let maxCopyNum = 0;
            
            deals.forEach(d => {
                const dealAddress = d.propertyInfo?.address || getAddressFromParts(d.propertyInfo) || '';
                const originalAddr = d.originalAddress || dealAddress;
                
                // Check if this deal matches the base address (either directly or via originalAddress)
                if (dealAddress === baseFullAddress || originalAddr === baseFullAddress) {
                    // This is either the original or a copy of it
                    const copyNum = d.copyNumber || 0;
                    maxCopyNum = Math.max(maxCopyNum, copyNum);
                }
            });
            
            return maxCopyNum + 1;
        }
        
        function clearCurrentDeal() {
            currentLoadedDealId = null;
        }

        function loadFromLibrary(dealId) {
            const deals = getLibrary();
            const deal = deals.find(d => String(d.id) === String(dealId));
            if (deal) {
                currentLoadedDealId = deal.id; // Track which deal is loaded
                populateFormFromDeal(deal);
                // Scroll to top to see the form
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        async function deleteFromLibrary(dealId) {
            if (!confirm('Delete this deal from your library?')) return;
            
            let deals = getLibrary();
            const dealToDelete = deals.find(d => String(d.id) === String(dealId));
            
            // Delete from cloud if it has a cloud_id
            if (dealToDelete?.cloud_id) {
                await deleteFromCloud(dealToDelete.cloud_id);
            }
            
            deals = deals.filter(d => String(d.id) !== String(dealId));
            saveLibrary(deals);
            renderLibrary();
        }

        let currentEmailDealId = null;
        let currentRenameDealId = null;
        
        // Email Edge Function URL
        const EMAIL_FUNCTION_URL = SUPABASE_URL + '/functions/v1/send-offer-email';
        
        function emailOffer(dealId) {
            currentEmailDealId = dealId;
            const deals = getLibrary();
            const deal = deals.find(d => String(d.id) === String(dealId));
            
            if (!deal) {
                console.error('Deal not found:', dealId);
                return;
            }
            
            // Pre-fill with seller info if available
            const sellerEmail = deal.seller?.email || '';
            const sellerName = deal.seller?.name || '';
            
            document.getElementById('emailRecipientAddress').value = sellerEmail;
            document.getElementById('emailRecipientName').value = sellerName;
            
            // Reset status
            const statusEl = document.getElementById('emailStatus');
            statusEl.style.display = 'none';
            document.getElementById('emailSendBtn').disabled = false;
            
            // Show modal
            document.getElementById('emailOfferModal').classList.add('show');
            document.getElementById('emailRecipientAddress').focus();
        }
        
        function closeEmailModal() {
            document.getElementById('emailOfferModal').classList.remove('show');
            currentEmailDealId = null;
        }
        
        function updateEmailStatus(type, message) {
            const statusEl = document.getElementById('emailStatus');
            statusEl.style.display = 'flex';
            statusEl.className = 'email-status ' + type;
            
            const icons = { sending: '', success: '', error: '' };
            statusEl.querySelector('.email-status-icon').textContent = icons[type] || '';
            statusEl.querySelector('.email-status-text').textContent = message;
        }
        
        async function sendOfferEmail() {
            const recipientEmail = document.getElementById('emailRecipientAddress').value.trim();
            const recipientName = document.getElementById('emailRecipientName').value.trim() || 'Property Owner';
            
            if (!recipientEmail) {
                alert('Please enter a recipient email address');
                return;
            }
            
            if (!recipientEmail.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }
            
            const deals = getLibrary();
            const deal = deals.find(d => String(d.id) === String(currentEmailDealId));
            
            if (!deal) {
                alert('Deal not found');
                closeEmailModal();
                return;
            }
            
            // Disable button and show sending status
            document.getElementById('emailSendBtn').disabled = true;
            updateEmailStatus('sending', 'Generating PDFs and sending email...');
            
            try {
                // Build the data payload
                const purchasePrice = parseFloat(deal.dealTerms?.purchasePrice) || 0;
                const sellerCarryPct = parseFloat(deal.loanConfig?.sellerCarryPct) || 0;
                const sellerCarryAmount = purchasePrice * (sellerCarryPct / 100);
                const cashToSeller = purchasePrice - sellerCarryAmount;
                const sellerCarryRate = parseFloat(deal.sellerFinancing?.rate) || 0;
                const sellerCarryAmort = parseInt(deal.sellerFinancing?.amortization) || 30;
                const yearsToBalloon = parseInt(deal.loanConfig?.yearsToBalloon) || 8;
                
                // Calculate monthly payment
                let monthlyPayment = 0;
                if (sellerCarryAmount > 0) {
                    if (sellerCarryRate === 0) {
                        monthlyPayment = sellerCarryAmount / (sellerCarryAmort * 12);
                    } else {
                        const monthlyRate = sellerCarryRate / 100 / 12;
                        const numPayments = sellerCarryAmort * 12;
                        monthlyPayment = sellerCarryAmount * (monthlyRate * Math.pow(1 + monthlyRate, numPayments)) / (Math.pow(1 + monthlyRate, numPayments) - 1);
                    }
                }
                
                const propertyAddress = [
                    deal.propertyInfo?.streetAddress,
                    deal.propertyInfo?.city,
                    deal.propertyInfo?.state,
                    deal.propertyInfo?.zip
                ].filter(Boolean).join(', ');
                
                const payload = {
                    recipientEmail,
                    recipientName,
                    propertyAddress,
                    propertyLink: deal.propertyInfo?.propertyLink || '',
                    preparer: {
                        name: deal.preparer?.name || '',
                        email: deal.preparer?.email || '',
                        phone: deal.preparer?.phone || ''
                    },
                    seller: {
                        name: deal.seller?.name || '',
                        email: deal.seller?.email || '',
                        phone: deal.seller?.phone || ''
                    },
                    financials: {
                        purchasePrice,
                        askingPrice: parseFloat(deal.dealTerms?.askingPrice) || purchasePrice,
                        cashToSeller,
                        sellerCarryAmount,
                        sellerCarryPct,
                        sellerCarryRate,
                        sellerCarryAmort,
                        monthlyPayment,
                        yearsToBalloon,
                        firstPositionLoan: parseFloat(deal.firstPosition?.loanAmount) || 0,
                        firstPositionRate: parseFloat(deal.firstPosition?.rate) || 0,
                        firstPositionAmort: parseInt(deal.firstPosition?.amortization) || 30,
                        firstPositionPayment: parseFloat(deal.firstPosition?.payment) || 0,
                        downPayment: parseFloat(deal.loanConfig?.downPaymentPct) || 0,
                        totalFinancingPct: parseFloat(deal.loanConfig?.totalFinancingPct) || 100,
                        noi: parseFloat(deal.metrics?.noi) || 0,
                        capRate: parseFloat(deal.metrics?.capRate) || 0,
                        blendedRate: parseFloat(deal.metrics?.blendedRate) || 0,
                        spread: parseFloat(deal.metrics?.spread) || 0,
                        annualCashFlow: parseFloat(deal.metrics?.annualCashFlow) || 0,
                        monthlyCashFlow: parseFloat(deal.metrics?.monthlyCashFlow) || 0,
                        cocReturn: parseFloat(deal.metrics?.cocReturn) || 0,
                        valueAtBalloon: parseFloat(deal.metrics?.valueAtBalloon) || 0,
                        balanceAtBalloon: parseFloat(deal.metrics?.balanceAtBalloon) || 0,
                        equityAtBalloon: parseFloat(deal.metrics?.equityAtBalloon) || 0,
                        equityPctBalloon: parseFloat(deal.metrics?.equityPctBalloon) || 0
                    }
                };
                
                // Call the Edge Function
                const response = await fetch(EMAIL_FUNCTION_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    updateEmailStatus('success', 'Email sent successfully!');
                    
                    // Update deal status to LOI Sent
                    const dealIndex = deals.findIndex(d => String(d.id) === String(currentEmailDealId));
                    if (dealIndex !== -1 && deals[dealIndex].status === 'working') {
                        deals[dealIndex].status = 'loi-sent';
                        deals[dealIndex].updatedAt = new Date().toISOString();
                        saveLibrary(deals);
                        renderLibrary();
                    }
                    
                    // Close modal after a delay
                    setTimeout(() => {
                        closeEmailModal();
                    }, 2000);
                } else {
                    throw new Error(result.error || 'Failed to send email');
                }
                
            } catch (error) {
                console.error('Email error:', error);
                updateEmailStatus('error', error.message || 'Failed to send email');
                document.getElementById('emailSendBtn').disabled = false;
            }
        }
        
        // Status options in order for cycling
        const STATUS_ORDER = ['working', 'loi-sent', 'loi-countered', 'loi-signed', 'won', 'rejected', 'obe'];
        const STATUS_LABELS = {
            working: ' Working',
            'loi-sent': ' LOI Sent',
            'loi-countered': ' LOI Countered',
            'loi-signed': ' LOI Signed',
            won: ' Won',
            rejected: ' Rejected',
            obe: ' OBE'
        };
        
        function getStatusDisplay(status) {
            return STATUS_LABELS[status] || STATUS_LABELS.working;
        }
        
        async function cycleStatus(dealId) {
            let deals = getLibrary();
            const dealIndex = deals.findIndex(d => String(d.id) === String(dealId));
            
            if (dealIndex === -1) return;
            
            const deal = deals[dealIndex];
            const currentStatus = deal.status || 'working';
            const currentIndex = STATUS_ORDER.indexOf(currentStatus);
            const nextIndex = (currentIndex + 1) % STATUS_ORDER.length;
            
            deal.status = STATUS_ORDER[nextIndex];
            deal.updatedAt = new Date().toISOString();
            
            deals[dealIndex] = deal;
            saveLibrary(deals);
            
            // Sync to cloud
            if (currentUser && deal.cloud_id) {
                try {
                    await Promise.race([
                        updateInCloud(deal),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('timeout')), 10000))
                    ]);
                } catch (e) {
                    console.warn('Cloud sync failed:', e);
                }
            }
            
            renderLibrary();
        }
        
        function renameDeal(dealId) {
            currentRenameDealId = dealId;
            const deals = getLibrary();
            const deal = deals.find(d => String(d.id) === String(dealId));
            
            if (!deal) {
                console.error('Deal not found:', dealId);
                return;
            }
            
            // Get the base address
            const baseAddress = deal.originalAddress || getAddressFromParts(deal.propertyInfo);
            document.getElementById('renameAddressPreview').textContent = baseAddress;
            
            // Pre-fill with current custom name if exists
            document.getElementById('renameDealInput').value = deal.copyName || '';
            
            // Show modal
            document.getElementById('renameDealModal').classList.add('show');
            document.getElementById('renameDealInput').focus();
        }
        
        function closeRenameModal() {
            document.getElementById('renameDealModal').classList.remove('show');
            currentRenameDealId = null;
        }
        
        async function confirmRename() {
            const newName = document.getElementById('renameDealInput').value.trim();
            
            let deals = getLibrary();
            const dealIndex = deals.findIndex(d => String(d.id) === String(currentRenameDealId));
            
            if (dealIndex === -1) {
                console.error('Deal not found');
                closeRenameModal();
                return;
            }
            
            const deal = deals[dealIndex];
            
            // Update the name
            if (newName) {
                deal.copyName = newName;
                deal.copyNumber = null; // Clear copy number if using custom name
            } else {
                deal.copyName = null;
                // If this was a copy, restore the copy number or leave as original
            }
            
            deal.updatedAt = new Date().toISOString();
            
            // Save locally
            deals[dealIndex] = deal;
            saveLibrary(deals);
            
            // Sync to cloud if logged in
            if (currentUser && deal.cloud_id) {
                try {
                    await Promise.race([
                        updateInCloud(deal),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('Cloud sync timeout')), 10000))
                    ]);
                } catch (cloudError) {
                    console.warn('Cloud update failed:', cloudError);
                }
            }
            
            renderLibrary();
            closeRenameModal();
        }
        
        // Handle Enter key in rename input
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && document.getElementById('renameDealModal').classList.contains('show')) {
                confirmRename();
            }
            if (e.key === 'Escape' && document.getElementById('renameDealModal').classList.contains('show')) {
                closeRenameModal();
            }
        });

        function renderLibrary() {
            let deals = getLibrary();
            const listEl = document.getElementById('libraryList');
            const statsEl = document.getElementById('libraryStats');
            const searchTerm = document.getElementById('librarySearch')?.value?.toLowerCase() || '';
            const sortBy = document.getElementById('librarySort')?.value || 'modified-desc';
            
            // Filter by search term
            if (searchTerm) {
                deals = deals.filter(deal => {
                    const address = (deal.propertyInfo?.address || '').toLowerCase();
                    const street = (deal.propertyInfo?.streetAddress || '').toLowerCase();
                    const city = (deal.propertyInfo?.city || '').toLowerCase();
                    const state = (deal.propertyInfo?.state || '').toLowerCase();
                    const seller = (deal.seller?.name || '').toLowerCase();
                    return address.includes(searchTerm) || 
                           street.includes(searchTerm) || 
                           city.includes(searchTerm) || 
                           state.includes(searchTerm) || 
                           seller.includes(searchTerm);
                });
            }
            
            // Sort deals
            deals = sortDeals(deals, sortBy);
            
            // Update stats
            const totalDeals = getLibrary().length;
            const shownDeals = deals.length;
            statsEl.textContent = searchTerm 
                ? `Showing ${shownDeals} of ${totalDeals} deals`
                : `${totalDeals} deal${totalDeals !== 1 ? 's' : ''} in library`;
            
            if (deals.length === 0) {
                listEl.innerHTML = searchTerm 
                    ? '<p class="library-empty">No deals match your search.</p>'
                    : '<p class="library-empty">No deals saved yet. Click "Save Deal to Library" to add one.</p>';
                return;
            }
            
            // Determine date column header based on sort
            const isModifiedSort = sortBy.startsWith('modified');
            const dateHeader = isModifiedSort ? 'Modified' : 'Created';
            
            // Build table header + rows
            const tableHeader = `
                <div class="library-table-header">
                    <span>Address</span>
                    <span>${dateHeader}</span>
                    <span>Seller</span>
                    <span>Status</span>
                    <span>Actions</span>
                </div>
            `;
            
            const tableRows = deals.map(deal => {
                let address = deal.propertyInfo?.address || getAddressFromParts(deal.propertyInfo) || 'Untitled Deal';
                
                // Add custom copy name or copy number if this is a copy
                if (deal.copyName) {
                    address = `${address} - ${deal.copyName}`;
                } else if (deal.copyNumber) {
                    address = `${address} (${deal.copyNumber})`;
                }
                
                // Show modified or created date based on sort
                const dateValue = isModifiedSort 
                    ? (deal.updatedAt || deal.savedAt) 
                    : deal.savedAt;
                const date = dateValue ? new Date(dateValue).toLocaleString([], {dateStyle: 'short', timeStyle: 'short'}) : '';
                const seller = deal.seller?.name || '';
                
                // Status with emoji and label
                const status = deal.status || 'working';
                const statusDisplay = getStatusDisplay(status);
                
                return `
                    <div class="library-item">
                        <div class="library-item-address" onclick="loadFromLibrary('${deal.id}')" title="Click to load deal">${address}</div>
                        <div class="library-item-date">${date}</div>
                        <div class="library-item-seller" title="${seller}">${seller}</div>
                        <div class="library-item-status" onclick="cycleStatus('${deal.id}')" title="Click to change status">
                            <span class="status-badge status-${status}">${statusDisplay}</span>
                        </div>
                        <div class="library-item-actions">
                            <button class="library-item-share" onclick="shareDeal('${deal.id}')" title="Share deal link">
                                <span></span>
                            </button>
                            <button class="library-item-rename" onclick="renameDeal('${deal.id}')" title="Rename deal">
                                <span></span>
                            </button>
                            <button class="library-item-email" onclick="emailOffer('${deal.id}')" title="Email offer">
                                <span></span> Email
                            </button>
                            <button class="library-item-delete" onclick="deleteFromLibrary('${deal.id}')" title="Delete"></button>
                        </div>
                    </div>
                `;
            }).join('');
            
            listEl.innerHTML = tableHeader + tableRows;
        }

        function getAddressFromParts(propertyInfo) {
            if (!propertyInfo) return '';
            const parts = [];
            if (propertyInfo.streetAddress) parts.push(propertyInfo.streetAddress);
            if (propertyInfo.city) parts.push(propertyInfo.city);
            if (propertyInfo.state && propertyInfo.zip) {
                parts.push(`${propertyInfo.state} ${propertyInfo.zip}`);
            } else if (propertyInfo.state) {
                parts.push(propertyInfo.state);
            }
            return parts.join(', ');
        }

        function parseAddress(address) {
            // Try to extract city and state from address
            // Typical format: "123 Main St, City, ST 12345" or "123 Main St, City, State"
            const parts = address.split(',').map(p => p.trim());
            let city = '';
            let state = '';
            
            if (parts.length >= 2) {
                city = parts[parts.length - 2] || '';
                // State might be "ST 12345" or just "ST"
                const lastPart = parts[parts.length - 1] || '';
                const stateMatch = lastPart.match(/^([A-Z]{2})\b/i);
                if (stateMatch) {
                    state = stateMatch[1].toUpperCase();
                }
            }
            
            return { city, state };
        }

        function sortDeals(deals, sortBy) {
            return [...deals].sort((a, b) => {
                switch (sortBy) {
                    case 'modified-desc':
                        return new Date(b.updatedAt || b.savedAt || 0) - new Date(a.updatedAt || a.savedAt || 0);
                    case 'modified-asc':
                        return new Date(a.updatedAt || a.savedAt || 0) - new Date(b.updatedAt || b.savedAt || 0);
                    case 'created-desc':
                        return new Date(b.savedAt || 0) - new Date(a.savedAt || 0);
                    case 'created-asc':
                        return new Date(a.savedAt || 0) - new Date(b.savedAt || 0);
                    case 'address':
                        const addrA = a.propertyInfo?.streetAddress || a.propertyInfo?.address || '';
                        const addrB = b.propertyInfo?.streetAddress || b.propertyInfo?.address || '';
                        return addrA.localeCompare(addrB);
                    case 'city':
                        const cityA = a.propertyInfo?.city || parseAddress(a.propertyInfo?.address || '').city || '';
                        const cityB = b.propertyInfo?.city || parseAddress(b.propertyInfo?.address || '').city || '';
                        return cityA.localeCompare(cityB);
                    case 'state':
                        const stateA = a.propertyInfo?.state || parseAddress(a.propertyInfo?.address || '').state || '';
                        const stateB = b.propertyInfo?.state || parseAddress(b.propertyInfo?.address || '').state || '';
                        return stateA.localeCompare(stateB);
                    case 'seller':
                        return (a.seller?.name || '').localeCompare(b.seller?.name || '');
                    case 'status':
                        const statusOrder = ['working', 'loi-sent', 'loi-countered', 'loi-signed', 'won', 'rejected', 'obe'];
                        const statusA = statusOrder.indexOf(a.status || 'working');
                        const statusB = statusOrder.indexOf(b.status || 'working');
                        return statusA - statusB;
                    default:
                        return 0;
                }
            });
        }

        function buildDealObject() {
            // Helper to parse currency/percentage values from display elements
            const parseDisplayValue = (id) => {
                const el = document.getElementById(id);
                if (!el) return 0;
                const text = el.textContent || el.innerText || '';
                return parseFloat(text.replace(/[$,%]/g, '').replace(/,/g, '')) || 0;
            };
            
            return {
                version: '1.0',
                savedAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                propertyInfo: {
                    streetAddress: document.getElementById('streetAddress').value,
                    city: document.getElementById('city').value,
                    state: document.getElementById('state').value.toUpperCase(),
                    zip: document.getElementById('zip').value,
                    address: getFullAddress(), // Combined for backward compatibility
                    link: document.getElementById('propertyLink').value,
                },
                preparer: {
                    name: document.getElementById('preparerName').value,
                    email: document.getElementById('preparerEmail').value,
                    phone: document.getElementById('preparerPhone').value,
                },
                seller: {
                    name: document.getElementById('sellerName').value,
                    email: document.getElementById('sellerEmail').value,
                    phone: document.getElementById('sellerPhone').value,
                },
                dealTerms: {
                    category: document.getElementById('category').value,
                    purchasePrice: document.getElementById('purchasePrice').value,
                    askingPrice: document.getElementById('askingPrice').value,
                    existingDebt: document.getElementById('existingDebt').value,
                    rentalRevenue: document.getElementById('rentalRevenue').value,
                    appreciationRate: document.getElementById('appreciationRate').value,
                },
                financing: {
                    firstLoanLTV: document.getElementById('firstLoanLTV').value,
                    interestOnly: document.getElementById('interestOnly').value,
                    sellerCarryPct: document.getElementById('sellerCarryPct').value,
                    sellerCarryRate: document.getElementById('sellerCarryRate').value,
                    sellerCarryAmort: document.getElementById('sellerCarryAmort').value,
                    interestAtBalloon: document.getElementById('interestAtBalloon').value,
                    yearsToBalloon: document.getElementById('yearsToBalloon').value,
                },
                stabilization: {
                    monthsToStabilize: document.getElementById('monthsToStabilize').value,
                    revenueDuringStab: document.getElementById('revenueDuringStab').value,
                },
                expenses: {
                    propertyTax: document.getElementById('propertyTax').value,
                    insurance: document.getElementById('insurance').value,
                    hoa: document.getElementById('hoa').value,
                    otherExpenses: document.getElementById('otherExpenses').value,
                    capexPct: document.getElementById('capexPct').value,
                    managementPct: document.getElementById('managementPct').value,
                    vacancyPct: document.getElementById('vacancyPct').value,
                },
                cashToBuyer: {
                    agentFee: document.getElementById('agentFee').value,
                    rehabCost: document.getElementById('rehabCost').value,
                    assignmentFeePct: document.getElementById('assignmentFeePct').value,
                    appraisalCost: document.getElementById('appraisalCost').value,
                    closingCostPct: document.getElementById('closingCostPct').value,
                },
                // Internal notes - not included in LOI or summaries
                notes: document.getElementById('dealNotes').value,
                // Store computed metrics for email/PDF generation
                metrics: {
                    noi: parseDisplayValue('noiValue'),
                    capRate: parseDisplayValue('capRate') / 100,
                    blendedRate: parseDisplayValue('blendedRate') / 100,
                    spread: parseDisplayValue('capBlendedSpread') / 100,
                    annualCashFlow: parseDisplayValue('annualCashFlow'),
                    monthlyCashFlow: parseDisplayValue('monthlyCashFlow'),
                    cocReturn: parseDisplayValue('cocReturn') / 100,
                    valueAtBalloon: parseDisplayValue('valueAtBalloon'),
                    balanceAtBalloon: parseDisplayValue('balanceAtBalloon'),
                    equityAtBalloon: parseDisplayValue('equityAtBalloon'),
                    equityPctBalloon: parseDisplayValue('equityPctBalloon') / 100,
                },
                firstPosition: {
                    loanAmount: parseDisplayValue('firstPositionLoan'),
                    rate: parseDisplayValue('firstPositionRate'),
                    amortization: parseInt((document.getElementById('firstPositionAmort')?.textContent || '30').replace(/[^0-9]/g, '')) || 30,
                    payment: parseDisplayValue('firstPositionPayment'),
                },
            };
        }

        function populateFormFromDeal(data) {
            // Property info - handle both new and old format
            if (data.propertyInfo) {
                if (data.propertyInfo.streetAddress !== undefined) {
                    // New format with separate fields
                    document.getElementById('streetAddress').value = data.propertyInfo.streetAddress || '';
                    document.getElementById('city').value = data.propertyInfo.city || '';
                    document.getElementById('state').value = data.propertyInfo.state || '';
                    document.getElementById('zip').value = data.propertyInfo.zip || '';
                } else if (data.propertyInfo.address) {
                    // Old format - try to parse it
                    const parsed = parseOldAddress(data.propertyInfo.address);
                    document.getElementById('streetAddress').value = parsed.street;
                    document.getElementById('city').value = parsed.city;
                    document.getElementById('state').value = parsed.state;
                    document.getElementById('zip').value = parsed.zip;
                }
                document.getElementById('propertyLink').value = data.propertyInfo.link || '';
            }
            
            // Preparer
            if (data.preparer) {
                document.getElementById('preparerName').value = data.preparer.name || '';
                document.getElementById('preparerEmail').value = data.preparer.email || '';
                document.getElementById('preparerPhone').value = data.preparer.phone || '';
            }
            
            // Seller
            if (data.seller) {
                document.getElementById('sellerName').value = data.seller.name || '';
                document.getElementById('sellerEmail').value = data.seller.email || '';
                document.getElementById('sellerPhone').value = data.seller.phone || '';
            }
            
            // Deal terms
            if (data.dealTerms) {
                document.getElementById('category').value = data.dealTerms.category || 'DSCR Residential';
                document.getElementById('purchasePrice').value = data.dealTerms.purchasePrice || '';
                document.getElementById('askingPrice').value = data.dealTerms.askingPrice || '';
                document.getElementById('existingDebt').value = data.dealTerms.existingDebt || '0';
                document.getElementById('rentalRevenue').value = data.dealTerms.rentalRevenue || '';
                document.getElementById('appreciationRate').value = data.dealTerms.appreciationRate || '';
            }
            
            // Financing
            if (data.financing) {
                document.getElementById('firstLoanLTV').value = data.financing.firstLoanLTV || '';
                document.getElementById('interestOnly').value = data.financing.interestOnly || 'No';
                document.getElementById('sellerCarryPct').value = data.financing.sellerCarryPct || '';
                document.getElementById('sellerCarryRate').value = data.financing.sellerCarryRate || '';
                document.getElementById('sellerCarryAmort').value = data.financing.sellerCarryAmort || '';
                document.getElementById('interestAtBalloon').value = data.financing.interestAtBalloon || 'No';
                document.getElementById('yearsToBalloon').value = data.financing.yearsToBalloon || '';
            }
            
            // Stabilization
            if (data.stabilization) {
                document.getElementById('monthsToStabilize').value = data.stabilization.monthsToStabilize || '';
                document.getElementById('revenueDuringStab').value = data.stabilization.revenueDuringStab || '';
            }
            
            // Expenses
            if (data.expenses) {
                document.getElementById('propertyTax').value = data.expenses.propertyTax || '';
                document.getElementById('insurance').value = data.expenses.insurance || '';
                document.getElementById('hoa').value = data.expenses.hoa || '';
                document.getElementById('otherExpenses').value = data.expenses.otherExpenses || '';
                document.getElementById('capexPct').value = data.expenses.capexPct || '';
                document.getElementById('managementPct').value = data.expenses.managementPct || '';
                document.getElementById('vacancyPct').value = data.expenses.vacancyPct || '';
            }
            
            // Cash to buyer
            if (data.cashToBuyer) {
                document.getElementById('agentFee').value = data.cashToBuyer.agentFee || '';
                document.getElementById('rehabCost').value = data.cashToBuyer.rehabCost || '';
                document.getElementById('assignmentFeePct').value = data.cashToBuyer.assignmentFeePct || '';
                document.getElementById('appraisalCost').value = data.cashToBuyer.appraisalCost || '';
                document.getElementById('closingCostPct').value = data.cashToBuyer.closingCostPct || '';
            }
            
            // Notes
            document.getElementById('dealNotes').value = data.notes || '';
            
            // Mark all tracked fields as touched since we loaded a deal
            const trackedFields = ['purchasePrice', 'askingPrice', 'rentalRevenue', 'existingDebt', 'propertyTax', 'insurance', 'hoa', 'otherExpenses', 'agentFee', 'rehabCost', 'appraisalCost'];
            trackedFields.forEach(fieldId => markFieldTouched(fieldId));
            
            // Recalculate
            calculate();
        }

        // PDF Print functionality
        function generatePDF() {
            // Get property address and preparer info
            const propertyAddress = getFullAddress();
            const propertyLink = document.getElementById('propertyLink').value || '';
            const preparerName = document.getElementById('preparerName').value || '';
            const preparerEmail = document.getElementById('preparerEmail').value || '';
            const preparerPhone = document.getElementById('preparerPhone').value || '';
            
            // Update PDF header with address
            document.getElementById('pdf-address').textContent = propertyAddress;
            
            // Update property link
            const pdfPropertyLink = document.getElementById('pdf-property-link');
            if (propertyLink) {
                pdfPropertyLink.innerHTML = `<a href="${propertyLink}" target="_blank"> ${propertyLink}</a>`;
                pdfPropertyLink.style.display = 'block';
            } else {
                pdfPropertyLink.style.display = 'none';
            }
            
            // Update preparer info
            document.getElementById('pdf-preparer-name').textContent = preparerName || 'Not specified';
            
            // Build contact string
            let contactParts = [];
            if (preparerEmail) contactParts.push(preparerEmail);
            if (preparerPhone) contactParts.push(preparerPhone);
            document.getElementById('pdf-preparer-contact').textContent = contactParts.join('  ') || '';
            
            // Show/hide preparer box based on whether any info was provided
            const preparerBox = document.getElementById('pdf-preparer-box');
            if (preparerName || preparerEmail || preparerPhone) {
                preparerBox.style.display = 'flex';
            } else {
                preparerBox.style.display = 'none';
            }
            
            // Update PDF summary content
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
            const category = document.getElementById('category').value;
            
            document.getElementById('pdf-purchase-price').textContent = document.getElementById('loiPurchasePrice').textContent;
            document.getElementById('pdf-property-type').textContent = category;
            document.getElementById('pdf-asking-price').textContent = formatCurrency(parseFloat(document.getElementById('askingPrice').value) || 0);
            document.getElementById('pdf-over-under').textContent = document.getElementById('overUnderAsking').textContent;
            
            // Key metrics
            document.getElementById('pdf-coc').textContent = document.getElementById('cocReturn').textContent;
            document.getElementById('pdf-cap-rate').textContent = document.getElementById('capRate').textContent;
            document.getElementById('pdf-blended-rate').textContent = document.getElementById('blendedRate').textContent;
            document.getElementById('pdf-spread').textContent = document.getElementById('capBlendedSpread').textContent;
            document.getElementById('pdf-annual-cf').textContent = document.getElementById('annualCashFlow').textContent;
            document.getElementById('pdf-noi').textContent = document.getElementById('noiValue').textContent;
            
            // Financing
            document.getElementById('pdf-first-position').textContent = document.getElementById('firstPositionLoan').textContent;
            document.getElementById('pdf-first-rate').textContent = document.getElementById('firstPositionRate').textContent;
            document.getElementById('pdf-first-amort').textContent = document.getElementById('firstPositionAmort').textContent;
            document.getElementById('pdf-first-payment').textContent = document.getElementById('firstPositionPayment').textContent;
            document.getElementById('pdf-seller-carry').textContent = document.getElementById('sellerCarryAmount').textContent;
            document.getElementById('pdf-seller-rate').textContent = document.getElementById('loiInterestRate').textContent;
            document.getElementById('pdf-seller-amort').textContent = document.getElementById('loiAmortization').textContent + ' yrs';
            document.getElementById('pdf-seller-payment').textContent = document.getElementById('sellerCarryPayment').textContent;
            document.getElementById('pdf-down-payment').textContent = document.getElementById('downPayment').textContent;
            document.getElementById('pdf-total-financing').textContent = document.getElementById('totalFinancingPct').textContent;
            
            // Cash to Buyer
            document.getElementById('pdf-residual').textContent = document.getElementById('residualValue').textContent;
            document.getElementById('pdf-assignment').textContent = document.getElementById('assignmentFeeDisplay').textContent;
            document.getElementById('pdf-closing').textContent = document.getElementById('closingCostDisplay').textContent;
            document.getElementById('pdf-cash-to-buyer').textContent = document.getElementById('cashToBuyer').textContent;
            
            // Cash Flow
            document.getElementById('pdf-revenue').textContent = document.getElementById('annualRevenue').textContent;
            document.getElementById('pdf-expenses').textContent = document.getElementById('totalOpExpenses').textContent;
            document.getElementById('pdf-first-pi').textContent = document.getElementById('firstPIPayout').textContent;
            document.getElementById('pdf-seller-pi').textContent = document.getElementById('sellerCarryPayout').textContent;
            document.getElementById('pdf-monthly-cf').textContent = document.getElementById('monthlyCashFlow').textContent;
            document.getElementById('pdf-cf-purchase').textContent = document.getElementById('cfToPurchase').textContent;
            
            // Balloon
            document.getElementById('pdf-years-balloon').textContent = document.getElementById('yearsToBalloon').value + ' years';
            document.getElementById('pdf-value-balloon').textContent = document.getElementById('valueAtBalloon').textContent;
            document.getElementById('pdf-balance-balloon').textContent = document.getElementById('balanceAtBalloon').textContent;
            document.getElementById('pdf-equity-balloon').textContent = document.getElementById('equityAtBalloon').textContent;
            document.getElementById('pdf-equity-pct').textContent = document.getElementById('equityPctBalloon').textContent;
            
            // Date
            document.getElementById('pdf-date').textContent = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Show PDF summary and print
            const pdfSummary = document.getElementById('pdf-summary');
            pdfSummary.style.display = 'block';
            pdfSummary.classList.add('printing');
            
            window.print();
            
            // Hide after print dialog closes
            setTimeout(() => {
                pdfSummary.style.display = 'none';
                pdfSummary.classList.remove('printing');
            }, 1000);
        }

        // LOI Generation using pdf-lib (matches email attachment format)
        async function generateLOI() {
            const { PDFDocument, rgb, StandardFonts } = PDFLib;
            
            // Get values
            const propertyAddress = getFullAddress();
            const preparerName = document.getElementById('preparerName').value || '[Name]';
            const preparerEmail = document.getElementById('preparerEmail').value || '';
            const preparerPhone = document.getElementById('preparerPhone').value || '';
            const sellerName = document.getElementById('sellerName').value || '[Seller Name]';
            const sellerEmail = document.getElementById('sellerEmail').value || '';
            const sellerPhone = document.getElementById('sellerPhone').value || '';
            const purchasePrice = parseFloat(document.getElementById('purchasePrice').value) || 0;
            const sellerCarryAmort = parseInt(document.getElementById('sellerCarryAmort').value) || 30;
            const yearsToBalloon = parseInt(document.getElementById('yearsToBalloon').value) || 8;
            
            // Get calculated values (parse from displayed text)
            const cashToSeller = parseCurrency(document.getElementById('firstPositionLoan').textContent);
            const sellerCarryAmount = parseCurrency(document.getElementById('sellerCarryAmount').textContent);
            const monthlyPayment = parseCurrency(document.getElementById('sellerCarryPayment').textContent);
            
            // Dates
            const today = new Date();
            const dateStr = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            const expiryDate = new Date(today);
            expiryDate.setDate(expiryDate.getDate() + 30);
            const expiryStr = expiryDate.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            
            // Tracking number
            const streetMatch = propertyAddress.match(/^(\d+)/);
            const streetNum = streetMatch ? streetMatch[1] : 'XXXXX';
            const datePart = today.toISOString().slice(0, 10).replace(/-/g, '');
            const trackingNum = `${streetNum}-${datePart}01`;
            
            // Create PDF
            const pdfDoc = await PDFDocument.create();
            const helvetica = await pdfDoc.embedFont(StandardFonts.Helvetica);
            const helveticaBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
            
            // PDF Writer helper class
            class PDFWriter {
                constructor() {
                    this.pageWidth = 612;
                    this.pageHeight = 792;
                    this.marginLeft = 50;
                    this.marginRight = 50;
                    this.marginBottom = 50;
                    this.lineHeight = 14;
                    this.page = pdfDoc.addPage([this.pageWidth, this.pageHeight]);
                    this.y = this.pageHeight - 50;
                }
                
                checkNewPage(needed = 30) {
                    if (this.y < this.marginBottom + needed) {
                        this.page = pdfDoc.addPage([this.pageWidth, this.pageHeight]);
                        this.y = this.pageHeight - 50;
                    }
                }
                
                wrapText(text, font, fontSize) {
                    const maxWidth = this.pageWidth - this.marginLeft - this.marginRight;
                    const words = text.split(' ');
                    const lines = [];
                    let currentLine = '';
                    for (const word of words) {
                        const testLine = currentLine ? `${currentLine} ${word}` : word;
                        const testWidth = font.widthOfTextAtSize(testLine, fontSize);
                        if (testWidth > maxWidth && currentLine) {
                            lines.push(currentLine);
                            currentLine = word;
                        } else {
                            currentLine = testLine;
                        }
                    }
                    if (currentLine) lines.push(currentLine);
                    return lines;
                }
                
                drawTitle(text, fontSize = 18) {
                    this.checkNewPage(40);
                    this.page.drawText(text, {
                        x: this.marginLeft, y: this.y, size: fontSize,
                        font: helveticaBold, color: rgb(0.08, 0.72, 0.65)
                    });
                    this.y -= fontSize + 10;
                }
                
                drawHeading(text, fontSize = 12) {
                    this.checkNewPage(30);
                    this.y -= 8;
                    this.page.drawText(text, {
                        x: this.marginLeft, y: this.y, size: fontSize,
                        font: helveticaBold, color: rgb(0.1, 0.1, 0.1)
                    });
                    this.y -= fontSize + 6;
                }
                
                drawSubheading(text) {
                    this.checkNewPage(25);
                    this.y -= 4;
                    this.page.drawText(text, {
                        x: this.marginLeft, y: this.y, size: 11,
                        font: helveticaBold, color: rgb(0.2, 0.2, 0.2)
                    });
                    this.y -= 16;
                }
                
                drawParagraph(text, fontSize = 10) {
                    const lines = this.wrapText(text, helvetica, fontSize);
                    for (const line of lines) {
                        this.checkNewPage();
                        this.page.drawText(line, {
                            x: this.marginLeft, y: this.y, size: fontSize,
                            font: helvetica, color: rgb(0.15, 0.15, 0.15)
                        });
                        this.y -= this.lineHeight;
                    }
                    this.y -= 6;
                }
                
                drawBullet(text, fontSize = 10) {
                    const textX = this.marginLeft + 25;
                    const maxWidth = this.pageWidth - textX - this.marginRight;
                    const words = text.split(' ');
                    const lines = [];
                    let currentLine = '';
                    for (const word of words) {
                        const testLine = currentLine ? `${currentLine} ${word}` : word;
                        const testWidth = helvetica.widthOfTextAtSize(testLine, fontSize);
                        if (testWidth > maxWidth && currentLine) {
                            lines.push(currentLine);
                            currentLine = word;
                        } else {
                            currentLine = testLine;
                        }
                    }
                    if (currentLine) lines.push(currentLine);
                    
                    this.checkNewPage();
                    this.page.drawText('', {
                        x: this.marginLeft + 10, y: this.y, size: fontSize,
                        font: helvetica, color: rgb(0.08, 0.72, 0.65)
                    });
                    for (const line of lines) {
                        this.checkNewPage();
                        this.page.drawText(line, {
                            x: textX, y: this.y, size: fontSize,
                            font: helvetica, color: rgb(0.15, 0.15, 0.15)
                        });
                        this.y -= this.lineHeight;
                    }
                    this.y -= 2;
                }
                
                drawBoldBullet(text, fontSize = 10) {
                    const textX = this.marginLeft + 25;
                    const maxWidth = this.pageWidth - textX - this.marginRight;
                    const words = text.split(' ');
                    const lines = [];
                    let currentLine = '';
                    for (const word of words) {
                        const testLine = currentLine ? `${currentLine} ${word}` : word;
                        const testWidth = helveticaBold.widthOfTextAtSize(testLine, fontSize);
                        if (testWidth > maxWidth && currentLine) {
                            lines.push(currentLine);
                            currentLine = word;
                        } else {
                            currentLine = testLine;
                        }
                    }
                    if (currentLine) lines.push(currentLine);
                    
                    this.checkNewPage();
                    this.page.drawText('', {
                        x: this.marginLeft + 10, y: this.y, size: fontSize,
                        font: helvetica, color: rgb(0.08, 0.72, 0.65)
                    });
                    for (const line of lines) {
                        this.checkNewPage();
                        this.page.drawText(line, {
                            x: textX, y: this.y, size: fontSize,
                            font: helveticaBold, color: rgb(0.15, 0.15, 0.15)
                        });
                        this.y -= this.lineHeight;
                    }
                    this.y -= 2;
                }
                
                drawText(text, options = {}) {
                    const fontSize = options.size || 10;
                    const font = options.bold ? helveticaBold : helvetica;
                    const color = options.color || [0.15, 0.15, 0.15];
                    this.checkNewPage();
                    this.page.drawText(text, {
                        x: this.marginLeft, y: this.y, size: fontSize,
                        font: font, color: rgb(color[0], color[1], color[2])
                    });
                    this.y -= this.lineHeight;
                }
                
                drawLine() {
                    this.checkNewPage();
                    this.y -= 5;
                    this.page.drawLine({
                        start: { x: this.marginLeft, y: this.y },
                        end: { x: this.pageWidth - this.marginRight, y: this.y },
                        thickness: 0.5, color: rgb(0.8, 0.8, 0.8)
                    });
                    this.y -= 10;
                }
                
                addSpace(space = 10) { this.y -= space; }
            }
            
            const w = new PDFWriter();
            
            // Header
            w.drawTitle('LETTER OF INTENT', 20);
            w.drawText(`Tracking #: ${trackingNum}`, { size: 9, color: [0.5, 0.5, 0.5] });
            w.drawText(dateStr, { size: 10 });
            w.addSpace(5);
            w.drawText(propertyAddress, { bold: true, size: 11 });
            w.addSpace(10);
            
            w.drawText('Re: Letter of Intent to Purchase Property', { bold: true, size: 11 });
            w.addSpace(10);
            w.drawText(`Dear ${sellerName},`, { size: 10 });
            w.addSpace(8);
            
            // Opening
            w.drawParagraph(`On behalf of Instant Hotels, Inc., we are pleased to present this Letter of Intent expressing our intention to purchase the property located at ${propertyAddress} for the proposed purchase price of ${formatCurrency(purchasePrice)}. This Letter of Intent outlines the key terms and conditions of our offer, subject to further negotiations and the execution of a formal purchase contract.`);
            w.addSpace(5);
            
            // Purchase Details
            w.drawHeading('Purchase Details:');
            w.drawParagraph(`Property: ${propertyAddress}`);
            w.drawParagraph(`Proposed Terms Purchase Price: ${formatCurrency(purchasePrice)}`);
            w.drawParagraph('Property Condition: Property to be acquired strictly in its present "As-Is, Where-Is" condition, with no representations or warranties from the Seller.');
            w.addSpace(3);
            
            w.drawBullet(`Cash at Closing: ${formatCurrency(cashToSeller)} (Buyer has established lender financing relationships and can deliver without delay).`);
            w.drawBullet(`Seller-Equity Agreement (Finance Agreement): ${formatCurrency(sellerCarryAmount)}. Amortization: ${sellerCarryAmort} years, Monthly Payments: ${formatCurrency(monthlyPayment)} consisting of principal only with a ${yearsToBalloon}-year balloon.`);
            w.addSpace(5);
            
            w.drawParagraph('Seller-Equity Agreement: Simultaneously, the Buyer\'s LLC operating agreement is executed to reflect the Seller\'s minority equity interest. Escrow returns this portion to the Buyer post-closing, while the Seller retains a secured interest in the LLC for that amount, with rights to assume full ownership of the LLC in the event of default.');
            
            w.drawParagraph('The closing will be facilitated by a licensed title company, escrow agent, or closing attorney (hereby "the Closing Agent"), and all funds will be disbursed at the close of escrow in accordance with mutually agreed-upon instructions contained in a definitive state-approved Purchase and Sale Agreement ("PSA"). The transaction will occur in two distinct stages:');
            
            // First Stage
            w.drawHeading('First Stage (All Cash Closing)');
            w.drawParagraph('At the initial all-cash closing, the Buyer will bring the full purchase price in cash. The Buyer intends to obtain a Commercial loan at 70-80% loan-to-value (LTV) to reimburse a portion of the funds following this close. The Purchase and Sale Agreement and its incorporated escrow instructions shall direct the Closing Agent to hold funds in escrow until the second leg of the transaction is completed. The close will be contingent on the Property appraising at or above the agreed-upon purchase price. The Buyer will close escrow, and the title insurer will issue a title policy insuring the Buyer\'s interest in the Property after this first leg, with all associated title insurance premiums and related closing costs borne by the Buyer.');
            
            // Second Stage
            w.drawHeading('Second Stage (Seller-Financing/Installment Sale)');
            w.drawParagraph('Following the close of escrow and completion of the first leg, the immediate second leg of the transaction is opened pursuant to detailed escrow instructions in the Purchase and Sale Agreement. The Closing Agent shall disburse the Seller\'s agreed-upon down payment, and instead of recording a Deed of Trust/Mortgage and Promissory Note, the Seller\'s remaining equity will be secured through the Buyer\'s LLC operating agreement, naming the Seller as a minority equity partner. In the event of a default, this structure entitles the Seller to obtain 100% ownership of the LLC, thereby regaining full control of the Property without the need for foreclosure. The Seller-financed portion shall still be structured as an installment sale, providing ongoing, tax-advantaged income while simultaneously reducing the Seller\'s immediate tax burden.');
            
            w.drawParagraph('This creative structure enables the Buyer to acquire the Property at a comparatively low capitalization rate at retail pricing, while remitting a substantial portion of the Purchase Price to the Seller as an immediate down payment. Concurrently, by structuring the balance as an installment sale with seller financing, the Seller can defer and potentially minimize immediate tax liabilities. The Seller, thus, secures an aggressive purchase price, a significant down payment, and the potential for a reduced overall tax burden.');
            
            // Steps
            w.addSpace(5);
            w.drawSubheading('Step 1 - Seller Agrees to Sell Property');
            w.drawBullet(`Property Price: ${formatCurrency(purchasePrice)}`);
            w.drawBullet('Seller hands over the property in as-is condition.');
            
            w.drawSubheading('Step 2 - Stage 1: Cash Closing');
            w.drawBullet(`Buyer brings ${formatCurrency(purchasePrice)} cash to closing.`);
            w.drawBullet('Escrow holds funds temporarily.');
            w.drawBullet('Title transfers - Buyer\'s LLC now owns the property.');
            w.drawBullet(`Seller gets their immediate cash payout: ${formatCurrency(cashToSeller)}.`);
            
            w.drawSubheading('Step 3 - Stage 2: Equity Carry Agreement');
            w.drawBullet(`The remaining ${formatCurrency(sellerCarryAmount)} is not paid out in cash.`);
            w.drawBullet('Instead, it becomes the Seller\'s Equity Carry (preferred equity) inside Buyer\'s LLC.');
            
            w.drawSubheading('Step 4 - Seller\'s Equity Terms');
            w.drawBullet('Treated like a secured loan inside the new LLC.');
            w.drawBullet(`Monthly payment: ${formatCurrency(monthlyPayment)} (principal only).`);
            w.drawBullet(`Balloon: ${yearsToBalloon} years.`);
            w.drawBullet('If Buyer defaults - Seller can take back 100% of the LLC (full ownership of property) without foreclosure.');
            
            w.drawSubheading('Step 5 - Seller\'s Benefits');
            w.drawBullet(`Immediate cash at close (${formatCurrency(cashToSeller)})`);
            w.drawBullet(`Ongoing monthly payments (${formatCurrency(monthlyPayment)})`);
            w.drawBullet('Secured "back door" ownership protection');
            w.drawBullet('Tax-advantaged structure (installment sale)');
            w.addSpace(8);
            
            // IRS paragraph
            w.drawParagraph('In accordance with guidance set forth by the Internal Revenue Service (IRS) for installment sales (see, e.g., IRS Publication 537), "income received over time through an installment sale may, under certain circumstances, be treated as ordinary income." This approach allows for the recognition of gains and the associated tax obligations to be spread over multiple tax years, rather than realized in a single lump sum, potentially resulting in a more favorable tax outcome.');
            
            w.drawParagraph('Additionally, the buyer will cover all title insurance premiums, all customary closing costs, fees, and related expenses. This allocation ensures the Seller realizes the full benefit of the agreed-upon financial terms without incurring out-of-pocket transactional costs.');
            
            w.drawParagraph('This LOI is provided solely as an outline and for the purpose of facilitating further discussion. Except as may be otherwise agreed in writing (such as confidentiality or exclusivity provisions), this LOI is non-binding. Neither Party shall be legally obligated to proceed unless and until both Parties execute a definitive State-approved PSA and related ancillary documents that fully memorialize the terms and conditions of the transaction.');
            
            // Seller Protection Clause
            w.drawHeading('Seller Protection Clause');
            w.drawText('Operating Agreement with Default Control Provisions', { bold: true, size: 10 });
            w.addSpace(5);
            w.drawBoldBullet('Instead of holding a second-position lien, the Seller and Buyer will enter into an LLC operating agreement (or land trust with an assignment of beneficial interest) where the Seller maintains certain minority equity interest.');
            w.drawBoldBullet('The LLC or trust holds title to the property, and the Buyer operates as the primary manager/member.');
            w.drawBoldBullet('The agreement includes a clause that allows the Seller to regain full control of the LLC or trust (and thus the property) if the Buyer defaults on their financial obligations (missed payments, failure to insure, etc.).');
            w.addSpace(5);
            
            // Additional terms
            w.drawParagraph('Commissions: 2.5% to Buyer\'s Agent, Steven Glaude, LPT Realty, Lic #01257750.');
            w.drawParagraph('Deposit: EMD is 1% of purchase price, deposited after inspection period.');
            w.drawParagraph('Inspection Period: Buyer shall have a maximum of thirty (30) business days following execution of the PSA to complete all due diligence, including inspections, title review, and feasibility studies. The inspection period only begins after the buyer receives all financials relevant to the business operation. The buyer is prepared to accelerate this if feasible. The Earnest Money Deposit goes hard at 1% after the inspection contingency period.');
            
            // Documentation
            w.drawParagraph('Provision of Financial and Operational Documentation: The Seller agrees to furnish the Buyer, within a specified due diligence period, with complete and accurate financial and operational records relating to the Property. Such records shall include, but are not limited to:');
            w.drawBullet('Trailing Twelve (T12) Months Operating Statements: Detailed income and expense reports for the previous twelve (12) months.');
            w.drawBullet('Rent Roll and Leases: Current rent roll listing all tenants, rental amounts, security deposits, lease start and end dates, and any tenant concessions.');
            w.drawBullet('Service and Vendor Contracts: Copies of all service agreements, property management contracts, warranties, guaranties, or other third-party obligations.');
            w.drawBullet('Utility and Maintenance Records: Historical utility bills, maintenance logs, capital expenditure records, and warranty information for major systems.');
            w.drawBullet('Insurance and Claims History: Certificates of insurance, loss runs, and any claims history.');
            w.drawBullet('Tax and Assessment Information: Most recent property tax statements, assessments, and notices of any special assessments.');
            w.drawBullet('Permits and Licenses: Copies of all governmental permits, licenses, or approvals necessary for the current operation of the Property.');
            w.addSpace(5);
            
            w.drawParagraph('Closing Date: Closing to occur within forty-five (45) to sixty (60) days or sooner following full execution of the Agreement. The buyer is positioned to close earlier if conditions permit. A one-time extension of 15 days may be granted upon mutual agreement.');
            
            w.drawParagraph('Closing Costs: Buyer will assume all standard closing costs, including escrow fees, title insurance premiums, recording fees, transfer taxes, and other customary expenses, thereby ensuring a streamlined closing process for Seller.');
            
            // Contingencies
            w.drawHeading('Contingencies to Closing:');
            w.drawParagraph('a. Property Inspections: Buyer shall inspect all buildings, grounds, utilities and clean environmental.');
            w.drawParagraph('b. Lending, Appraisal, and Financing.');
            w.drawParagraph('c. Review documentation and verify title, check for delinquent utilities, and review current payment statements.');
            
            // Conditions
            w.drawHeading('Conditions:');
            w.drawParagraph('The execution of an Agreement of Sale shall be conditioned on the satisfaction of the above terms and contingencies. Both Purchaser and Seller acknowledge that this Letter of Intent is not a purchase contract but serves as the foundation for drafting a formal purchase contract between the parties. No legal obligations or liabilities shall arise from this Letter of Intent.');
            
            w.drawParagraph('Instant Hotels, Inc., makes no warranty or representation to Seller or Purchaser that the acceptance of this Letter of Intent guarantees the execution of a purchase contract.');
            
            w.drawParagraph(`This Letter of Intent is valid until 5:00 PM on ${expiryStr}. If an executed copy of this letter is not received by that date, this Letter of Intent will be considered withdrawn.`);
            
            w.drawParagraph('We look forward to further discussions and negotiations to reach a mutually beneficial agreement. Please do not hesitate to contact us to initiate the next steps in this process.');
            
            w.addSpace(10);
            w.drawText('Sincerely,', { size: 10 });
            w.addSpace(15);
            
            // Buyer signature block
            w.drawText(preparerName, { bold: true, size: 11 });
            w.drawText('Acquisitions Manager', { size: 10 });
            w.drawText('Instant Hotels, Inc.', { size: 10 });
            if (preparerEmail) w.drawText(preparerEmail, { size: 10 });
            if (preparerPhone) w.drawText(preparerPhone, { size: 10 });
            w.addSpace(10);
            
            w.drawText('Steven P. Glaude', { bold: true, size: 11 });
            w.drawText('President', { size: 10 });
            w.drawText('Realtor - Investor', { size: 10 });
            w.drawText('CalBRE #01257750', { size: 10 });
            w.drawText('Tel. No. (916) 316-4472', { size: 10 });
            w.drawText('steven@stevenglaude.com', { size: 10 });
            w.addSpace(5);
            w.drawLine();
            
            // Acceptance section
            w.addSpace(10);
            w.drawText(`Date: ${dateStr}`, { size: 10 });
            w.addSpace(5);
            w.drawText('By: _Steven Glaude_', { bold: true, size: 11 });
            w.addSpace(3);
            w.drawText('Buyer: Instant Hotels, Inc.', { size: 10 });
            w.addSpace(15);
            
            w.drawHeading('ACCEPTANCE THIS DATE:');
            w.addSpace(10);
            w.drawText('Date: _____________________', { size: 10 });
            w.addSpace(5);
            w.drawText('By: _________________________________', { size: 10 });
            w.addSpace(3);
            w.drawText(`Seller: ${sellerName}`, { bold: true, size: 10 });
            if (sellerEmail) w.drawText(sellerEmail, { size: 9, color: [0.5, 0.5, 0.5] });
            if (sellerPhone) w.drawText(sellerPhone, { size: 9, color: [0.5, 0.5, 0.5] });
            
            // Save and download
            const pdfBytes = await pdfDoc.save();
            const blob = new Blob([pdfBytes], { type: 'application/pdf' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `LOI-${propertyAddress.replace(/[^a-zA-Z0-9]/g, '-')}.pdf`;
            link.click();
            URL.revokeObjectURL(url);
        }
    </script>

    <!-- PDF Summary Template -->
    <div id="pdf-summary">
        <div class="pdf-header">
            <h1>Real Estate Underwriting Summary</h1>
            <div class="pdf-address" id="pdf-address"></div>
            <div class="pdf-property-link" id="pdf-property-link"></div>
            <div class="pdf-date" id="pdf-date"></div>
        </div>

        <div class="pdf-preparer-box" id="pdf-preparer-box">
            <div class="pdf-preparer-title">Prepared By</div>
            <div class="pdf-preparer-info">
                <span id="pdf-preparer-name"></span>
                <span id="pdf-preparer-contact"></span>
            </div>
        </div>

        <div class="pdf-highlight-box">
            <div class="pdf-highlight-item">
                <h3>Cash-on-Cash Return</h3>
                <div class="value" id="pdf-coc">0%</div>
            </div>
            <div class="pdf-highlight-item">
                <h3>Cap Rate</h3>
                <div class="value" id="pdf-cap-rate">0%</div>
            </div>
            <div class="pdf-highlight-item">
                <h3>Blended Rate</h3>
                <div class="value" id="pdf-blended-rate">0%</div>
            </div>
            <div class="pdf-highlight-item">
                <h3>Spread</h3>
                <div class="value" id="pdf-spread">0%</div>
            </div>
            <div class="pdf-highlight-item">
                <h3>Annual Cash Flow</h3>
                <div class="value" id="pdf-annual-cf">$0</div>
            </div>
            <div class="pdf-highlight-item">
                <h3>NOI</h3>
                <div class="value" id="pdf-noi">$0</div>
            </div>
        </div>

        <div class="pdf-two-col">
            <div>
                <div class="pdf-section">
                    <div class="pdf-section-title">Deal Overview</div>
                    <div class="pdf-row">
                        <span class="pdf-label">Purchase Price</span>
                        <span class="pdf-value highlight" id="pdf-purchase-price">$0</span>
                    </div>
                    <div class="pdf-row">
                        <span class="pdf-label">Asking Price</span>
                        <span class="pdf-value" id="pdf-asking-price">$0</span>
                    </div>
                    <div class="pdf-row">
                        <span class="pdf-label">Over/Under Asking</span>
                        <span class="pdf-value" id="pdf-over-under">0%</span>
                    </div>
                    <div class="pdf-row">
                        <span class="pdf-label">Property Type</span>
                        <span class="pdf-value" id="pdf-property-type">Mixed Use</span>
                    </div>
                </div>

                <div class="pdf-section">
                    <div class="pdf-section-title">First Position Loan</div>
                    <div class="pdf-row">
                        <span class="pdf-label">Loan Amount</span>
                        <span class="pdf-value" id="pdf-first-position">$0</span>
                    </div>
                    <div class="pdf-row">
                        <span class="pdf-label">Interest Rate</span>
                        <span class="pdf-value" id="pdf-first-rate">0%</span>
                    </div>
                    <div class="pdf-row">
                        <span class="pdf-label">Amortization</span>
                        <span class="pdf-value" id="pdf-first-amort">0 yrs</span>
                    </div>
                    <div class="pdf-row">
                        <span class="pdf-label">Monthly Payment</span>
                        <span class="pdf-value" id="pdf-first-payment">$0</span>
                    </div>
                </div>

                <div class="pdf-section">
                    <div class="pdf-section-title">Seller Financing</div>
                    <div class="pdf-row">
                        <span class="pdf-label">Seller Carry Amount</span>
                        <span class="pdf-value" id="pdf-seller-carry">$0</span>
                    </div>
                    <div class="pdf-row">
                        <span class="pdf-label">Interest Rate</span>
                        <span class="pdf-value" id="pdf-seller-rate">0%</span>
                    </div>
                    <div class="pdf-row">
                        <span class="pdf-label">Amortization</span>
                        <span class="pdf-value" id="pdf-seller-amort">0 yrs</span>
                    </div>
                    <div class="pdf-row">
                        <span class="pdf-label">Monthly Payment</span>
                        <span class="pdf-value" id="pdf-seller-payment">$0</span>
                    </div>
                    <div class="pdf-row">
                        <span class="pdf-label">Down Payment</span>
                        <span class="pdf-value" id="pdf-down-payment">$0</span>
                    </div>
                    <div class="pdf-row">
                        <span class="pdf-label">Total Financing</span>
                        <span class="pdf-value" id="pdf-total-financing">0%</span>
                    </div>
                </div>
            </div>

            <div>
                <div class="pdf-section">
                    <div class="pdf-section-title">Cash to Buyer</div>
                    <div class="pdf-row">
                        <span class="pdf-label">Residual (Equity Gain)</span>
                        <span class="pdf-value" id="pdf-residual">$0</span>
                    </div>
                    <div class="pdf-row">
                        <span class="pdf-label">Assignment Fee</span>
                        <span class="pdf-value" id="pdf-assignment">$0</span>
                    </div>
                    <div class="pdf-row">
                        <span class="pdf-label">Closing & Bridge Costs</span>
                        <span class="pdf-value" id="pdf-closing">$0</span>
                    </div>
                    <div class="pdf-row">
                        <span class="pdf-label"><strong>Net Cash to Buyer</strong></span>
                        <span class="pdf-value highlight" id="pdf-cash-to-buyer">$0</span>
                    </div>
                </div>

                <div class="pdf-section">
                    <div class="pdf-section-title">Cash Flow Analysis</div>
                    <div class="pdf-row">
                        <span class="pdf-label">Annual Revenue</span>
                        <span class="pdf-value" id="pdf-revenue">$0</span>
                    </div>
                    <div class="pdf-row">
                        <span class="pdf-label">Operating Expenses</span>
                        <span class="pdf-value negative" id="pdf-expenses">$0</span>
                    </div>
                    <div class="pdf-row">
                        <span class="pdf-label">First Position P&I (Annual)</span>
                        <span class="pdf-value negative" id="pdf-first-pi">$0</span>
                    </div>
                    <div class="pdf-row">
                        <span class="pdf-label">Seller Carry (Annual)</span>
                        <span class="pdf-value negative" id="pdf-seller-pi">$0</span>
                    </div>
                    <div class="pdf-row">
                        <span class="pdf-label">Monthly Cash Flow</span>
                        <span class="pdf-value positive" id="pdf-monthly-cf">$0</span>
                    </div>
                    <div class="pdf-row">
                        <span class="pdf-label">CF to Purchase Price</span>
                        <span class="pdf-value" id="pdf-cf-purchase">0%</span>
                    </div>
                </div>

                <div class="pdf-section">
                    <div class="pdf-section-title">Balloon & Equity Projection</div>
                    <div class="pdf-row">
                        <span class="pdf-label">Years to Balloon</span>
                        <span class="pdf-value" id="pdf-years-balloon">0 years</span>
                    </div>
                    <div class="pdf-row">
                        <span class="pdf-label">Projected Value</span>
                        <span class="pdf-value" id="pdf-value-balloon">$0</span>
                    </div>
                    <div class="pdf-row">
                        <span class="pdf-label">Remaining Balance</span>
                        <span class="pdf-value negative" id="pdf-balance-balloon">$0</span>
                    </div>
                    <div class="pdf-row">
                        <span class="pdf-label">Equity at Balloon</span>
                        <span class="pdf-value positive" id="pdf-equity-balloon">$0</span>
                    </div>
                    <div class="pdf-row">
                        <span class="pdf-label">Equity Percentage</span>
                        <span class="pdf-value highlight" id="pdf-equity-pct">0%</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="pdf-footer">
            This analysis is for informational purposes only. All projections are estimates and actual results may vary.
            <br>Generated by Real Estate Underwriting Calculator
        </div>
    </div>

    <!-- LOI Template -->
    <div id="loi-document">
        <div class="loi-date-header">
            <span id="loi-date"></span>
        </div>

        <div class="loi-address-line">
            <span id="loi-property-address"></span>
            <span class="loi-tracking">LOI TRACKING NUMBER: <span id="loi-tracking"></span></span>
        </div>
        
        <div class="loi-property-link" id="loi-property-link-container"></div>

        <div class="loi-re">
            <strong>Re: Letter of Intent to Purchase Property</strong>
        </div>

        <div class="loi-greeting">
            Dear <span id="loi-seller-name">[Seller Name]</span>,
        </div>

        <div class="loi-body">
            <p>On behalf of <strong>Instant Hotels, Inc.</strong>, we are pleased to present this Letter of Intent expressing our intention to purchase the property located at <strong id="loi-address-inline"></strong> for the proposed purchase price of <strong id="loi-price-inline"></strong>. This Letter of Intent outlines the key terms and conditions of our offer, subject to further negotiations and the execution of a formal purchase contract.</p>

            <h3>Purchase Details:</h3>
            <p><u>Property:</u> <span id="loi-property-full"></span></p>
            <p><u>Proposed Terms Purchase Price:</u> <span id="loi-purchase-price"></span></p>
            <p><strong>Property Condition:</strong> Property to be acquired strictly in its present "As-Is, Where-Is" condition, with no representations or warranties from the Seller.</p>
            
            <p> <u>Cash at Closing:</u> <strong id="loi-cash-at-closing"></strong> (Buyer has established lender financing relationships and can deliver without delay).</p>
            
            <p> <u>Seller-Equity Agreement:</u> (Finance Agreement): <strong id="loi-seller-equity"></strong>. Amortization: <strong id="loi-amort-years"></strong> years, Monthly Payments: <strong id="loi-monthly-payment"></strong> consisting of principal only with a <strong id="loi-balloon-years"></strong>-year balloon.</p>

            <p><strong>Seller-Equity Agreement:</strong> Simultaneously, the Buyer's LLC operating agreement is executed to reflect the Seller's minority equity interest. Escrow returns this portion to the Buyer post-closing, while the Seller retains a secured interest in the LLC for that amount, with rights to assume full ownership of the LLC in the event of default.</p>

            <p>The closing will be facilitated by a licensed title company, escrow agent, or closing attorney (hereby "the Closing Agent"), and all funds will be disbursed at the close of escrow in accordance with mutually agreed-upon instructions contained in a definitive state-approved Purchase and Sale Agreement ("PSA"). The transaction will occur in two distinct stages:</p>

            <h3><u>First Stage (All Cash Closing)</u></h3>
            <p>At the initial all-cash closing, the Buyer will bring the full purchase price in cash. The Buyer intends to obtain a Commercial loan at 70-80% loan-to-value (LTV) to reimburse a portion of the funds following this close. The Purchase and Sale Agreement and its incorporated escrow instructions shall direct the Closing Agent to hold funds in escrow until the second leg of the transaction is completed. The close will be contingent on the Property appraising at or above the agreed-upon purchase price. The Buyer will close escrow, and the title insurer will issue a title policy insuring the Buyer's interest in the Property after this first leg, with all associated title insurance premiums and related closing costs borne by the Buyer.</p>

            <h3><u>Second Stage (Seller-Financing/Installment Sale)</u></h3>
            <p>Following the close of escrow and completion of the first leg, the immediate second leg of the transaction is opened pursuant to detailed escrow instructions in the Purchase and Sale Agreement. The Closing Agent shall disburse the Seller's agreed-upon down payment, and instead of recording a Deed of Trust/Mortgage and Promissory Note, the Seller's remaining equity will be secured through the Buyer's LLC operating agreement, naming the Seller as a minority equity partner. In the event of a default, this structure entitles the Seller to obtain 100% ownership of the LLC, thereby regaining full control of the Property without the need for foreclosure. The Seller-financed portion shall still be structured as an installment sale, providing ongoing, tax-advantaged income while simultaneously reducing the Seller's immediate tax burden. To further protect the Seller's financial interest in the Property, we offer a Seller Protection Clause (please see the bottom of this Section for more details). The title insurer will issue a title policy insuring the Buyer's interest in the Property after this second leg, with all associated title insurance premiums and related closing costs borne by the Buyer.</p>

            <p>This creative structure enables the Buyer to acquire the Property at a comparatively low capitalization rate at retail pricing, while remitting a substantial portion of the Purchase Price to the Seller as an immediate down payment. Concurrently, by structuring the balance as an installment sale with seller financing, the Seller can defer and potentially minimize immediate tax liabilities. The Seller, thus, secures an aggressive purchase price, a significant down payment, and the potential for a reduced overall tax burden.</p>

            <div class="loi-steps-box">
                <h3>Step 1  Seller Agrees to Sell Property</h3>
                <ul>
                    <li>Property Price: <strong id="loi-step1-price"></strong></li>
                    <li>Seller hands over the property in <strong>as-is</strong> condition.</li>
                </ul>

                <h3>Step 2  Stage 1: Cash Closing</h3>
                <ul>
                    <li>Buyer brings <strong id="loi-step2-cash"></strong> cash to closing.</li>
                    <li>Escrow holds funds temporarily.</li>
                    <li>Title transfers  Buyer's LLC now owns the property.</li>
                    <li>Seller gets their immediate cash payout: <strong id="loi-step2-payout"></strong>.</li>
                </ul>

                <h3>Step 3  Stage 2: Equity Carry Agreement</h3>
                <ul>
                    <li>The remaining <strong id="loi-step3-remaining"></strong> is not paid out in cash.</li>
                    <li>Instead, it becomes the Seller's <strong>Equity Carry (preferred equity)</strong> inside Buyer's LLC.</li>
                </ul>

                <h3>Step 4  Seller's Equity Terms</h3>
                <ul>
                    <li>Treated like a <strong>secured loan inside the new LLC</strong>.</li>
                    <li>Monthly payment: <strong id="loi-step4-payment"></strong> (principal only).</li>
                    <li>Balloon: <strong id="loi-step4-balloon"></strong> years.</li>
                    <li>If Buyer defaults  Seller can <strong>take back 100% of the LLC</strong> (full ownership of property) without foreclosure.</li>
                </ul>

                <h3>Step 5  Seller's Benefits</h3>
                <ul class="loi-benefits">
                    <li> Immediate cash at close (<strong id="loi-step5-cash"></strong>)</li>
                    <li> Ongoing monthly payments (<strong id="loi-step5-payment"></strong>)</li>
                    <li> Secured "back door" ownership protection</li>
                    <li> Tax-advantaged structure (installment sale)</li>
                </ul>
            </div>

            <p>In accordance with guidance set forth by the Internal Revenue Service (IRS) for installment sales (see, e.g., IRS Publication 537), "income received over time through an installment sale may, under certain circumstances, be treated as ordinary income." This approach allows for the recognition of gains and the associated tax obligations to be spread over multiple tax years, rather than realized in a single lump sum, potentially resulting in a more favorable tax outcome.</p>

            <p>Additionally, the buyer will cover all title insurance premiums, all customary closing costs, fees, and related expenses. This allocation ensures the Seller realizes the full benefit of the agreed-upon financial terms without incurring out-of-pocket transactional costs.</p>

            <p>This LOI is provided solely as an outline and for the purpose of facilitating further discussion. Except as may be otherwise agreed in writing (such as confidentiality or exclusivity provisions), this LOI is non-binding. Neither Party shall be legally obligated to proceed unless and until both Parties execute a definitive State-approved PSA and related ancillary documents that fully memorialize the terms and conditions of the transaction.</p>

            <h3><u>Seller Protection Clause</u></h3>
            <p style="text-align: center;"><strong>Operating Agreement with Default Control Provisions</strong></p>
            <ul>
                <li><strong>Instead of holding a second-position lien, the Seller and Buyer will enter into an LLC operating agreement (or land trust with an assignment of beneficial interest) where the Seller maintains certain minority equity interest.</strong></li>
                <li><strong>The LLC or trust holds title to the property, and the Buyer operates as the primary manager/member.</strong></li>
                <li><strong>The agreement includes a clause that allows the Seller to regain full control of the LLC or trust (and thus the property) if the Buyer defaults on their financial obligations (missed payments, failure to insure, etc.).</strong></li>
            </ul>

            <p><u>Commissions:</u> 2.5% to Buyer's Agent, Steven Glaude, LPT Realty, Lic #01257750.</p>

            <p><u>Deposit:</u> EMD is 1% of purchase price, deposited after inspection period.</p>

            <p><u>Inspection Period:</u> Buyer shall have a maximum of thirty (30) business days following execution of the PSA to complete all due diligence, including inspections, title review, and feasibility studies. The inspection period only begins after the buyer receives all financials relevant to the business operation. The buyer is prepared to accelerate this if feasible. The Earnest Money Deposit goes hard at 1% after the inspection contingency period.</p>

            <p><strong>Provision of Financial and Operational Documentation:</strong> The Seller agrees to furnish the Buyer, within a specified due diligence period, with complete and accurate financial and operational records relating to the Property. Such records shall include, but are not limited to:</p>
            <ul class="loi-docs-list">
                <li><strong>Trailing Twelve (T12) Months Operating Statements:</strong> Detailed income and expense reports for the previous twelve (12) months.</li>
                <li><strong>Rent Roll and Leases:</strong> Current rent roll listing all tenants, rental amounts, security deposits, lease start and end dates, and any tenant concessions. Copies of all existing tenant leases, amendments, and related agreements (including any side letters or guaranties) shall be provided.</li>
                <li><strong>Service and Vendor Contracts:</strong> Copies of all service agreements, property management contracts, warranties, guaranties, or other third-party obligations that the Buyer would assume or be subject to post-closing.</li>
                <li><strong>Utility and Maintenance Records:</strong> Historical utility bills, maintenance logs, capital expenditure records, and warranty information for major systems (HVAC, roof, mechanicals, elevators, if applicable).</li>
                <li><strong>Insurance and Claims History:</strong> Certificates of insurance, loss runs, and any claims history that may impact future insurance premiums or coverage availability.</li>
                <li><strong>Tax and Assessment Information:</strong> Most recent property tax statements, assessments, and notices of any special assessments or pending reassessments.</li>
                <li><strong>Permits and Licenses:</strong> Copies of all governmental permits, licenses, or approvals necessary for the current operation of the Property, including any evidence of compliance with zoning, building codes, fire and life safety regulations, and other applicable laws.</li>
            </ul>

            <p><u>Closing Date:</u> Closing to occur within <strong>forty-five (45) to sixty (60) days</strong> or sooner following full execution of the Agreement. The buyer is positioned to close earlier if conditions permit. A one-time extension of 15 days may be granted upon mutual agreement.</p>

            <p><u>Closing Costs:</u> Buyer will assume all standard closing costs, including escrow fees, title insurance premiums, recording fees, transfer taxes, and other customary expenses, thereby ensuring a streamlined closing process for Seller. Commitment to Transaction: Buyer is a capable and well-capitalized purchaser, seeking a straightforward and expeditious transaction. The terms outlined above are designed to provide Seller with a clean, competitive, and dependable closing, minimizing risk and delay.</p>

            <h3>Contingencies to Closing:</h3>
            <p>a. Property Inspections: Buyer shall inspect all buildings, grounds, utilities and clean environmental.</p>
            <p>b. Lending, Appraisal, and Financing.</p>
            <p>c. Review documentation and verify title, check for delinquent utilities, and review current payment statements.</p>

            <h3>Conditions:</h3>
            <p>The execution of an Agreement of Sale shall be conditioned on the satisfaction of the above terms and contingencies. Both Purchaser and Seller acknowledge that this Letter of Intent is not a purchase contract but serves as the foundation for drafting a formal purchase contract between the parties. No legal obligations or liabilities shall arise from this Letter of Intent.</p>

            <p><strong>Instant Hotels, Inc.</strong>, makes no warranty or representation to Seller or Purchaser that the acceptance of this Letter of Intent guarantees the execution of a purchase contract.</p>

            <p>This Letter of Intent is valid until <strong>5:00 PM</strong> on <strong id="loi-expiry-date"></strong>. If an executed copy of this letter is not received by that date, this Letter of Intent will be considered withdrawn.</p>

            <p>We look forward to further discussions and negotiations to reach a mutually beneficial agreement. Please do not hesitate to contact us to initiate the next steps in this process.</p>

            <p>Sincerely,</p>

            <div class="loi-signature-section">
                <div class="loi-sig-left">
                    <p><strong id="loi-sig-name"></strong></p>
                    <p>Acquisitions Manager,</p>
                    <p>Instant Hotels, Inc</p>
                    <p id="loi-sig-email"></p>
                    <p id="loi-sig-phone"></p>
                    <br>
                    <p><strong>Steven P. Glaude</strong></p>
                    <p><em>President</em></p>
                    <p>Realtor ~ Investor</p>
                    <p>CalBRE #01257750</p>
                    <p>Tel. No. (916) 316-4472</p>
                    <p><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="d8abacbdaebdb698bdb9aba1b9a8b9aaacb5bdb6acabbaada1bdaaf6bbb7b5">[email&#160;protected]</a></p>
                    <p>www.stevenglaude.com</p>
                    <p>https://equitycarrygroup.com/</p>
                </div>
            </div>

            <div class="loi-acceptance">
                <div class="loi-signature-row">
                    <div class="loi-sig-date">
                        <span id="loi-accept-date"></span>
                    </div>
                    <div class="loi-sig-content">
                        <p class="loi-sig-by">By: <span class="steven-signature">Steven Glaude</span></p>
                        <p class="loi-sig-label">Buyer: Instant Hotels, Inc.</p>
                    </div>
                </div>

                <h3 class="loi-accept-title">ACCEPTANCE THIS DATE:</h3>
                
                <div class="loi-signature-row">
                    <div class="loi-sig-date">
                        <span class="loi-blank-line">_____________________</span>
                    </div>
                    <div class="loi-sig-content">
                        <p class="loi-sig-by">By: _________________________________</p>
                        <p class="loi-sig-label"><strong>Seller:</strong> <span id="loi-seller-sig-name"></span></p>
                        <p class="loi-sig-detail" id="loi-seller-sig-email"></p>
                        <p class="loi-sig-detail" id="loi-seller-sig-phone"></p>
                    </div>
                </div>
            </div>
